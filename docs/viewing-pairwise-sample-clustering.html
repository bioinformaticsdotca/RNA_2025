<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Viewing pairwise sample clustering | RNA-seq Analysis 2025</title>
  <meta name="description" content="Workshop website for the 2025 RNA-seq Analysis Canadian Bioinformatics Workshop" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Viewing pairwise sample clustering | RNA-seq Analysis 2025" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://bioinformaticsdotca.github.io/RNA_2025/img/bioinformatics_logo.png" />
  <meta property="og:description" content="Workshop website for the 2025 RNA-seq Analysis Canadian Bioinformatics Workshop" />
  <meta name="github-repo" content="bioinformaticsdotca/RNA_2025" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Viewing pairwise sample clustering | RNA-seq Analysis 2025" />
  
  <meta name="twitter:description" content="Workshop website for the 2025 RNA-seq Analysis Canadian Bioinformatics Workshop" />
  <meta name="twitter:image" content="https://bioinformaticsdotca.github.io/RNA_2025/img/bioinformatics_logo.png" />

<meta name="author" content="Faculty: Malachi Griffith and Obi Griffith" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="prev" href="module-3.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<a href="https://bioinformaticsdotca.github.io/">
 <img src="img/bioinformatics_logo.png" width="90%" alt="bioinformatics.ca logo" style="display:block; margin-left:auto; margin-right:auto; margin-top:15px;">
 </a>
<li><center><strong><a href="./"><br>RNA-Seq Analysis<br><br></a></strong></center></li>
<a href="./">
 <img src="img/CBW_RNA_Icon.png" width="70%" alt="WORKSHOP NAME logo" style="display:block; margin-left:auto; margin-right:auto; ">
 </a>
<br>

<li class="divider"></li>
<li class="part"><span><b>I Introduction</b></span></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Workshop Info</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#schedule"><i class="fa fa-check"></i>Schedule</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#pre-work"><i class="fa fa-check"></i>Pre-work</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="meet-your-faculty.html"><a href="meet-your-faculty.html"><i class="fa fa-check"></i>Meet Your Faculty</a></li>
<li class="part"><span><b>II Modules</b></span></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html"><i class="fa fa-check"></i>Module 0: Introductions and Environment Setup</a>
<ul>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#lecture"><i class="fa fa-check"></i>Lecture</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#environment-setup"><i class="fa fa-check"></i>Environment Setup</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#tool-installation"><i class="fa fa-check"></i>Tool Installation</a>
<ul>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#note"><i class="fa fa-check"></i>Note</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#samtools"><i class="fa fa-check"></i>SAMtools</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#bam-readcount"><i class="fa fa-check"></i>bam-readcount</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#hisat2"><i class="fa fa-check"></i>HISAT2</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#stringtie"><i class="fa fa-check"></i>StringTie</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#gffcompare"><i class="fa fa-check"></i>gffcompare</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#htseq-count"><i class="fa fa-check"></i>htseq-count</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#tophat"><i class="fa fa-check"></i>TopHat</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#kallisto"><i class="fa fa-check"></i>kallisto</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#fastqc"><i class="fa fa-check"></i>FastQC</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#fastp"><i class="fa fa-check"></i>Fastp</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#multiqc"><i class="fa fa-check"></i>MultiQC</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#picard"><i class="fa fa-check"></i>Picard</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#regtools"><i class="fa fa-check"></i>RegTools</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#rseqc"><i class="fa fa-check"></i>RSeQC</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#bedops"><i class="fa fa-check"></i>bedops</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#gtftogenepred"><i class="fa fa-check"></i>gtfToGenePred</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#genepredtobed"><i class="fa fa-check"></i>genePredToBed</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#how_are_we_stranded_here"><i class="fa fa-check"></i>how_are_we_stranded_here</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#install-cell-ranger"><i class="fa fa-check"></i>Install Cell Ranger</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#install-r"><i class="fa fa-check"></i>Install R</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#r-libraries"><i class="fa fa-check"></i>R Libraries</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#bioconductor"><i class="fa fa-check"></i>Bioconductor</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#sleuth"><i class="fa fa-check"></i>Sleuth</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#practical-exercise-1---software-installation"><i class="fa fa-check"></i>PRACTICAL EXERCISE 1 - Software Installation</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#add-locally-installed-tools-to-your-path-optional"><i class="fa fa-check"></i>Add locally installed tools to your PATH [OPTIONAL]</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#installing-tools-from-official-ubuntu-packages-optional"><i class="fa fa-check"></i>Installing tools from official ubuntu packages [OPTIONAL]</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#installing-tools-by-docker-image"><i class="fa fa-check"></i>Installing tools by Docker image</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#installing-tools-by-docker-image-using-singularity"><i class="fa fa-check"></i>Installing tools by Docker image (using Singularity)</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#lecture-1"><i class="fa fa-check"></i>Lecture</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#labs"><i class="fa fa-check"></i>Labs</a>
<ul>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#module-1---key-concepts"><i class="fa fa-check"></i>Module 1 - Key concepts</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#module-1---learning-objectives"><i class="fa fa-check"></i>Module 1 - Learning objectives</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#lecture-2"><i class="fa fa-check"></i>Lecture</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#fastafastqgtf-mini-lecture"><i class="fa fa-check"></i>FASTA/FASTQ/GTF mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#obtain-a-reference-genome-from-ensembl-igenomes-ncbi-or-ucsc."><i class="fa fa-check"></i>Obtain a reference genome from Ensembl, iGenomes, NCBI or UCSC.</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#note-on-complex-commands-and-scripting-in-unix"><i class="fa fa-check"></i>Note on complex commands and scripting in Unix</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#practical-exercise-2-advanced"><i class="fa fa-check"></i>PRACTICAL EXERCISE 2 (ADVANCED)</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#fastafastqgtf-mini-lecture-1"><i class="fa fa-check"></i>FASTA/FASTQ/GTF mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#obtain-known-genetranscript-annotations"><i class="fa fa-check"></i>Obtain Known Gene/Transcript Annotations</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#definitions"><i class="fa fa-check"></i>Definitions:</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#the-purpose-of-gene-annotations-.gtf-file"><i class="fa fa-check"></i>The Purpose of Gene Annotations (.gtf file)</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#sources-for-obtaining-gene-annotation-files-formatted-for-hisat2stringtieballgown"><i class="fa fa-check"></i>Sources for obtaining gene annotation files formatted for HISAT2/StringTie/Ballgown</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#important-notes"><i class="fa fa-check"></i>Important notes:</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#indexing-mini-lecture"><i class="fa fa-check"></i>Indexing mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#create-a-hisat2-index"><i class="fa fa-check"></i>Create a HISAT2 index</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#obtain-rna-seq-test-data."><i class="fa fa-check"></i>Obtain RNA-seq test data.</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#determining-the-strandedness-of-rna-seq-data-optional"><i class="fa fa-check"></i>Determining the strandedness of RNA-seq data (Optional)</a></li>
<li class="chapter" data-level="" data-path="module-0-introductions-and-environment-setup.html"><a href="module-0-introductions-and-environment-setup.html#practical-exercise-3"><i class="fa fa-check"></i>PRACTICAL EXERCISE 3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html"><i class="fa fa-check"></i>Module 2</a>
<ul>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#lecture-3"><i class="fa fa-check"></i>Lecture</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#labs-1"><i class="fa fa-check"></i>Labs</a>
<ul>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#module-2---key-concepts"><i class="fa fa-check"></i>Module 2 - Key concepts</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#module-2---learning-objectives"><i class="fa fa-check"></i>Module 2 - Learning objectives</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#lectures"><i class="fa fa-check"></i>Lectures</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#read-trimming-with-fastp"><i class="fa fa-check"></i>Read trimming with Fastp</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#use-fastqc-and-multiqc-to-compare-the-impact-of-trimming"><i class="fa fa-check"></i>Use FastQC and multiqc to compare the impact of trimming</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#clean-up"><i class="fa fa-check"></i>Clean up</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#practical-exercise-5"><i class="fa fa-check"></i>PRACTICAL EXERCISE 5</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#alignment-mini-lecture"><i class="fa fa-check"></i>Alignment mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#hisat2-alignment"><i class="fa fa-check"></i>HISAT2 alignment</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#merge-hisat2-bam-files"><i class="fa fa-check"></i>Merge HISAT2 BAM files</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#practical-exercise-6"><i class="fa fa-check"></i>PRACTICAL EXERCISE 6</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#introduction"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#visualization-part-1-getting-familiar-with-igv"><i class="fa fa-check"></i>Visualization Part 1: Getting familiar with IGV</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#visualization-part-2-inspecting-snps-snvs-and-svs"><i class="fa fa-check"></i>Visualization Part 2: Inspecting SNPs, SNVs, and SVs</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#visualization-part-3-automating-tasks-in-igv"><i class="fa fa-check"></i>Visualization Part 3: Automating Tasks in IGV</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#indexing-bam-files-with-samtools"><i class="fa fa-check"></i>Indexing BAM files with samtools</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#visualize-alignments-with-igv"><i class="fa fa-check"></i>Visualize alignments with IGV</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#practical-exercise-7"><i class="fa fa-check"></i>PRACTICAL EXERCISE 7</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#bam-read-counting"><i class="fa fa-check"></i>BAM Read Counting</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#practical-exercise-7-1"><i class="fa fa-check"></i>PRACTICAL EXERCISE 7</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#alignment-qc-mini-lecture"><i class="fa fa-check"></i>Alignment QC mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#use-samtools-and-fastqc-to-evaluate-the-alignments"><i class="fa fa-check"></i>Use samtools and FastQC to evaluate the alignments</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#create-versions-of-our-bam-files-with-only-the-chromosome-22-alignments"><i class="fa fa-check"></i>Create versions of our BAM files with only the chromosome 22 alignments</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#using-fastqc"><i class="fa fa-check"></i>Using FastQC</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#using-picard"><i class="fa fa-check"></i>Using Picard</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#rseqc-optional"><i class="fa fa-check"></i>RSeQC [optional]</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#multiqc-1"><i class="fa fa-check"></i>MultiQC</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#view-a-pre-generated-multiqc-report-for-full-bam-files"><i class="fa fa-check"></i>View a pre-generated MultiQC report for full bam files</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#part-i---obtaining-the-dataset-reference-files"><i class="fa fa-check"></i>Part I - Obtaining the dataset &amp; reference files</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#part-ii---data-preprocessing-qc-trimming"><i class="fa fa-check"></i>Part II - Data Preprocessing (QC &amp; Trimming)</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#part-iii---alignment"><i class="fa fa-check"></i>Part III - Alignment</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#part-iv---post-alignment-qc-igv-visualization"><i class="fa fa-check"></i>Part IV - Post-alignment QC &amp; IGV Visualization</a></li>
<li class="chapter" data-level="" data-path="module-2.html"><a href="module-2.html#presenting-your-results"><i class="fa fa-check"></i>Presenting Your Results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html"><i class="fa fa-check"></i>Module 3</a>
<ul>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#labs-2"><i class="fa fa-check"></i>Labs</a>
<ul>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#module-3---key-concepts"><i class="fa fa-check"></i>Module 3 - Key concepts</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#module-3---learning-objectives"><i class="fa fa-check"></i>Module 3 - Learning objectives</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#lectures-1"><i class="fa fa-check"></i>Lectures</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#expression-mini-lecture"><i class="fa fa-check"></i>Expression mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#use-stringtie-to-generate-expression-estimates-from-the-sambam-files-generated-by-hisat2-in-the-previous-module"><i class="fa fa-check"></i>Use Stringtie to generate expression estimates from the SAM/BAM files generated by HISAT2 in the previous module</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#practical-exercise-8"><i class="fa fa-check"></i>PRACTICAL EXERCISE 8</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#differential-expression-mini-lecture"><i class="fa fa-check"></i>Differential Expression mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#ballgown-de-analysis"><i class="fa fa-check"></i>Ballgown DE Analysis</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#practical-exercise-9"><i class="fa fa-check"></i>PRACTICAL EXERCISE 9</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#ercc-de-analysis"><i class="fa fa-check"></i>ERCC DE Analysis</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#differential-expression-mini-lecture-1"><i class="fa fa-check"></i>Differential Expression mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#edger-de-analysis"><i class="fa fa-check"></i>edgeR DE Analysis</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#differential-expression-mini-lecture-2"><i class="fa fa-check"></i>Differential Expression mini lecture</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#deseq2-de-analysis"><i class="fa fa-check"></i>DESeq2 DE Analysis</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#setup"><i class="fa fa-check"></i>Setup</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#format-htseq-counts-data-to-work-with-deseq2"><i class="fa fa-check"></i>Format htseq counts data to work with DESeq2</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#filter-raw-counts"><i class="fa fa-check"></i>Filter raw counts</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#specifying-the-experimental-design"><i class="fa fa-check"></i>Specifying the experimental design</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#construct-the-deseq2-object-piecing-all-the-data-together"><i class="fa fa-check"></i>Construct the DESeq2 object piecing all the data together</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#running-deseq2"><i class="fa fa-check"></i>Running DESeq2</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#log-fold-change-shrinkage"><i class="fa fa-check"></i>Log-fold change shrinkage</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#annotate-gene-symbols-onto-the-de-results"><i class="fa fa-check"></i>Annotate gene symbols onto the DE results</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#data-manipulation"><i class="fa fa-check"></i>Data manipulation</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#save-results-to-files"><i class="fa fa-check"></i>Save results to files</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#briefly-examine-the-top-over-expressed-genes"><i class="fa fa-check"></i>Briefly examine the top over-expressed genes</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#perform-some-preliminary-exploration-of-de-genes-using-webtools"><i class="fa fa-check"></i>Perform some preliminary exploration of DE genes using webtools</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#visualize-overlap-with-a-venn-diagram.-this-can-be-done-with-simple-web-tools-like"><i class="fa fa-check"></i>Visualize overlap with a venn diagram. This can be done with simple web tools like:</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#ballgown-de-visualization"><i class="fa fa-check"></i>Ballgown DE Visualization</a></li>
<li class="chapter" data-level="" data-path="module-3.html"><a href="module-3.html#differential-expression-visualization"><i class="fa fa-check"></i>Differential Expression Visualization</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html"><i class="fa fa-check"></i>Viewing pairwise sample clustering</a>
<ul>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#supplementary-r-de-visualization"><i class="fa fa-check"></i>Supplementary R DE Visualization</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#visual-comparison-of-example-genes-from-the-volcano-plot"><i class="fa fa-check"></i>Visual comparison of example genes from the volcano plot</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#practical-exercise-10-advanced"><i class="fa fa-check"></i>PRACTICAL EXERCISE 10 (ADVANCED)</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#what-is-gage"><i class="fa fa-check"></i>What is gage?</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#importing-de-results-for-gage"><i class="fa fa-check"></i>Importing DE results for gage</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#setting-up-gene-set-databases"><i class="fa fa-check"></i>Setting up gene set databases</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#annotating-genes"><i class="fa fa-check"></i>Annotating genes</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#some-clean-up-and-identifier-mapping"><i class="fa fa-check"></i>Some clean-up and identifier mapping</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#final-preparation-of-deseq2-results-for-gage"><i class="fa fa-check"></i>Final preparation of DESeq2 results for gage</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#running-pathway-analysis"><i class="fa fa-check"></i>Running pathway analysis</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#explore-significant-results"><i class="fa fa-check"></i>Explore significant results</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#more-exploration"><i class="fa fa-check"></i>More exploration</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#visualize"><i class="fa fa-check"></i>Visualize</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#alternative-pathway-analysis-tools-and-strategies"><i class="fa fa-check"></i>Alternative Pathway analysis tools and strategies!</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#download-and-prepare-some-test-data-where-some-batch-effects-are-expected"><i class="fa fa-check"></i>Download and prepare some test data where some batch effects are expected</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#introduction-to-batch-correction"><i class="fa fa-check"></i>Introduction to batch correction</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#introduction-to-this-demonstration-of-a-batch-correction-approach"><i class="fa fa-check"></i>Introduction to this demonstration of a batch correction approach</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#samples-abbreviations-used-in-the-following-analysis"><i class="fa fa-check"></i>Samples abbreviations used in the following analysis</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#perform-principal-component-analysis-pca-on-the-uncorrected-counts"><i class="fa fa-check"></i>Perform principal component analysis (PCA) on the uncorrected counts</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#introduction-to-bioconductor-sva-and-combat-seq-in-r"><i class="fa fa-check"></i>Introduction to Bioconductor SVA and ComBat-Seq in R</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#demonstration-of-combat-seq-on-the-uhrhbr-data-with-two-library-types-ribopoly"><i class="fa fa-check"></i>Demonstration of ComBat-Seq on the UHR/HBR data with two library types (Ribo/Poly)</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#perform-pca-analysis-on-the-batch-corrected-data-and-contrast-with-the-uncorrected-data"><i class="fa fa-check"></i>Perform PCA analysis on the batch corrected data and contrast with the uncorrected data</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#perform-differential-expression-analysis-of-the-corrected-and-uncorrected-data"><i class="fa fa-check"></i>Perform differential expression analysis of the corrected and uncorrected data</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-i---expression-estimation"><i class="fa fa-check"></i>Part I - Expression Estimation</a>
<ul>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#remember-to-do-this-in-a-new-directory-under-team_exercises"><i class="fa fa-check"></i>Remember to do this in a new directory under team_exercises</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-ii---differential-expression"><i class="fa fa-check"></i>Part II - Differential Expression</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#presenting-your-results-1"><i class="fa fa-check"></i>Presenting Your Results</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-0-obtaining-data-and-references"><i class="fa fa-check"></i>PART 0 : Obtaining Data and References</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-1-data-preprocessing"><i class="fa fa-check"></i>Part 1 : Data preprocessing</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-2-data-alignment"><i class="fa fa-check"></i>Part 2: Data alignment</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-3-expression-estimation"><i class="fa fa-check"></i>Part 3: Expression Estimation</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-4-differential-expression-analysis"><i class="fa fa-check"></i>Part 4: Differential Expression Analysis</a></li>
<li class="chapter" data-level="" data-path="viewing-pairwise-sample-clustering.html"><a href="viewing-pairwise-sample-clustering.html#part-5-differential-expression-analysis-visualization"><i class="fa fa-check"></i>Part 5: Differential Expression Analysis Visualization</a></li>
</ul></li>
<li class="divider"></li>
<h1 id="sponsors">Sponsors</h1>
<center>
<a href="https://www.cihr-irsc.gc.ca"><img src="img/sponsors/cihr.png" width=90% style="padding-bottom: 20px" alt="Canadian Institutes of Health Research logo."></a>

<a href="https://genomecanada.ca/"><img src="img/sponsors/genomecanada.png" height="70" style="display:inline-block;"  style="padding-bottom: 20px" alt="Genome Canada logo.">
<a href="https://www.ontariogenomics.ca/"><img src="img/sponsors/ontariogenomics.png" height="70" style="display:inline-block;" style="padding-bottom: 20px;" alt="Ontario Genomics logo.">
<br><br>
<a href="https://oicr.on.ca/"><img src="img/sponsors/oicr.png" width=25% style="display:inline-block;" style="padding-bottom: 20px" alt="Ontario Institute for Cancer Research logo.">
<a href="https://www.hpcforhealth.ca/"><img src="img/sponsors/hpc4health.png" width=60% style="display:inline-block;" style="padding-bottom: 20px "alt="HPC4Health logo.">

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">RNA-seq Analysis 2025</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="viewing-pairwise-sample-clustering" class="section level1 hasAnchor">
<h1>Viewing pairwise sample clustering<a href="viewing-pairwise-sample-clustering.html#viewing-pairwise-sample-clustering" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>It may often be useful to view inter-sample relatedness. In other words, how similar or disimilar samples are to one another overall. While not part of the DESeq2 package, there is a convenient library that can easily construct a hierarchically clustered heatmap from our DESeq2 data. It should be noted that when doing a distance calculation using “raw count” data is not ideal, the count data should be transformed using <code>vst()</code> or <code>rlog()</code> which can be performed directly on the dds object. The reason for this is described in detail in the DESeq2 manuscript, suffice it to say that transforming gene variance to be more homoskedastic will make inferences of sample relatedness more interpretable.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="viewing-pairwise-sample-clustering.html#cb61-1" tabindex="-1"></a><span class="co"># note that we use rlog because we don&#39;t have a large number of genes, for a typical DE experiment with 1000&#39;s of genes use the vst() function</span></span>
<span id="cb61-2"><a href="viewing-pairwise-sample-clustering.html#cb61-2" tabindex="-1"></a>rld <span class="ot">&lt;-</span> <span class="fu">rlog</span>(dds, <span class="at">blind =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-3"><a href="viewing-pairwise-sample-clustering.html#cb61-3" tabindex="-1"></a></span>
<span id="cb61-4"><a href="viewing-pairwise-sample-clustering.html#cb61-4" tabindex="-1"></a><span class="co"># view the structure of this object</span></span>
<span id="cb61-5"><a href="viewing-pairwise-sample-clustering.html#cb61-5" tabindex="-1"></a>rld</span>
<span id="cb61-6"><a href="viewing-pairwise-sample-clustering.html#cb61-6" tabindex="-1"></a></span>
<span id="cb61-7"><a href="viewing-pairwise-sample-clustering.html#cb61-7" tabindex="-1"></a><span class="co"># compute sample distances (the dist function uses the euclidean distance metric by default)</span></span>
<span id="cb61-8"><a href="viewing-pairwise-sample-clustering.html#cb61-8" tabindex="-1"></a><span class="co"># in this command we will pull the rlog transformed data (&quot;regularized&quot; log2 transformed, see ?rlog for details) using &quot;assay&quot;</span></span>
<span id="cb61-9"><a href="viewing-pairwise-sample-clustering.html#cb61-9" tabindex="-1"></a><span class="co"># then we transpose that data using t()</span></span>
<span id="cb61-10"><a href="viewing-pairwise-sample-clustering.html#cb61-10" tabindex="-1"></a><span class="co"># then we calculate distance values using dist() </span></span>
<span id="cb61-11"><a href="viewing-pairwise-sample-clustering.html#cb61-11" tabindex="-1"></a><span class="co"># the distance is calculated for each vector of sample gene values, in a pairwise fashion comparing all samples</span></span>
<span id="cb61-12"><a href="viewing-pairwise-sample-clustering.html#cb61-12" tabindex="-1"></a></span>
<span id="cb61-13"><a href="viewing-pairwise-sample-clustering.html#cb61-13" tabindex="-1"></a><span class="co"># view the first few lines of raw data</span></span>
<span id="cb61-14"><a href="viewing-pairwise-sample-clustering.html#cb61-14" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">assay</span>(dds))</span>
<span id="cb61-15"><a href="viewing-pairwise-sample-clustering.html#cb61-15" tabindex="-1"></a></span>
<span id="cb61-16"><a href="viewing-pairwise-sample-clustering.html#cb61-16" tabindex="-1"></a><span class="co"># see the rlog transformed data</span></span>
<span id="cb61-17"><a href="viewing-pairwise-sample-clustering.html#cb61-17" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">assay</span>(rld))</span>
<span id="cb61-18"><a href="viewing-pairwise-sample-clustering.html#cb61-18" tabindex="-1"></a></span>
<span id="cb61-19"><a href="viewing-pairwise-sample-clustering.html#cb61-19" tabindex="-1"></a><span class="co"># see the impact of transposing the matrix</span></span>
<span id="cb61-20"><a href="viewing-pairwise-sample-clustering.html#cb61-20" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">assay</span>(rld))[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb61-21"><a href="viewing-pairwise-sample-clustering.html#cb61-21" tabindex="-1"></a></span>
<span id="cb61-22"><a href="viewing-pairwise-sample-clustering.html#cb61-22" tabindex="-1"></a><span class="co"># see the distance values</span></span>
<span id="cb61-23"><a href="viewing-pairwise-sample-clustering.html#cb61-23" tabindex="-1"></a><span class="fu">dist</span>(<span class="fu">t</span>(<span class="fu">assay</span>(rld)))</span>
<span id="cb61-24"><a href="viewing-pairwise-sample-clustering.html#cb61-24" tabindex="-1"></a></span>
<span id="cb61-25"><a href="viewing-pairwise-sample-clustering.html#cb61-25" tabindex="-1"></a><span class="co"># put it all together and store the result</span></span>
<span id="cb61-26"><a href="viewing-pairwise-sample-clustering.html#cb61-26" tabindex="-1"></a>sampleDists <span class="ot">&lt;-</span> <span class="fu">dist</span>(<span class="fu">t</span>(<span class="fu">assay</span>(rld)))</span>
<span id="cb61-27"><a href="viewing-pairwise-sample-clustering.html#cb61-27" tabindex="-1"></a></span>
<span id="cb61-28"><a href="viewing-pairwise-sample-clustering.html#cb61-28" tabindex="-1"></a><span class="co"># convert the distance result to a matrix</span></span>
<span id="cb61-29"><a href="viewing-pairwise-sample-clustering.html#cb61-29" tabindex="-1"></a>sampleDistMatrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(sampleDists)</span>
<span id="cb61-30"><a href="viewing-pairwise-sample-clustering.html#cb61-30" tabindex="-1"></a></span>
<span id="cb61-31"><a href="viewing-pairwise-sample-clustering.html#cb61-31" tabindex="-1"></a><span class="co"># view the distance numbers directly in the pairwise distance matrix</span></span>
<span id="cb61-32"><a href="viewing-pairwise-sample-clustering.html#cb61-32" tabindex="-1"></a><span class="fu">head</span>(sampleDistMatrix)</span>
<span id="cb61-33"><a href="viewing-pairwise-sample-clustering.html#cb61-33" tabindex="-1"></a></span>
<span id="cb61-34"><a href="viewing-pairwise-sample-clustering.html#cb61-34" tabindex="-1"></a><span class="fu">pdf</span>(<span class="st">&quot;distance_sample_heatmap.pdf&quot;</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">8</span>)</span>
<span id="cb61-35"><a href="viewing-pairwise-sample-clustering.html#cb61-35" tabindex="-1"></a></span>
<span id="cb61-36"><a href="viewing-pairwise-sample-clustering.html#cb61-36" tabindex="-1"></a><span class="co"># construct clustered heatmap, important to use the computed sample distances for clustering</span></span>
<span id="cb61-37"><a href="viewing-pairwise-sample-clustering.html#cb61-37" tabindex="-1"></a><span class="fu">pheatmap</span>(sampleDistMatrix, <span class="at">clustering_distance_rows =</span> sampleDists, <span class="at">clustering_distance_cols =</span> sampleDists)</span>
<span id="cb61-38"><a href="viewing-pairwise-sample-clustering.html#cb61-38" tabindex="-1"></a></span>
<span id="cb61-39"><a href="viewing-pairwise-sample-clustering.html#cb61-39" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
<p>Instead of a distance metric we could also use a similarity metric such as a Peason correlation</p>
<p>There are many correlation and distance options:</p>
<p>Correlation: “pearson”, “kendall”, “spearman”
Distance: “euclidean”, “maximum”, “manhattan”, “canberra”, “binary” or “minkowski”</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="viewing-pairwise-sample-clustering.html#cb62-1" tabindex="-1"></a>sampleCorrs <span class="ot">=</span> <span class="fu">cor</span>(<span class="fu">assay</span>(rld), <span class="at">method =</span> <span class="st">&quot;pearson&quot;</span>)</span>
<span id="cb62-2"><a href="viewing-pairwise-sample-clustering.html#cb62-2" tabindex="-1"></a>sampleCorrMatrix <span class="ot">=</span> <span class="fu">as.matrix</span>(sampleCorrs)</span>
<span id="cb62-3"><a href="viewing-pairwise-sample-clustering.html#cb62-3" tabindex="-1"></a><span class="fu">head</span>(sampleCorrMatrix)</span>
<span id="cb62-4"><a href="viewing-pairwise-sample-clustering.html#cb62-4" tabindex="-1"></a></span>
<span id="cb62-5"><a href="viewing-pairwise-sample-clustering.html#cb62-5" tabindex="-1"></a><span class="fu">pdf</span>(<span class="st">&quot;similarity_sample_heatmap.pdf&quot;</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">8</span>)</span>
<span id="cb62-6"><a href="viewing-pairwise-sample-clustering.html#cb62-6" tabindex="-1"></a></span>
<span id="cb62-7"><a href="viewing-pairwise-sample-clustering.html#cb62-7" tabindex="-1"></a><span class="fu">pheatmap</span>(sampleCorrMatrix)</span>
<span id="cb62-8"><a href="viewing-pairwise-sample-clustering.html#cb62-8" tabindex="-1"></a></span>
<span id="cb62-9"><a href="viewing-pairwise-sample-clustering.html#cb62-9" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
<p>Instead of boiling all the gene count data for each sample down to a distance metric you can
get a similar sense of the pattern by just visualizing all the genes at once</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="viewing-pairwise-sample-clustering.html#cb63-1" tabindex="-1"></a></span>
<span id="cb63-2"><a href="viewing-pairwise-sample-clustering.html#cb63-2" tabindex="-1"></a><span class="fu">pdf</span>(<span class="st">&quot;all_gene_heatmap.pdf&quot;</span>, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">10</span>)</span>
<span id="cb63-3"><a href="viewing-pairwise-sample-clustering.html#cb63-3" tabindex="-1"></a></span>
<span id="cb63-4"><a href="viewing-pairwise-sample-clustering.html#cb63-4" tabindex="-1"></a><span class="co"># because there are so many gene we choose not to display them</span></span>
<span id="cb63-5"><a href="viewing-pairwise-sample-clustering.html#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="viewing-pairwise-sample-clustering.html#cb63-6" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="at">mat =</span> <span class="fu">t</span>(<span class="fu">assay</span>(rld)), <span class="at">show_colnames =</span> <span class="cn">FALSE</span>)</span>
<span id="cb63-7"><a href="viewing-pairwise-sample-clustering.html#cb63-7" tabindex="-1"></a></span>
<span id="cb63-8"><a href="viewing-pairwise-sample-clustering.html#cb63-8" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb63-9"><a href="viewing-pairwise-sample-clustering.html#cb63-9" tabindex="-1"></a></span>
<span id="cb63-10"><a href="viewing-pairwise-sample-clustering.html#cb63-10" tabindex="-1"></a></span>
<span id="cb63-11"><a href="viewing-pairwise-sample-clustering.html#cb63-11" tabindex="-1"></a><span class="fu">quit</span>(<span class="at">save=</span><span class="st">&quot;no&quot;</span>)</span></code></pre></div>
<div id="supplementary-r-de-visualization" class="section level3 hasAnchor">
<h3>Supplementary R DE Visualization<a href="viewing-pairwise-sample-clustering.html#supplementary-r-de-visualization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Occasionally you may wish to reformat and work with expression estimates in R in an ad hoc way. Here, we provide an optional/advanced tutorial on how to visualize your results for R and perform “old school” (non-ballgown, non-DESeq2) visualization of your data.</p>
<p>In this tutorial you will:</p>
<ul>
<li>Learn basic R usage and commands (common plots, and data manipulation tasks)</li>
<li>Examine the expression estimates</li>
<li>Create an MDS plot to visualize the differences between/among replicates, library prep methods and UHR versus HBR</li>
<li>Examine the differential expression estimates</li>
<li>Visualize the expression estimates and highlight those genes that appear to be differentially expressed</li>
<li>Ask how reproducible technical replicates are.</li>
</ul>
<p>Expression and differential expression files will be read into R. The R analysis will make use of the gene-level expression estimates from HISAT2/Stringtie (TPM values) and differential expression results from HISAT2/htseq-count/DESeq2 (fold-changes and p-values).</p>
<p>Start RStudio, or launch a posit Cloud session, or if you are using AWS, navigate to the correct directory and then launch R:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="viewing-pairwise-sample-clustering.html#cb64-1" tabindex="-1"></a><span class="fu">mkdir</span> <span class="va">$RNA_HOME</span>/de/visualization_advanced</span>
<span id="cb64-2"><a href="viewing-pairwise-sample-clustering.html#cb64-2" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$RNA_HOME</span>/de/visualization_advanced</span>
<span id="cb64-3"><a href="viewing-pairwise-sample-clustering.html#cb64-3" tabindex="-1"></a></span>
<span id="cb64-4"><a href="viewing-pairwise-sample-clustering.html#cb64-4" tabindex="-1"></a><span class="ex">R</span></span></code></pre></div>
<p>First you’ll load your libraries and your data.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="viewing-pairwise-sample-clustering.html#cb65-1" tabindex="-1"></a><span class="co">#Load your libraries</span></span>
<span id="cb65-2"><a href="viewing-pairwise-sample-clustering.html#cb65-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb65-3"><a href="viewing-pairwise-sample-clustering.html#cb65-3" tabindex="-1"></a><span class="fu">library</span>(gplots)</span>
<span id="cb65-4"><a href="viewing-pairwise-sample-clustering.html#cb65-4" tabindex="-1"></a><span class="fu">library</span>(GenomicRanges)</span>
<span id="cb65-5"><a href="viewing-pairwise-sample-clustering.html#cb65-5" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb65-6"><a href="viewing-pairwise-sample-clustering.html#cb65-6" tabindex="-1"></a></span>
<span id="cb65-7"><a href="viewing-pairwise-sample-clustering.html#cb65-7" tabindex="-1"></a><span class="co">#Set a base working directory</span></span>
<span id="cb65-8"><a href="viewing-pairwise-sample-clustering.html#cb65-8" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;/home/ubuntu/workspace/rnaseq/de/visualization_advanced/&quot;</span>)</span>
<span id="cb65-9"><a href="viewing-pairwise-sample-clustering.html#cb65-9" tabindex="-1"></a></span>
<span id="cb65-10"><a href="viewing-pairwise-sample-clustering.html#cb65-10" tabindex="-1"></a><span class="co">#Import expression results (TPM values) from the HISAT2/Stringtie pipeline (https://genomedata.org/cri-workshop/gene_tpm_all_samples.tsv)</span></span>
<span id="cb65-11"><a href="viewing-pairwise-sample-clustering.html#cb65-11" tabindex="-1"></a>gene_expression <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">&quot;~/workspace/rnaseq/expression/stringtie/ref_only/gene_tpm_all_samples.tsv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb65-12"><a href="viewing-pairwise-sample-clustering.html#cb65-12" tabindex="-1"></a><span class="co">#gene_expression = read.table(&quot;data/bulk_rna/gene_tpm_all_samples.tsv&quot;, header = TRUE, stringsAsFactors = FALSE, row.names = 1)</span></span>
<span id="cb65-13"><a href="viewing-pairwise-sample-clustering.html#cb65-13" tabindex="-1"></a></span>
<span id="cb65-14"><a href="viewing-pairwise-sample-clustering.html#cb65-14" tabindex="-1"></a><span class="co">#Import gene name mapping file (https://genomedata.org/cri-workshop/ENSG_ID2Name.txt)</span></span>
<span id="cb65-15"><a href="viewing-pairwise-sample-clustering.html#cb65-15" tabindex="-1"></a>gene_names<span class="ot">=</span><span class="fu">read.table</span>(<span class="st">&quot;~/workspace/rnaseq/de/htseq_counts/ENSG_ID2Name.txt&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb65-16"><a href="viewing-pairwise-sample-clustering.html#cb65-16" tabindex="-1"></a><span class="co">#gene_names=read.table(&quot;data/bulk_rna/ENSG_ID2Name.txt&quot;, header = TRUE, stringsAsFactors = FALSE)</span></span>
<span id="cb65-17"><a href="viewing-pairwise-sample-clustering.html#cb65-17" tabindex="-1"></a></span>
<span id="cb65-18"><a href="viewing-pairwise-sample-clustering.html#cb65-18" tabindex="-1"></a><span class="fu">colnames</span>(gene_names) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;gene_id&quot;</span>, <span class="st">&quot;gene_name&quot;</span>)</span>
<span id="cb65-19"><a href="viewing-pairwise-sample-clustering.html#cb65-19" tabindex="-1"></a></span>
<span id="cb65-20"><a href="viewing-pairwise-sample-clustering.html#cb65-20" tabindex="-1"></a><span class="co">#Import DE results from the HISAT2/htseq-count/DESeq2 pipeline (http://genomedata.org/cri-workshop/deseq2/DE_all_genes_DESeq2.tsv)</span></span>
<span id="cb65-21"><a href="viewing-pairwise-sample-clustering.html#cb65-21" tabindex="-1"></a>results_genes <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">&quot;~/workspace/rnaseq/de/deseq2/DE_all_genes_DESeq2.tsv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb65-22"><a href="viewing-pairwise-sample-clustering.html#cb65-22" tabindex="-1"></a><span class="co">#results_genes = read.table(&quot;outdir/DE_all_genes_DESeq2.tsv&quot;, sep = &quot;\t&quot;, header = TRUE, stringsAsFactors = FALSE)</span></span>
<span id="cb65-23"><a href="viewing-pairwise-sample-clustering.html#cb65-23" tabindex="-1"></a></span>
<span id="cb65-24"><a href="viewing-pairwise-sample-clustering.html#cb65-24" tabindex="-1"></a><span class="co">#Set a directory for the output to go to</span></span>
<span id="cb65-25"><a href="viewing-pairwise-sample-clustering.html#cb65-25" tabindex="-1"></a><span class="co"># output_dir = &quot;/cloud/project/outdir/visualization_advanced/&quot;</span></span>
<span id="cb65-26"><a href="viewing-pairwise-sample-clustering.html#cb65-26" tabindex="-1"></a><span class="co"># if (!dir.exists(output_dir)) {</span></span>
<span id="cb65-27"><a href="viewing-pairwise-sample-clustering.html#cb65-27" tabindex="-1"></a><span class="co">#   dir.create(output_dir, recursive = TRUE)</span></span>
<span id="cb65-28"><a href="viewing-pairwise-sample-clustering.html#cb65-28" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb65-29"><a href="viewing-pairwise-sample-clustering.html#cb65-29" tabindex="-1"></a><span class="co"># setwd(output_dir)</span></span></code></pre></div>
<p>Let’s briefly explore the imported data</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="viewing-pairwise-sample-clustering.html#cb66-1" tabindex="-1"></a></span>
<span id="cb66-2"><a href="viewing-pairwise-sample-clustering.html#cb66-2" tabindex="-1"></a><span class="do">#### Working with &#39;dataframes&#39;</span></span>
<span id="cb66-3"><a href="viewing-pairwise-sample-clustering.html#cb66-3" tabindex="-1"></a><span class="co">#View the first five rows of data (all columns) in the gene_expression (Stringtie TPM) dataframe</span></span>
<span id="cb66-4"><a href="viewing-pairwise-sample-clustering.html#cb66-4" tabindex="-1"></a><span class="fu">head</span>(gene_expression)</span>
<span id="cb66-5"><a href="viewing-pairwise-sample-clustering.html#cb66-5" tabindex="-1"></a></span>
<span id="cb66-6"><a href="viewing-pairwise-sample-clustering.html#cb66-6" tabindex="-1"></a><span class="co">#View the column names</span></span>
<span id="cb66-7"><a href="viewing-pairwise-sample-clustering.html#cb66-7" tabindex="-1"></a><span class="fu">colnames</span>(gene_expression)</span>
<span id="cb66-8"><a href="viewing-pairwise-sample-clustering.html#cb66-8" tabindex="-1"></a></span>
<span id="cb66-9"><a href="viewing-pairwise-sample-clustering.html#cb66-9" tabindex="-1"></a><span class="co">#View the row names</span></span>
<span id="cb66-10"><a href="viewing-pairwise-sample-clustering.html#cb66-10" tabindex="-1"></a><span class="fu">row.names</span>(gene_expression)</span>
<span id="cb66-11"><a href="viewing-pairwise-sample-clustering.html#cb66-11" tabindex="-1"></a></span>
<span id="cb66-12"><a href="viewing-pairwise-sample-clustering.html#cb66-12" tabindex="-1"></a><span class="co">#Determine the dimensions of the dataframe.  &#39;dim()&#39; will return the number of rows and columns</span></span>
<span id="cb66-13"><a href="viewing-pairwise-sample-clustering.html#cb66-13" tabindex="-1"></a><span class="fu">dim</span>(gene_expression)</span>
<span id="cb66-14"><a href="viewing-pairwise-sample-clustering.html#cb66-14" tabindex="-1"></a></span>
<span id="cb66-15"><a href="viewing-pairwise-sample-clustering.html#cb66-15" tabindex="-1"></a><span class="co">#Get the first 3 rows of data and a selection of columns</span></span>
<span id="cb66-16"><a href="viewing-pairwise-sample-clustering.html#cb66-16" tabindex="-1"></a>gene_expression[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">6</span>)]</span>
<span id="cb66-17"><a href="viewing-pairwise-sample-clustering.html#cb66-17" tabindex="-1"></a></span>
<span id="cb66-18"><a href="viewing-pairwise-sample-clustering.html#cb66-18" tabindex="-1"></a><span class="co">#Do the same thing, but using the column names instead of numbers</span></span>
<span id="cb66-19"><a href="viewing-pairwise-sample-clustering.html#cb66-19" tabindex="-1"></a>gene_expression[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="st">&quot;HBR_Rep1&quot;</span>, <span class="st">&quot;HBR_Rep2&quot;</span>, <span class="st">&quot;HBR_Rep3&quot;</span>, <span class="st">&quot;UHR_Rep3&quot;</span>)]</span>
<span id="cb66-20"><a href="viewing-pairwise-sample-clustering.html#cb66-20" tabindex="-1"></a></span>
<span id="cb66-21"><a href="viewing-pairwise-sample-clustering.html#cb66-21" tabindex="-1"></a><span class="co">#Now, exlore the differential expression (DESeq2 results) </span></span>
<span id="cb66-22"><a href="viewing-pairwise-sample-clustering.html#cb66-22" tabindex="-1"></a><span class="fu">head</span>(results_genes)</span>
<span id="cb66-23"><a href="viewing-pairwise-sample-clustering.html#cb66-23" tabindex="-1"></a><span class="fu">dim</span>(results_genes)</span>
<span id="cb66-24"><a href="viewing-pairwise-sample-clustering.html#cb66-24" tabindex="-1"></a></span>
<span id="cb66-25"><a href="viewing-pairwise-sample-clustering.html#cb66-25" tabindex="-1"></a><span class="co">#Assign some colors for use later.  You can specify color by RGB, Hex code, or name</span></span>
<span id="cb66-26"><a href="viewing-pairwise-sample-clustering.html#cb66-26" tabindex="-1"></a><span class="co">#To get a list of color names:</span></span>
<span id="cb66-27"><a href="viewing-pairwise-sample-clustering.html#cb66-27" tabindex="-1"></a><span class="fu">colours</span>()</span>
<span id="cb66-28"><a href="viewing-pairwise-sample-clustering.html#cb66-28" tabindex="-1"></a>data_colors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;tomato1&quot;</span>, <span class="st">&quot;tomato2&quot;</span>, <span class="st">&quot;tomato3&quot;</span>, <span class="st">&quot;royalblue1&quot;</span>, <span class="st">&quot;royalblue2&quot;</span>, <span class="st">&quot;royalblue3&quot;</span>)</span></code></pre></div>
<p>The following code blocks are to generate various plots using the above data set.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="viewing-pairwise-sample-clustering.html#cb67-1" tabindex="-1"></a></span>
<span id="cb67-2"><a href="viewing-pairwise-sample-clustering.html#cb67-2" tabindex="-1"></a><span class="do">#### Plot #1 - View the range of values and general distribution of TPM values for all 6 libraries</span></span>
<span id="cb67-3"><a href="viewing-pairwise-sample-clustering.html#cb67-3" tabindex="-1"></a><span class="co">#Create boxplots for this purpose</span></span>
<span id="cb67-4"><a href="viewing-pairwise-sample-clustering.html#cb67-4" tabindex="-1"></a><span class="co">#Display on a log2 scale and set a minimum non-zero value to avoid log2(0)</span></span>
<span id="cb67-5"><a href="viewing-pairwise-sample-clustering.html#cb67-5" tabindex="-1"></a>min_nonzero <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb67-6"><a href="viewing-pairwise-sample-clustering.html#cb67-6" tabindex="-1"></a></span>
<span id="cb67-7"><a href="viewing-pairwise-sample-clustering.html#cb67-7" tabindex="-1"></a><span class="co"># Set the columns for finding TPM and create shorter names for figures</span></span>
<span id="cb67-8"><a href="viewing-pairwise-sample-clustering.html#cb67-8" tabindex="-1"></a>data_columns <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb67-9"><a href="viewing-pairwise-sample-clustering.html#cb67-9" tabindex="-1"></a>short_names <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;HBR_1&quot;</span>, <span class="st">&quot;HBR_2&quot;</span>, <span class="st">&quot;HBR_3&quot;</span>, <span class="st">&quot;UHR_1&quot;</span>, <span class="st">&quot;UHR_2&quot;</span>, <span class="st">&quot;UHR_3&quot;</span>)</span>
<span id="cb67-10"><a href="viewing-pairwise-sample-clustering.html#cb67-10" tabindex="-1"></a></span>
<span id="cb67-11"><a href="viewing-pairwise-sample-clustering.html#cb67-11" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;All_samples_TPM_boxplots.pdf&quot;</span>)</span>
<span id="cb67-12"><a href="viewing-pairwise-sample-clustering.html#cb67-12" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">log2</span>(gene_expression[, data_columns] <span class="sc">+</span> min_nonzero), <span class="at">col =</span> data_colors, <span class="at">names =</span> short_names, <span class="at">las =</span> <span class="dv">2</span>, <span class="at">ylab =</span> <span class="st">&quot;log2(TPM)&quot;</span>, <span class="at">main =</span> <span class="st">&quot;Distribution of TPMs for all 6 libraries&quot;</span>)</span>
<span id="cb67-13"><a href="viewing-pairwise-sample-clustering.html#cb67-13" tabindex="-1"></a><span class="co">#Note that the bold horizontal line on each boxplot is the median</span></span>
<span id="cb67-14"><a href="viewing-pairwise-sample-clustering.html#cb67-14" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-15"><a href="viewing-pairwise-sample-clustering.html#cb67-15" tabindex="-1"></a></span>
<span id="cb67-16"><a href="viewing-pairwise-sample-clustering.html#cb67-16" tabindex="-1"></a><span class="do">#### Plot #2 - plot a pair of replicates to assess reproducibility of technical replicates</span></span>
<span id="cb67-17"><a href="viewing-pairwise-sample-clustering.html#cb67-17" tabindex="-1"></a><span class="co">#Tranform the data by converting to log2 scale after adding an arbitrary small value to avoid log2(0)</span></span>
<span id="cb67-18"><a href="viewing-pairwise-sample-clustering.html#cb67-18" tabindex="-1"></a>x <span class="ot">=</span> gene_expression[, <span class="st">&quot;UHR_Rep1&quot;</span>]</span>
<span id="cb67-19"><a href="viewing-pairwise-sample-clustering.html#cb67-19" tabindex="-1"></a>y <span class="ot">=</span> gene_expression[, <span class="st">&quot;UHR_Rep2&quot;</span>]</span>
<span id="cb67-20"><a href="viewing-pairwise-sample-clustering.html#cb67-20" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;UHR_Rep1_vs_Rep2_scatter.pdf&quot;</span>)</span>
<span id="cb67-21"><a href="viewing-pairwise-sample-clustering.html#cb67-21" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> <span class="fu">log2</span>(x <span class="sc">+</span> min_nonzero), <span class="at">y =</span> <span class="fu">log2</span>(y <span class="sc">+</span> min_nonzero), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">cex =</span> <span class="fl">0.25</span>, <span class="at">xlab =</span> <span class="st">&quot;TPM (UHR, Replicate 1)&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;TPM (UHR, Replicate 2)&quot;</span>, <span class="at">main =</span> <span class="st">&quot;Comparison of expression values for a pair of replicates&quot;</span>)</span>
<span id="cb67-22"><a href="viewing-pairwise-sample-clustering.html#cb67-22" tabindex="-1"></a></span>
<span id="cb67-23"><a href="viewing-pairwise-sample-clustering.html#cb67-23" tabindex="-1"></a><span class="co">#Add a straight line of slope 1, and intercept 0</span></span>
<span id="cb67-24"><a href="viewing-pairwise-sample-clustering.html#cb67-24" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span>
<span id="cb67-25"><a href="viewing-pairwise-sample-clustering.html#cb67-25" tabindex="-1"></a></span>
<span id="cb67-26"><a href="viewing-pairwise-sample-clustering.html#cb67-26" tabindex="-1"></a><span class="co">#Calculate the correlation coefficient and display in a legend</span></span>
<span id="cb67-27"><a href="viewing-pairwise-sample-clustering.html#cb67-27" tabindex="-1"></a>rs <span class="ot">=</span> <span class="fu">cor</span>(x, y)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb67-28"><a href="viewing-pairwise-sample-clustering.html#cb67-28" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="fu">paste</span>(<span class="st">&quot;R squared = &quot;</span>, <span class="fu">round</span>(rs, <span class="at">digits =</span> <span class="dv">3</span>), <span class="at">sep =</span> <span class="st">&quot;&quot;</span>), <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb67-29"><a href="viewing-pairwise-sample-clustering.html#cb67-29" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-30"><a href="viewing-pairwise-sample-clustering.html#cb67-30" tabindex="-1"></a></span>
<span id="cb67-31"><a href="viewing-pairwise-sample-clustering.html#cb67-31" tabindex="-1"></a><span class="do">#### Plot #3 - Scatter plots with a large number of data points can be misleading ... regenerate this figure as a density scatter plot</span></span>
<span id="cb67-32"><a href="viewing-pairwise-sample-clustering.html#cb67-32" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;UHR_Rep1_vs_Rep2_SmoothScatter.pdf&quot;</span>)</span>
<span id="cb67-33"><a href="viewing-pairwise-sample-clustering.html#cb67-33" tabindex="-1"></a>colors <span class="ot">=</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">&quot;white&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;#007FFF&quot;</span>, <span class="st">&quot;cyan&quot;</span>,<span class="st">&quot;#7FFF7F&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;#FF7F00&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;#7F0000&quot;</span>))</span>
<span id="cb67-34"><a href="viewing-pairwise-sample-clustering.html#cb67-34" tabindex="-1"></a><span class="fu">smoothScatter</span>(<span class="at">x =</span> <span class="fu">log2</span>(x <span class="sc">+</span> min_nonzero), <span class="at">y =</span> <span class="fu">log2</span>(y <span class="sc">+</span> min_nonzero), <span class="at">xlab =</span> <span class="st">&quot;TPM (UHR, Replicate 1)&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;TPM (UHR, Replicate 2)&quot;</span>, <span class="at">main =</span> <span class="st">&quot;Comparison of expression values for a pair of replicates&quot;</span>, <span class="at">colramp =</span> colors, <span class="at">nbin =</span> <span class="dv">200</span>)</span>
<span id="cb67-35"><a href="viewing-pairwise-sample-clustering.html#cb67-35" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-36"><a href="viewing-pairwise-sample-clustering.html#cb67-36" tabindex="-1"></a></span>
<span id="cb67-37"><a href="viewing-pairwise-sample-clustering.html#cb67-37" tabindex="-1"></a><span class="do">#### Plot #4 - Scatter plots of all sets of replicates on a single plot</span></span>
<span id="cb67-38"><a href="viewing-pairwise-sample-clustering.html#cb67-38" tabindex="-1"></a><span class="co">#Create a function that generates an R plot.  This function will take as input the two libraries to be compared and a plot name</span></span>
<span id="cb67-39"><a href="viewing-pairwise-sample-clustering.html#cb67-39" tabindex="-1"></a>plotCor <span class="ot">=</span> <span class="cf">function</span>(lib1, lib2, name){</span>
<span id="cb67-40"><a href="viewing-pairwise-sample-clustering.html#cb67-40" tabindex="-1"></a>    x <span class="ot">=</span> gene_expression[, lib1]</span>
<span id="cb67-41"><a href="viewing-pairwise-sample-clustering.html#cb67-41" tabindex="-1"></a>    y <span class="ot">=</span> gene_expression[, lib2]</span>
<span id="cb67-42"><a href="viewing-pairwise-sample-clustering.html#cb67-42" tabindex="-1"></a>    colors <span class="ot">=</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">&quot;white&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;#007FFF&quot;</span>, <span class="st">&quot;cyan&quot;</span>, <span class="st">&quot;#7FFF7F&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;#FF7F00&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;#7F0000&quot;</span>))</span>
<span id="cb67-43"><a href="viewing-pairwise-sample-clustering.html#cb67-43" tabindex="-1"></a>    <span class="fu">smoothScatter</span>(<span class="at">x =</span> <span class="fu">log2</span>(x <span class="sc">+</span> min_nonzero), <span class="at">y =</span> <span class="fu">log2</span>(y <span class="sc">+</span> min_nonzero), <span class="at">xlab =</span> lib1, <span class="at">ylab =</span> lib2, <span class="at">main =</span> name, <span class="at">colramp =</span> colors, <span class="at">nbin =</span> <span class="dv">275</span>)</span>
<span id="cb67-44"><a href="viewing-pairwise-sample-clustering.html#cb67-44" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span>
<span id="cb67-45"><a href="viewing-pairwise-sample-clustering.html#cb67-45" tabindex="-1"></a>        zero_count <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">which</span>(x <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">+</span> <span class="fu">length</span>(<span class="fu">which</span>(y <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb67-46"><a href="viewing-pairwise-sample-clustering.html#cb67-46" tabindex="-1"></a>    rs <span class="ot">=</span> <span class="fu">cor</span>(x, y, <span class="at">method =</span> <span class="st">&quot;pearson&quot;</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb67-47"><a href="viewing-pairwise-sample-clustering.html#cb67-47" tabindex="-1"></a>    legend_text <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;R squared = &quot;</span>, <span class="fu">round</span>(rs, <span class="at">digits =</span> <span class="dv">3</span>), <span class="at">sep=</span><span class="st">&quot;&quot;</span>), <span class="fu">paste</span>(<span class="st">&quot;Zero count = &quot;</span>, zero_count, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb67-48"><a href="viewing-pairwise-sample-clustering.html#cb67-48" tabindex="-1"></a>    <span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>, legend_text, <span class="at">lwd =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>), <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb67-49"><a href="viewing-pairwise-sample-clustering.html#cb67-49" tabindex="-1"></a>}</span>
<span id="cb67-50"><a href="viewing-pairwise-sample-clustering.html#cb67-50" tabindex="-1"></a></span>
<span id="cb67-51"><a href="viewing-pairwise-sample-clustering.html#cb67-51" tabindex="-1"></a><span class="co">#Now make a call to our custom function created above, once for each library comparison</span></span>
<span id="cb67-52"><a href="viewing-pairwise-sample-clustering.html#cb67-52" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;UHR_All_Reps_SmoothScatter.pdf&quot;</span>)</span>
<span id="cb67-53"><a href="viewing-pairwise-sample-clustering.html#cb67-53" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb67-54"><a href="viewing-pairwise-sample-clustering.html#cb67-54" tabindex="-1"></a><span class="fu">plotCor</span>(<span class="st">&quot;UHR_Rep1&quot;</span>, <span class="st">&quot;UHR_Rep2&quot;</span>, <span class="st">&quot;UHR_1 vs UHR_2&quot;</span>)</span>
<span id="cb67-55"><a href="viewing-pairwise-sample-clustering.html#cb67-55" tabindex="-1"></a><span class="fu">plotCor</span>(<span class="st">&quot;UHR_Rep2&quot;</span>, <span class="st">&quot;UHR_Rep3&quot;</span>, <span class="st">&quot;UHR_2 vs UHR_3&quot;</span>)</span>
<span id="cb67-56"><a href="viewing-pairwise-sample-clustering.html#cb67-56" tabindex="-1"></a><span class="fu">plotCor</span>(<span class="st">&quot;UHR_Rep1&quot;</span>, <span class="st">&quot;UHR_Rep3&quot;</span>, <span class="st">&quot;UHR_1 vs UHR_3&quot;</span>)</span>
<span id="cb67-57"><a href="viewing-pairwise-sample-clustering.html#cb67-57" tabindex="-1"></a></span>
<span id="cb67-58"><a href="viewing-pairwise-sample-clustering.html#cb67-58" tabindex="-1"></a><span class="do">#### Compare the correlation between all replicates</span></span>
<span id="cb67-59"><a href="viewing-pairwise-sample-clustering.html#cb67-59" tabindex="-1"></a><span class="co">#Do we see the expected pattern for all eight libraries (i.e. replicates most similar, then tumor vs. normal)?</span></span>
<span id="cb67-60"><a href="viewing-pairwise-sample-clustering.html#cb67-60" tabindex="-1"></a></span>
<span id="cb67-61"><a href="viewing-pairwise-sample-clustering.html#cb67-61" tabindex="-1"></a><span class="co">#Calculate the TPM sum for all 6 libraries</span></span>
<span id="cb67-62"><a href="viewing-pairwise-sample-clustering.html#cb67-62" tabindex="-1"></a>gene_expression[,<span class="st">&quot;sum&quot;</span>] <span class="ot">=</span> <span class="fu">apply</span>(gene_expression[,data_columns], <span class="dv">1</span>, sum)</span>
<span id="cb67-63"><a href="viewing-pairwise-sample-clustering.html#cb67-63" tabindex="-1"></a></span>
<span id="cb67-64"><a href="viewing-pairwise-sample-clustering.html#cb67-64" tabindex="-1"></a><span class="co">#Identify the genes with a grand sum TPM of at least 5 - we will filter out the genes with very low expression across the board</span></span>
<span id="cb67-65"><a href="viewing-pairwise-sample-clustering.html#cb67-65" tabindex="-1"></a>i <span class="ot">=</span> <span class="fu">which</span>(gene_expression[,<span class="st">&quot;sum&quot;</span>] <span class="sc">&gt;</span> <span class="dv">5</span>)</span>
<span id="cb67-66"><a href="viewing-pairwise-sample-clustering.html#cb67-66" tabindex="-1"></a></span>
<span id="cb67-67"><a href="viewing-pairwise-sample-clustering.html#cb67-67" tabindex="-1"></a><span class="co">#Calculate the correlation between all pairs of data</span></span>
<span id="cb67-68"><a href="viewing-pairwise-sample-clustering.html#cb67-68" tabindex="-1"></a>r <span class="ot">=</span> <span class="fu">cor</span>(gene_expression[i,data_columns], <span class="at">use =</span> <span class="st">&quot;pairwise.complete.obs&quot;</span>, <span class="at">method =</span> <span class="st">&quot;pearson&quot;</span>)</span>
<span id="cb67-69"><a href="viewing-pairwise-sample-clustering.html#cb67-69" tabindex="-1"></a></span>
<span id="cb67-70"><a href="viewing-pairwise-sample-clustering.html#cb67-70" tabindex="-1"></a><span class="co">#Print out these correlation values</span></span>
<span id="cb67-71"><a href="viewing-pairwise-sample-clustering.html#cb67-71" tabindex="-1"></a>r</span>
<span id="cb67-72"><a href="viewing-pairwise-sample-clustering.html#cb67-72" tabindex="-1"></a></span>
<span id="cb67-73"><a href="viewing-pairwise-sample-clustering.html#cb67-73" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-74"><a href="viewing-pairwise-sample-clustering.html#cb67-74" tabindex="-1"></a></span>
<span id="cb67-75"><a href="viewing-pairwise-sample-clustering.html#cb67-75" tabindex="-1"></a></span>
<span id="cb67-76"><a href="viewing-pairwise-sample-clustering.html#cb67-76" tabindex="-1"></a><span class="do">#### Plot #5 - Convert correlation to &#39;distance&#39;, and use &#39;multi-dimensional scaling&#39; to display the relative differences between libraries</span></span>
<span id="cb67-77"><a href="viewing-pairwise-sample-clustering.html#cb67-77" tabindex="-1"></a><span class="co">#This step calculates 2-dimensional coordinates to plot points for each library</span></span>
<span id="cb67-78"><a href="viewing-pairwise-sample-clustering.html#cb67-78" tabindex="-1"></a><span class="co">#Libraries with similar expression patterns (highly correlated to each other) should group together</span></span>
<span id="cb67-79"><a href="viewing-pairwise-sample-clustering.html#cb67-79" tabindex="-1"></a><span class="co">#What pattern do we expect to see, given the types of libraries we have (technical replicates, biologal replicates, tumor/normal)?</span></span>
<span id="cb67-80"><a href="viewing-pairwise-sample-clustering.html#cb67-80" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;UHR_vs_HBR_MDS.pdf&quot;</span>)</span>
<span id="cb67-81"><a href="viewing-pairwise-sample-clustering.html#cb67-81" tabindex="-1"></a>d <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> r</span>
<span id="cb67-82"><a href="viewing-pairwise-sample-clustering.html#cb67-82" tabindex="-1"></a>mds <span class="ot">=</span> <span class="fu">cmdscale</span>(d, <span class="at">k =</span> <span class="dv">2</span>, <span class="at">eig =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-83"><a href="viewing-pairwise-sample-clustering.html#cb67-83" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb67-84"><a href="viewing-pairwise-sample-clustering.html#cb67-84" tabindex="-1"></a><span class="fu">plot</span>(mds<span class="sc">$</span>points, <span class="at">type =</span> <span class="st">&quot;n&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>, <span class="at">main =</span> <span class="st">&quot;MDS distance plot (all non-zero genes)&quot;</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.12</span>, <span class="fl">0.12</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.12</span>, <span class="fl">0.12</span>))</span>
<span id="cb67-85"><a href="viewing-pairwise-sample-clustering.html#cb67-85" tabindex="-1"></a><span class="fu">points</span>(mds<span class="sc">$</span>points[, <span class="dv">1</span>], mds<span class="sc">$</span>points[, <span class="dv">2</span>], <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb67-86"><a href="viewing-pairwise-sample-clustering.html#cb67-86" tabindex="-1"></a><span class="fu">text</span>(mds<span class="sc">$</span>points[, <span class="dv">1</span>], mds<span class="sc">$</span>points[, <span class="dv">2</span>], short_names, <span class="at">col =</span> data_colors)</span>
<span id="cb67-87"><a href="viewing-pairwise-sample-clustering.html#cb67-87" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-88"><a href="viewing-pairwise-sample-clustering.html#cb67-88" tabindex="-1"></a></span>
<span id="cb67-89"><a href="viewing-pairwise-sample-clustering.html#cb67-89" tabindex="-1"></a></span>
<span id="cb67-90"><a href="viewing-pairwise-sample-clustering.html#cb67-90" tabindex="-1"></a><span class="do">#### Plot #6 - View the distribution of differential expression values as a histogram</span></span>
<span id="cb67-91"><a href="viewing-pairwise-sample-clustering.html#cb67-91" tabindex="-1"></a><span class="co">#Display only those results that are significant according to DESeq2 (loaded above)</span></span>
<span id="cb67-92"><a href="viewing-pairwise-sample-clustering.html#cb67-92" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;UHR_vs_HBR_DE_FC_distribution.pdf&quot;</span>)</span>
<span id="cb67-93"><a href="viewing-pairwise-sample-clustering.html#cb67-93" tabindex="-1"></a>sig <span class="ot">=</span> <span class="fu">which</span>(results_genes<span class="sc">$</span>pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb67-94"><a href="viewing-pairwise-sample-clustering.html#cb67-94" tabindex="-1"></a><span class="fu">hist</span>(results_genes[sig, <span class="st">&quot;log2FoldChange&quot;</span>], <span class="at">breaks =</span> <span class="dv">50</span>, <span class="at">col =</span> <span class="st">&quot;seagreen&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log2(Fold change) UHR vs HBR&quot;</span>, <span class="at">main =</span> <span class="st">&quot;Distribution of differential expression values&quot;</span>)</span>
<span id="cb67-95"><a href="viewing-pairwise-sample-clustering.html#cb67-95" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb67-96"><a href="viewing-pairwise-sample-clustering.html#cb67-96" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb67-97"><a href="viewing-pairwise-sample-clustering.html#cb67-97" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="st">&quot;Fold-change &gt; 2&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb67-98"><a href="viewing-pairwise-sample-clustering.html#cb67-98" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-99"><a href="viewing-pairwise-sample-clustering.html#cb67-99" tabindex="-1"></a></span>
<span id="cb67-100"><a href="viewing-pairwise-sample-clustering.html#cb67-100" tabindex="-1"></a><span class="do">#### Plot #7 - Display the mean expression values from UHR and HBR and mark those that are significantly differentially expressed</span></span>
<span id="cb67-101"><a href="viewing-pairwise-sample-clustering.html#cb67-101" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file=</span><span class="st">&quot;UHR_vs_HBR_mean_TPM_scatter.pdf&quot;</span>)</span>
<span id="cb67-102"><a href="viewing-pairwise-sample-clustering.html#cb67-102" tabindex="-1"></a></span>
<span id="cb67-103"><a href="viewing-pairwise-sample-clustering.html#cb67-103" tabindex="-1"></a>gene_expression[, <span class="st">&quot;HBR_mean&quot;</span>] <span class="ot">=</span> <span class="fu">apply</span>(gene_expression[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)], <span class="dv">1</span>, mean)</span>
<span id="cb67-104"><a href="viewing-pairwise-sample-clustering.html#cb67-104" tabindex="-1"></a>gene_expression[, <span class="st">&quot;UHR_mean&quot;</span>] <span class="ot">=</span> <span class="fu">apply</span>(gene_expression[,<span class="fu">c</span>(<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)], <span class="dv">1</span>, mean)</span>
<span id="cb67-105"><a href="viewing-pairwise-sample-clustering.html#cb67-105" tabindex="-1"></a></span>
<span id="cb67-106"><a href="viewing-pairwise-sample-clustering.html#cb67-106" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">log2</span>(gene_expression[, <span class="st">&quot;UHR_mean&quot;</span>] <span class="sc">+</span> min_nonzero)</span>
<span id="cb67-107"><a href="viewing-pairwise-sample-clustering.html#cb67-107" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">log2</span>(gene_expression[, <span class="st">&quot;HBR_mean&quot;</span>] <span class="sc">+</span> min_nonzero)</span>
<span id="cb67-108"><a href="viewing-pairwise-sample-clustering.html#cb67-108" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.25</span>, <span class="at">xlab =</span> <span class="st">&quot;UHR TPM (log2)&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;HBR TPM (log2)&quot;</span>, <span class="at">main =</span> <span class="st">&quot;UHR vs HBR TPMs&quot;</span>)</span>
<span id="cb67-109"><a href="viewing-pairwise-sample-clustering.html#cb67-109" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span>
<span id="cb67-110"><a href="viewing-pairwise-sample-clustering.html#cb67-110" tabindex="-1"></a>xsig <span class="ot">=</span> x[sig]</span>
<span id="cb67-111"><a href="viewing-pairwise-sample-clustering.html#cb67-111" tabindex="-1"></a>ysig <span class="ot">=</span> y[sig]</span>
<span id="cb67-112"><a href="viewing-pairwise-sample-clustering.html#cb67-112" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> xsig, <span class="at">y =</span> ysig, <span class="at">col =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.5</span>)</span>
<span id="cb67-113"><a href="viewing-pairwise-sample-clustering.html#cb67-113" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="st">&quot;Significant&quot;</span>, <span class="at">col =</span> <span class="st">&quot;magenta&quot;</span>, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb67-114"><a href="viewing-pairwise-sample-clustering.html#cb67-114" tabindex="-1"></a></span>
<span id="cb67-115"><a href="viewing-pairwise-sample-clustering.html#cb67-115" tabindex="-1"></a><span class="co">#Get the gene symbols for the top N (according to corrected p-value) and display them on the plot</span></span>
<span id="cb67-116"><a href="viewing-pairwise-sample-clustering.html#cb67-116" tabindex="-1"></a>topn <span class="ot">=</span> <span class="fu">order</span>(results_genes[sig,<span class="st">&quot;padj&quot;</span>])[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>]</span>
<span id="cb67-117"><a href="viewing-pairwise-sample-clustering.html#cb67-117" tabindex="-1"></a><span class="fu">text</span>(x[topn], y[topn], results_genes[topn, <span class="st">&quot;Symbol&quot;</span>], <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">cex =</span> <span class="fl">0.75</span>, <span class="at">srt =</span> <span class="dv">45</span>)</span>
<span id="cb67-118"><a href="viewing-pairwise-sample-clustering.html#cb67-118" tabindex="-1"></a></span>
<span id="cb67-119"><a href="viewing-pairwise-sample-clustering.html#cb67-119" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-120"><a href="viewing-pairwise-sample-clustering.html#cb67-120" tabindex="-1"></a></span>
<span id="cb67-121"><a href="viewing-pairwise-sample-clustering.html#cb67-121" tabindex="-1"></a><span class="do">#### Plot #8 - Create a heatmap to vizualize expression differences between the six samples</span></span>
<span id="cb67-122"><a href="viewing-pairwise-sample-clustering.html#cb67-122" tabindex="-1"></a><span class="co">#Define custom dist and hclust functions for use with heatmaps</span></span>
<span id="cb67-123"><a href="viewing-pairwise-sample-clustering.html#cb67-123" tabindex="-1"></a>mydist <span class="ot">=</span> <span class="cf">function</span>(c) {<span class="fu">dist</span>(c, <span class="at">method =</span> <span class="st">&quot;euclidian&quot;</span>)}</span>
<span id="cb67-124"><a href="viewing-pairwise-sample-clustering.html#cb67-124" tabindex="-1"></a>myclust <span class="ot">=</span> <span class="cf">function</span>(c) {<span class="fu">hclust</span>(c, <span class="at">method =</span> <span class="st">&quot;average&quot;</span>)}</span>
<span id="cb67-125"><a href="viewing-pairwise-sample-clustering.html#cb67-125" tabindex="-1"></a></span>
<span id="cb67-126"><a href="viewing-pairwise-sample-clustering.html#cb67-126" tabindex="-1"></a><span class="co">#Create a subset of significant genes with p-value&lt;0.05 and log2 fold-change &gt;= 2</span></span>
<span id="cb67-127"><a href="viewing-pairwise-sample-clustering.html#cb67-127" tabindex="-1"></a>sigpi <span class="ot">=</span> <span class="fu">which</span>(results_genes[, <span class="st">&quot;pvalue&quot;</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb67-128"><a href="viewing-pairwise-sample-clustering.html#cb67-128" tabindex="-1"></a>sigp <span class="ot">=</span> results_genes[sigpi, ]</span>
<span id="cb67-129"><a href="viewing-pairwise-sample-clustering.html#cb67-129" tabindex="-1"></a>sigfc <span class="ot">=</span> <span class="fu">which</span>(<span class="fu">abs</span>(sigp[, <span class="st">&quot;log2FoldChange&quot;</span>]) <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb67-130"><a href="viewing-pairwise-sample-clustering.html#cb67-130" tabindex="-1"></a>sigDE <span class="ot">=</span> sigp[sigfc, ]</span>
<span id="cb67-131"><a href="viewing-pairwise-sample-clustering.html#cb67-131" tabindex="-1"></a></span>
<span id="cb67-132"><a href="viewing-pairwise-sample-clustering.html#cb67-132" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;UHR_vs_HBR_heatmap.pdf&quot;</span>)</span>
<span id="cb67-133"><a href="viewing-pairwise-sample-clustering.html#cb67-133" tabindex="-1"></a>main_title <span class="ot">=</span> <span class="st">&quot;sig DE Genes&quot;</span></span>
<span id="cb67-134"><a href="viewing-pairwise-sample-clustering.html#cb67-134" tabindex="-1"></a><span class="fu">par</span>(<span class="at">cex.main =</span> <span class="fl">0.8</span>)</span>
<span id="cb67-135"><a href="viewing-pairwise-sample-clustering.html#cb67-135" tabindex="-1"></a>sigDE_genes <span class="ot">=</span> sigDE[, <span class="st">&quot;ensemblID&quot;</span>]</span>
<span id="cb67-136"><a href="viewing-pairwise-sample-clustering.html#cb67-136" tabindex="-1"></a>sigDE_genenames <span class="ot">=</span> sigDE[, <span class="st">&quot;Symbol&quot;</span>]</span>
<span id="cb67-137"><a href="viewing-pairwise-sample-clustering.html#cb67-137" tabindex="-1"></a></span>
<span id="cb67-138"><a href="viewing-pairwise-sample-clustering.html#cb67-138" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">log2</span>(<span class="fu">as.matrix</span>(gene_expression[<span class="fu">as.vector</span>(sigDE_genes), data_columns]) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb67-139"><a href="viewing-pairwise-sample-clustering.html#cb67-139" tabindex="-1"></a><span class="fu">heatmap.2</span>(data, <span class="at">hclustfun =</span> myclust, <span class="at">distfun =</span> mydist, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="st">&quot;none&quot;</span>, <span class="at">dendrogram =</span> <span class="st">&quot;both&quot;</span>, <span class="at">margins =</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">4</span>), <span class="at">Rowv =</span> <span class="cn">TRUE</span>, <span class="at">Colv =</span> <span class="cn">TRUE</span>, <span class="at">symbreaks =</span> <span class="cn">FALSE</span>, <span class="at">key =</span> <span class="cn">TRUE</span>, <span class="at">symkey =</span> <span class="cn">FALSE</span>, <span class="at">density.info =</span> <span class="st">&quot;none&quot;</span>, <span class="at">trace =</span> <span class="st">&quot;none&quot;</span>, <span class="at">main =</span> main_title, <span class="at">cexRow =</span> <span class="fl">0.3</span>, <span class="at">cexCol =</span> <span class="dv">1</span>, <span class="at">labRow =</span> sigDE_genenames, <span class="at">col =</span> <span class="fu">rev</span>(<span class="fu">heat.colors</span>(<span class="dv">75</span>)))</span>
<span id="cb67-140"><a href="viewing-pairwise-sample-clustering.html#cb67-140" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-141"><a href="viewing-pairwise-sample-clustering.html#cb67-141" tabindex="-1"></a></span>
<span id="cb67-142"><a href="viewing-pairwise-sample-clustering.html#cb67-142" tabindex="-1"></a><span class="do">#### Plot #9 - Volcano plot</span></span>
<span id="cb67-143"><a href="viewing-pairwise-sample-clustering.html#cb67-143" tabindex="-1"></a></span>
<span id="cb67-144"><a href="viewing-pairwise-sample-clustering.html#cb67-144" tabindex="-1"></a><span class="co"># Set differential expression status for each gene - default all genes to &quot;no change&quot;</span></span>
<span id="cb67-145"><a href="viewing-pairwise-sample-clustering.html#cb67-145" tabindex="-1"></a>results_genes<span class="sc">$</span>diffexpressed <span class="ot">=</span> <span class="st">&quot;No&quot;</span></span>
<span id="cb67-146"><a href="viewing-pairwise-sample-clustering.html#cb67-146" tabindex="-1"></a></span>
<span id="cb67-147"><a href="viewing-pairwise-sample-clustering.html#cb67-147" tabindex="-1"></a><span class="co"># if log2Foldchange &gt; 2 and pvalue &lt; 0.05, set as &quot;Up regulated&quot;</span></span>
<span id="cb67-148"><a href="viewing-pairwise-sample-clustering.html#cb67-148" tabindex="-1"></a>results_genes<span class="sc">$</span>diffexpressed[results_genes<span class="sc">$</span>log2FoldChange <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;</span> results_genes<span class="sc">$</span>pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>] <span class="ot">=</span> <span class="st">&quot;Higher in UHR&quot;</span></span>
<span id="cb67-149"><a href="viewing-pairwise-sample-clustering.html#cb67-149" tabindex="-1"></a></span>
<span id="cb67-150"><a href="viewing-pairwise-sample-clustering.html#cb67-150" tabindex="-1"></a><span class="co"># if log2Foldchange &lt; -2 and pvalue &lt; 0.05, set as &quot;Down regulated&quot;</span></span>
<span id="cb67-151"><a href="viewing-pairwise-sample-clustering.html#cb67-151" tabindex="-1"></a>results_genes<span class="sc">$</span>diffexpressed[results_genes<span class="sc">$</span>log2FoldChange <span class="sc">&lt;=</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">&amp;</span> results_genes<span class="sc">$</span>pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>] <span class="ot">=</span> <span class="st">&quot;Higher in HBR&quot;</span></span>
<span id="cb67-152"><a href="viewing-pairwise-sample-clustering.html#cb67-152" tabindex="-1"></a></span>
<span id="cb67-153"><a href="viewing-pairwise-sample-clustering.html#cb67-153" tabindex="-1"></a><span class="co"># write the gene names of those significantly upregulated/downregulated to a new column</span></span>
<span id="cb67-154"><a href="viewing-pairwise-sample-clustering.html#cb67-154" tabindex="-1"></a>results_genes<span class="sc">$</span>gene_label <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb67-155"><a href="viewing-pairwise-sample-clustering.html#cb67-155" tabindex="-1"></a>results_genes<span class="sc">$</span>gene_label[results_genes<span class="sc">$</span>diffexpressed <span class="sc">!=</span> <span class="st">&quot;No&quot;</span>] <span class="ot">=</span> results_genes<span class="sc">$</span>Symbol[results_genes<span class="sc">$</span>diffexpressed <span class="sc">!=</span> <span class="st">&quot;No&quot;</span>]</span>
<span id="cb67-156"><a href="viewing-pairwise-sample-clustering.html#cb67-156" tabindex="-1"></a></span>
<span id="cb67-157"><a href="viewing-pairwise-sample-clustering.html#cb67-157" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;UHR_vs_HBR_volcano.pdf&quot;</span>)</span>
<span id="cb67-158"><a href="viewing-pairwise-sample-clustering.html#cb67-158" tabindex="-1"></a></span>
<span id="cb67-159"><a href="viewing-pairwise-sample-clustering.html#cb67-159" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> results_genes[results_genes<span class="sc">$</span>diffexpressed <span class="sc">!=</span> <span class="st">&quot;No&quot;</span>,], <span class="fu">aes</span>(<span class="at">x =</span> log2FoldChange, <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(pvalue), <span class="at">label =</span> gene_label, <span class="at">color =</span> diffexpressed)) <span class="sc">+</span></span>
<span id="cb67-160"><a href="viewing-pairwise-sample-clustering.html#cb67-160" tabindex="-1"></a>             <span class="fu">xlab</span>(<span class="st">&quot;log2Foldchange&quot;</span>) <span class="sc">+</span></span>
<span id="cb67-161"><a href="viewing-pairwise-sample-clustering.html#cb67-161" tabindex="-1"></a>             <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&quot;Differentially expressed&quot;</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span></span>
<span id="cb67-162"><a href="viewing-pairwise-sample-clustering.html#cb67-162" tabindex="-1"></a>             <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb67-163"><a href="viewing-pairwise-sample-clustering.html#cb67-163" tabindex="-1"></a>             <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb67-164"><a href="viewing-pairwise-sample-clustering.html#cb67-164" tabindex="-1"></a>             <span class="fu">geom_text_repel</span>() <span class="sc">+</span></span>
<span id="cb67-165"><a href="viewing-pairwise-sample-clustering.html#cb67-165" tabindex="-1"></a>             <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.6</span>, <span class="fl">0.6</span>), <span class="at">col =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb67-166"><a href="viewing-pairwise-sample-clustering.html#cb67-166" tabindex="-1"></a>             <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>), <span class="at">col =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb67-167"><a href="viewing-pairwise-sample-clustering.html#cb67-167" tabindex="-1"></a>             <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size=</span><span class="dv">5</span>))) <span class="sc">+</span></span>
<span id="cb67-168"><a href="viewing-pairwise-sample-clustering.html#cb67-168" tabindex="-1"></a>             <span class="fu">geom_point</span>(<span class="at">data =</span> results_genes[results_genes<span class="sc">$</span>diffexpressed <span class="sc">==</span> <span class="st">&quot;No&quot;</span>,], <span class="fu">aes</span>(<span class="at">x =</span> log2FoldChange, <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(pvalue)), <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb67-169"><a href="viewing-pairwise-sample-clustering.html#cb67-169" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb67-170"><a href="viewing-pairwise-sample-clustering.html#cb67-170" tabindex="-1"></a></span>
<span id="cb67-171"><a href="viewing-pairwise-sample-clustering.html#cb67-171" tabindex="-1"></a><span class="co">#To exit R type:</span></span>
<span id="cb67-172"><a href="viewing-pairwise-sample-clustering.html#cb67-172" tabindex="-1"></a><span class="fu">quit</span>(<span class="at">save =</span> <span class="st">&quot;no&quot;</span>)</span></code></pre></div>
<p>The output file can be viewed in your browser at the following url. Note, you must replace <strong>YOUR_PUBLIC_IPv4_ADDRESS</strong> with your own amazon instance IP (e.g., 101.0.1.101)).</p>
<ul>
<li><a href="http://" class="uri">http://</a><strong>YOUR_PUBLIC_IPv4_ADDRESS</strong>/rnaseq/de/ballgown/ref_only/Tutorial_Part3_Supplementary_R_output.pdf</li>
</ul>
</div>
<div id="visual-comparison-of-example-genes-from-the-volcano-plot" class="section level3 hasAnchor">
<h3>Visual comparison of example genes from the volcano plot<a href="viewing-pairwise-sample-clustering.html#visual-comparison-of-example-genes-from-the-volcano-plot" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One can manually explore interesting looking genes from the volcano plot. In this case our analysis involves comparison of RNA isolated from tissues of different types (HBR -&gt; brain tissue, UHR -&gt; a collection of cancer cell lines). So, in this analysis it might make sense to explore candidates in a tissue expression atlas such as <a href="https://www.gtexportal.org/">GTEX</a>.</p>
<p>Looking at our gene plot, two example genes we could look at are: SEPT3 (significantly higher in HBR) and PRAME (significantly higher in UHR).</p>
<p><em>Expression of SEPT3 across tissues according to GTEX</em>
<img src="assets/module_3/SEPT3.png" alt="SEPT3" />
Note that this gene appears to be highly expressed in brain tissues.</p>
<p><em>Expression of PRAME across tissues according to GTEX</em>
<img src="assets/module_3/PRAME.png" alt="PRAME" />
Note that this gene appears to be almost uniquely expressed in testis tissue. Since one of the cell lines in the UHR sample is a testicular cancer cell line, this makes sense.</p>
<hr />
</div>
<div id="practical-exercise-10-advanced" class="section level3 hasAnchor">
<h3>PRACTICAL EXERCISE 10 (ADVANCED)<a href="viewing-pairwise-sample-clustering.html#practical-exercise-10-advanced" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Assignment: Use R to create a volcano plot for the differentially expressed genes you identified with Ballgown in Practical Exercise 9.</p>
<ul>
<li>Hint: Follow the example R code above.</li>
<li>Hint: You could import the ballgown data object (e.g., <code>bg.rda</code>) that you should have saved in Practical Exercise 9 as a source of DE results.</li>
</ul>
<p>Solution: When you are ready you can check your approach against the <a href="/module-09-appendix/0009/05/01/Practical_Exercise_Solutions/#practical-exercise-10---volcano-plot">Solutions</a></p>
<hr />
<p>In this section we will use the GAGE tool in R to test for significantly enriched sets of genes within those genes found to be significantly “up” and “down” in our UHR vs HBR differential gene expression analysis. Do we see enrichment for genes associated with brain related cell types and processes in the list of DE genes that have significant differential expression beween the UHR samples compared to the HBR samples?</p>
</div>
<div id="what-is-gage" class="section level3 hasAnchor">
<h3>What is gage?<a href="viewing-pairwise-sample-clustering.html#what-is-gage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Generally Applicable Gene-set Enrichment tool (<a href="https://bioconductor.org/packages/release/bioc/html/gage.html">GAGE</a>) is a popular bioconductor package used to perform gene-set enrichment and pathway analysis. The package works independent of sample sizes, experimental designs, assay platforms, and is applicable to both microarray and RNAseq data sets. In this section we will use <a href="https://bioconductor.org/packages/release/bioc/html/gage.html">GAGE</a> and gene sets from the “Gene Ontology” (<a href="http://www.geneontology.org/">GO</a>) and the <a href="https://www.gsea-msigdb.org/gsea/msigdb">MSigDB</a> databases to perform pathway analysis.</p>
<p>Now, we will start a docker session to run the analysis in this section</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="viewing-pairwise-sample-clustering.html#cb68-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-it</span> <span class="at">-v</span> /home/ubuntu/workspace:/workspace cnithin7/bioc-custom:1.0 /bin/bash</span></code></pre></div>
<p>Launch R at the commandline, start RStudio, or launch a posit Cloud session:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="viewing-pairwise-sample-clustering.html#cb69-1" tabindex="-1"></a><span class="ex">R</span></span></code></pre></div>
</div>
<div id="importing-de-results-for-gage" class="section level3 hasAnchor">
<h3>Importing DE results for gage<a href="viewing-pairwise-sample-clustering.html#importing-de-results-for-gage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before we perform the pathway analysis we need to read in our differential expression results from the previous DE analysis.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="viewing-pairwise-sample-clustering.html#cb70-1" tabindex="-1"></a></span>
<span id="cb70-2"><a href="viewing-pairwise-sample-clustering.html#cb70-2" tabindex="-1"></a><span class="co"># Define working dir paths and load in data</span></span>
<span id="cb70-3"><a href="viewing-pairwise-sample-clustering.html#cb70-3" tabindex="-1"></a>datadir <span class="ot">=</span> <span class="st">&quot;/workspace/rnaseq/de/deseq2&quot;</span></span>
<span id="cb70-4"><a href="viewing-pairwise-sample-clustering.html#cb70-4" tabindex="-1"></a><span class="co">#datadir = &quot;/cloud/project/outdir/&quot;</span></span>
<span id="cb70-5"><a href="viewing-pairwise-sample-clustering.html#cb70-5" tabindex="-1"></a></span>
<span id="cb70-6"><a href="viewing-pairwise-sample-clustering.html#cb70-6" tabindex="-1"></a><span class="fu">setwd</span>(datadir)</span>
<span id="cb70-7"><a href="viewing-pairwise-sample-clustering.html#cb70-7" tabindex="-1"></a></span>
<span id="cb70-8"><a href="viewing-pairwise-sample-clustering.html#cb70-8" tabindex="-1"></a><span class="co"># Load in the DE results file with only significant genes (e.g., http://genomedata.org/cri-workshop/deseq2/DE_sig_genes_DESeq2.tsv)</span></span>
<span id="cb70-9"><a href="viewing-pairwise-sample-clustering.html#cb70-9" tabindex="-1"></a>DE_genes <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">&quot;DE_sig_genes_DESeq2.tsv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb70-10"><a href="viewing-pairwise-sample-clustering.html#cb70-10" tabindex="-1"></a></span>
<span id="cb70-11"><a href="viewing-pairwise-sample-clustering.html#cb70-11" tabindex="-1"></a>output_dir <span class="ot">=</span> <span class="st">&quot;/workspace/rnaseq/de/deseq2/pathway/&quot;</span></span>
<span id="cb70-12"><a href="viewing-pairwise-sample-clustering.html#cb70-12" tabindex="-1"></a><span class="co">#output_dir = &quot;/cloud/project/outdir/pathway/&quot;</span></span>
<span id="cb70-13"><a href="viewing-pairwise-sample-clustering.html#cb70-13" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(output_dir)) {</span>
<span id="cb70-14"><a href="viewing-pairwise-sample-clustering.html#cb70-14" tabindex="-1"></a>  <span class="fu">dir.create</span>(output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-15"><a href="viewing-pairwise-sample-clustering.html#cb70-15" tabindex="-1"></a>}</span>
<span id="cb70-16"><a href="viewing-pairwise-sample-clustering.html#cb70-16" tabindex="-1"></a></span>
<span id="cb70-17"><a href="viewing-pairwise-sample-clustering.html#cb70-17" tabindex="-1"></a><span class="fu">setwd</span>(output_dir)</span></code></pre></div>
<p>Now let’s go ahead and load <a href="https://bioconductor.org/packages/release/bioc/html/gage.html">GAGE</a> and some other useful packages.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="viewing-pairwise-sample-clustering.html#cb71-1" tabindex="-1"></a><span class="fu">library</span>(AnnotationDbi)</span>
<span id="cb71-2"><a href="viewing-pairwise-sample-clustering.html#cb71-2" tabindex="-1"></a><span class="fu">library</span>(org.Hs.eg.db)</span>
<span id="cb71-3"><a href="viewing-pairwise-sample-clustering.html#cb71-3" tabindex="-1"></a><span class="fu">library</span>(GO.db)</span>
<span id="cb71-4"><a href="viewing-pairwise-sample-clustering.html#cb71-4" tabindex="-1"></a><span class="fu">library</span>(gage)</span></code></pre></div>
</div>
<div id="setting-up-gene-set-databases" class="section level3 hasAnchor">
<h3>Setting up gene set databases<a href="viewing-pairwise-sample-clustering.html#setting-up-gene-set-databases" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In order to perform our pathway analysis we need a list of pathways and their respective genes. There are many databases that contain collections of genes (or gene sets) that can be used to understand whether a set of mutated or differentially expressed genes are functionally related. Some of these resources include: <a href="http://www.geneontology.org/">GO</a>, <a href="https://www.kegg.jp">KEGG</a>, <a href="https://www.gsea-msigdb.org/gsea/msigdb">MSigDB</a>, and <a href="https://www.wikipathways.org/index.php/WikiPathways">WikiPathways</a>. For this exercise we are going to investigate <a href="http://www.geneontology.org/">GO</a> and <a href="https://www.gsea-msigdb.org/gsea/msigdb">MSigDB</a>. The <a href="https://bioconductor.org/packages/release/bioc/html/gage.html">GAGE</a> package has a function for querying <a href="http://www.geneontology.org/">GO</a> in real time: <a href="https://www.rdocumentation.org/packages/gage/versions/2.22.0/topics/go.gsets">go.gsets()</a>. This function takes a species as an argument and will return a list of gene sets and some helpful meta information for subsetting these lists. If you are unfamiliar with <a href="http://www.geneontology.org/">GO</a>, it is helpful to know that GO terms are categorized into three gene ontologies: “Biological Process”, “Molecular Function”, and “Cellular Component”. This information will come in handy later in our exercise. GAGE does not provide a similar tool to investigate the gene sets available in MSigDB. Fortunately, MSigDB provides a download-able <code>.gmt</code> file for all gene sets. This format is easily read into GAGE using a function called <a href="https://www.rdocumentation.org/packages/gage/versions/2.22.0/topics/readList">readList()</a>. If you check out <a href="https://www.gsea-msigdb.org/gsea/msigdb">MSigDB</a> you will see that there are 8 unique gene set collections, each with slightly different features. For this exercise we will use the <a href="https://www.gsea-msigdb.org/gsea/msigdb/collection_details.jsp#C8">C8 - cell type signature gene sets collection</a>, which is a collection of gene sets that contain cluster markers for cell types identified from single-cell sequencing studies of human tissue.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="viewing-pairwise-sample-clustering.html#cb72-1" tabindex="-1"></a><span class="co"># Set up go database</span></span>
<span id="cb72-2"><a href="viewing-pairwise-sample-clustering.html#cb72-2" tabindex="-1"></a>go.hs <span class="ot">=</span> <span class="fu">go.gsets</span>(<span class="at">species =</span> <span class="st">&quot;human&quot;</span>)</span>
<span id="cb72-3"><a href="viewing-pairwise-sample-clustering.html#cb72-3" tabindex="-1"></a>go.bp.gs <span class="ot">=</span> go.hs<span class="sc">$</span>go.sets[go.hs<span class="sc">$</span>go.subs<span class="sc">$</span>BP]</span>
<span id="cb72-4"><a href="viewing-pairwise-sample-clustering.html#cb72-4" tabindex="-1"></a>go.mf.gs <span class="ot">=</span> go.hs<span class="sc">$</span>go.sets[go.hs<span class="sc">$</span>go.subs<span class="sc">$</span>MF]</span>
<span id="cb72-5"><a href="viewing-pairwise-sample-clustering.html#cb72-5" tabindex="-1"></a>go.cc.gs <span class="ot">=</span> go.hs<span class="sc">$</span>go.sets[go.hs<span class="sc">$</span>go.subs<span class="sc">$</span>CC]</span>
<span id="cb72-6"><a href="viewing-pairwise-sample-clustering.html#cb72-6" tabindex="-1"></a></span>
<span id="cb72-7"><a href="viewing-pairwise-sample-clustering.html#cb72-7" tabindex="-1"></a><span class="co"># Here we will read in an MSigDB gene set that was selected for this exercise and saved to the course website. </span></span>
<span id="cb72-8"><a href="viewing-pairwise-sample-clustering.html#cb72-8" tabindex="-1"></a>c8 <span class="ot">=</span> <span class="st">&quot;http://genomedata.org/rnaseq-tutorial/c8.all.v7.2.entrez.gmt&quot;</span></span>
<span id="cb72-9"><a href="viewing-pairwise-sample-clustering.html#cb72-9" tabindex="-1"></a>all_cell_types <span class="ot">=</span> <span class="fu">readList</span>(c8)</span></code></pre></div>
</div>
<div id="annotating-genes" class="section level3 hasAnchor">
<h3>Annotating genes<a href="viewing-pairwise-sample-clustering.html#annotating-genes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>OK, so we have our differentially expressed genes and we have our gene sets. However, if you look at one of the objects containing the gene sets you’ll notice that each gene set contains a series of integers. These integers are <a href="https://www.ncbi.nlm.nih.gov/gquery/">Entrez</a> gene identifiers. But do we have comparable information in our DE gene list? Right now, no. Our previous results use Ensembl IDs as gene identifiers. We will need to convert our gene identifiers to the format used in the GO and MSigDB gene sets before we can perform the pathway analysis. Fortunately, Bioconductor maintains genome wide annotation data for many species, you can view these species with the <a href="https://bioconductor.org/packages/release/BiocViews.html#___OrgDb">OrgDb bioc view</a>. This makes converting the gene identifiers relatively straightforward, below we use the <a href="https://www.rdocumentation.org/packages/OrganismDbi/versions/1.14.1/topics/MultiDb-class">mapIds()</a> function to query the OrganismDb object for the Entrez id based on the Ensembl id. Because there might not be a one-to-one relationship with these identifiers we also use <code>multiVals="first"</code> to specify that only the first identifier should be returned. Another option would be to use <code>multiVals="asNA"</code> to ignore one-to-many mappings.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="viewing-pairwise-sample-clustering.html#cb73-1" tabindex="-1"></a>DE_genes<span class="sc">$</span>entrez <span class="ot">=</span> <span class="fu">mapIds</span>(org.Hs.eg.db, <span class="at">column =</span> <span class="st">&quot;ENTREZID&quot;</span>, <span class="at">keys =</span> DE_genes<span class="sc">$</span>ensemblID, <span class="at">keytype =</span> <span class="st">&quot;ENSEMBL&quot;</span>, <span class="at">multiVals =</span> <span class="st">&quot;first&quot;</span>)</span></code></pre></div>
</div>
<div id="some-clean-up-and-identifier-mapping" class="section level3 hasAnchor">
<h3>Some clean-up and identifier mapping<a href="viewing-pairwise-sample-clustering.html#some-clean-up-and-identifier-mapping" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After completing the annotation above you will notice that some of our Ensembl gene IDs were not mapped to an Entrez gene ID. Why did this happen? Well, this is actually a complicated point and gets at some nuanced concepts of how to define and annotate a gene. The short answer is that we are using two different resources that have annotated the human genome and there are some differences in how these resources have completed this task. Therefore, it is expected that there are some discrepencies. In the next few steps we will clean up what we can by first removing the ERCC spike-in genes and then will use a different identifier for futher mapping.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="viewing-pairwise-sample-clustering.html#cb74-1" tabindex="-1"></a><span class="co">#Remove spike-in</span></span>
<span id="cb74-2"><a href="viewing-pairwise-sample-clustering.html#cb74-2" tabindex="-1"></a>DE_genes_clean <span class="ot">=</span> DE_genes[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&quot;ERCC&quot;</span>, DE_genes<span class="sc">$</span>ensemblID), ]</span>
<span id="cb74-3"><a href="viewing-pairwise-sample-clustering.html#cb74-3" tabindex="-1"></a></span>
<span id="cb74-4"><a href="viewing-pairwise-sample-clustering.html#cb74-4" tabindex="-1"></a><span class="do">##Just so we know what we have removed </span></span>
<span id="cb74-5"><a href="viewing-pairwise-sample-clustering.html#cb74-5" tabindex="-1"></a>ERCC_gene_count <span class="ot">=</span> <span class="fu">nrow</span>(DE_genes[<span class="fu">grepl</span>(<span class="st">&quot;ERCC&quot;</span>, DE_genes<span class="sc">$</span>ensemblID), ])</span>
<span id="cb74-6"><a href="viewing-pairwise-sample-clustering.html#cb74-6" tabindex="-1"></a>ERCC_gene_count</span>
<span id="cb74-7"><a href="viewing-pairwise-sample-clustering.html#cb74-7" tabindex="-1"></a></span>
<span id="cb74-8"><a href="viewing-pairwise-sample-clustering.html#cb74-8" tabindex="-1"></a><span class="do">###Deal with genes that we do not have an Entrez ID for </span></span>
<span id="cb74-9"><a href="viewing-pairwise-sample-clustering.html#cb74-9" tabindex="-1"></a>missing_ensembl_key <span class="ot">=</span> DE_genes_clean[<span class="fu">is.na</span>(DE_genes_clean<span class="sc">$</span>entrez), ]</span>
<span id="cb74-10"><a href="viewing-pairwise-sample-clustering.html#cb74-10" tabindex="-1"></a>DE_genes_clean <span class="ot">=</span> DE_genes_clean[<span class="sc">!</span>DE_genes_clean<span class="sc">$</span>ensemblID <span class="sc">%in%</span> missing_ensembl_key<span class="sc">$</span>ensemblID, ]</span>
<span id="cb74-11"><a href="viewing-pairwise-sample-clustering.html#cb74-11" tabindex="-1"></a></span>
<span id="cb74-12"><a href="viewing-pairwise-sample-clustering.html#cb74-12" tabindex="-1"></a><span class="do">###Try mapping using a different key</span></span>
<span id="cb74-13"><a href="viewing-pairwise-sample-clustering.html#cb74-13" tabindex="-1"></a>missing_ensembl_key<span class="sc">$</span>entrez <span class="ot">=</span> <span class="fu">mapIds</span>(org.Hs.eg.db, <span class="at">column =</span> <span class="st">&quot;ENTREZID&quot;</span>, <span class="at">keys =</span> missing_ensembl_key<span class="sc">$</span>Symbol, <span class="at">keytype =</span> <span class="st">&quot;SYMBOL&quot;</span>, <span class="at">multiVal =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb74-14"><a href="viewing-pairwise-sample-clustering.html#cb74-14" tabindex="-1"></a></span>
<span id="cb74-15"><a href="viewing-pairwise-sample-clustering.html#cb74-15" tabindex="-1"></a><span class="co">#Remove remaining genes </span></span>
<span id="cb74-16"><a href="viewing-pairwise-sample-clustering.html#cb74-16" tabindex="-1"></a>missing_ensembl_key_update <span class="ot">=</span> missing_ensembl_key[<span class="sc">!</span><span class="fu">is.na</span>(missing_ensembl_key<span class="sc">$</span>entrez),]</span>
<span id="cb74-17"><a href="viewing-pairwise-sample-clustering.html#cb74-17" tabindex="-1"></a></span>
<span id="cb74-18"><a href="viewing-pairwise-sample-clustering.html#cb74-18" tabindex="-1"></a><span class="co">#Create a Final Gene list of all genes where we were able to find an Entrez ID (using two approaches)</span></span>
<span id="cb74-19"><a href="viewing-pairwise-sample-clustering.html#cb74-19" tabindex="-1"></a>DE_genes_clean <span class="ot">=</span> <span class="fu">rbind</span>(DE_genes_clean, missing_ensembl_key_update)</span>
<span id="cb74-20"><a href="viewing-pairwise-sample-clustering.html#cb74-20" tabindex="-1"></a></span>
<span id="cb74-21"><a href="viewing-pairwise-sample-clustering.html#cb74-21" tabindex="-1"></a><span class="co">#Reduce to only the unique set of entrez genes in case different genes were mapped to the same entrez ID using the two approaches</span></span>
<span id="cb74-22"><a href="viewing-pairwise-sample-clustering.html#cb74-22" tabindex="-1"></a>DE_genes_clean<span class="ot">=</span>DE_genes_clean[<span class="sc">!</span><span class="fu">duplicated</span>(DE_genes_clean<span class="sc">$</span>entrez),]</span></code></pre></div>
</div>
<div id="final-preparation-of-deseq2-results-for-gage" class="section level3 hasAnchor">
<h3>Final preparation of DESeq2 results for gage<a href="viewing-pairwise-sample-clustering.html#final-preparation-of-deseq2-results-for-gage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>OK, last step. Let’s format the differential expression results into a format suitable for the <a href="">GAGE</a> package. Basically this means obtaining the log2 fold change values and assigning entrez gene identifiers to these values.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="viewing-pairwise-sample-clustering.html#cb75-1" tabindex="-1"></a><span class="co"># grab the log fold changes for everything</span></span>
<span id="cb75-2"><a href="viewing-pairwise-sample-clustering.html#cb75-2" tabindex="-1"></a>De_gene.fc <span class="ot">=</span> DE_genes_clean<span class="sc">$</span>log2FoldChange</span>
<span id="cb75-3"><a href="viewing-pairwise-sample-clustering.html#cb75-3" tabindex="-1"></a></span>
<span id="cb75-4"><a href="viewing-pairwise-sample-clustering.html#cb75-4" tabindex="-1"></a><span class="co"># set the name for each row to be the Entrez Gene ID</span></span>
<span id="cb75-5"><a href="viewing-pairwise-sample-clustering.html#cb75-5" tabindex="-1"></a><span class="fu">names</span>(De_gene.fc) <span class="ot">=</span> DE_genes_clean<span class="sc">$</span>entrez</span></code></pre></div>
</div>
<div id="running-pathway-analysis" class="section level3 hasAnchor">
<h3>Running pathway analysis<a href="viewing-pairwise-sample-clustering.html#running-pathway-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can now use the <a href="https://www.rdocumentation.org/packages/gage/versions/2.22.0/topics/gage">gage()</a> function to obtain the significantly perturbed pathways from our differential expression experiment.</p>
<p>Note on the abbreviations below: “bp” refers to biological process, “mf” refers to molecular function, and “cc” refers to cellular process. These are the three main categories of gene ontology terms/annotations that were mentioned above.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="viewing-pairwise-sample-clustering.html#cb76-1" tabindex="-1"></a><span class="co">#Run GAGE</span></span>
<span id="cb76-2"><a href="viewing-pairwise-sample-clustering.html#cb76-2" tabindex="-1"></a><span class="co">#go </span></span>
<span id="cb76-3"><a href="viewing-pairwise-sample-clustering.html#cb76-3" tabindex="-1"></a>fc.go.bp.p <span class="ot">=</span> <span class="fu">gage</span>(De_gene.fc, <span class="at">gsets =</span> go.bp.gs)</span>
<span id="cb76-4"><a href="viewing-pairwise-sample-clustering.html#cb76-4" tabindex="-1"></a>fc.go.mf.p <span class="ot">=</span> <span class="fu">gage</span>(De_gene.fc, <span class="at">gsets =</span> go.mf.gs)</span>
<span id="cb76-5"><a href="viewing-pairwise-sample-clustering.html#cb76-5" tabindex="-1"></a>fc.go.cc.p <span class="ot">=</span> <span class="fu">gage</span>(De_gene.fc, <span class="at">gsets =</span> go.cc.gs)</span>
<span id="cb76-6"><a href="viewing-pairwise-sample-clustering.html#cb76-6" tabindex="-1"></a></span>
<span id="cb76-7"><a href="viewing-pairwise-sample-clustering.html#cb76-7" tabindex="-1"></a><span class="co">#msigdb</span></span>
<span id="cb76-8"><a href="viewing-pairwise-sample-clustering.html#cb76-8" tabindex="-1"></a>fc.c8.p <span class="ot">=</span> <span class="fu">gage</span>(De_gene.fc, <span class="at">gsets =</span> all_cell_types)</span>
<span id="cb76-9"><a href="viewing-pairwise-sample-clustering.html#cb76-9" tabindex="-1"></a></span>
<span id="cb76-10"><a href="viewing-pairwise-sample-clustering.html#cb76-10" tabindex="-1"></a><span class="do">###Convert to dataframes </span></span>
<span id="cb76-11"><a href="viewing-pairwise-sample-clustering.html#cb76-11" tabindex="-1"></a><span class="co">#Results for testing for GO terms which are up-regulated</span></span>
<span id="cb76-12"><a href="viewing-pairwise-sample-clustering.html#cb76-12" tabindex="-1"></a>fc.go.bp.p.up <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.go.bp.p<span class="sc">$</span>greater)</span>
<span id="cb76-13"><a href="viewing-pairwise-sample-clustering.html#cb76-13" tabindex="-1"></a>fc.go.mf.p.up <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.go.mf.p<span class="sc">$</span>greater)</span>
<span id="cb76-14"><a href="viewing-pairwise-sample-clustering.html#cb76-14" tabindex="-1"></a>fc.go.cc.p.up <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.go.cc.p<span class="sc">$</span>greater)</span>
<span id="cb76-15"><a href="viewing-pairwise-sample-clustering.html#cb76-15" tabindex="-1"></a></span>
<span id="cb76-16"><a href="viewing-pairwise-sample-clustering.html#cb76-16" tabindex="-1"></a><span class="co">#Results for testing for GO terms which are down-regulated</span></span>
<span id="cb76-17"><a href="viewing-pairwise-sample-clustering.html#cb76-17" tabindex="-1"></a>fc.go.bp.p.down <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.go.bp.p<span class="sc">$</span>less)</span>
<span id="cb76-18"><a href="viewing-pairwise-sample-clustering.html#cb76-18" tabindex="-1"></a>fc.go.mf.p.down <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.go.mf.p<span class="sc">$</span>less)</span>
<span id="cb76-19"><a href="viewing-pairwise-sample-clustering.html#cb76-19" tabindex="-1"></a>fc.go.cc.p.down <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.go.cc.p<span class="sc">$</span>less)</span>
<span id="cb76-20"><a href="viewing-pairwise-sample-clustering.html#cb76-20" tabindex="-1"></a></span>
<span id="cb76-21"><a href="viewing-pairwise-sample-clustering.html#cb76-21" tabindex="-1"></a><span class="co">#Results for testing for MSigDB C8 gene sets which are up-regulated</span></span>
<span id="cb76-22"><a href="viewing-pairwise-sample-clustering.html#cb76-22" tabindex="-1"></a>fc.c8.p.up <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.c8.p<span class="sc">$</span>greater)</span>
<span id="cb76-23"><a href="viewing-pairwise-sample-clustering.html#cb76-23" tabindex="-1"></a></span>
<span id="cb76-24"><a href="viewing-pairwise-sample-clustering.html#cb76-24" tabindex="-1"></a><span class="co">#Results for testing for MSigDB C8 gene sets which are down-regulated</span></span>
<span id="cb76-25"><a href="viewing-pairwise-sample-clustering.html#cb76-25" tabindex="-1"></a>fc.c8.p.down <span class="ot">=</span> <span class="fu">as.data.frame</span>(fc.c8.p<span class="sc">$</span>less)</span></code></pre></div>
</div>
<div id="explore-significant-results" class="section level3 hasAnchor">
<h3>Explore significant results<a href="viewing-pairwise-sample-clustering.html#explore-significant-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Alright, now we have results with accompanying p-values (yay!).</p>
<p>What does “up-” or “down-regulated” mean here, in the context of our UHR vs HBR comparison? It may help to open and review the data in your DE_genes_DESeq2.tsv file.</p>
<p>Look at the cellular process results from our GO analysis. Do the results match your expectation?</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="viewing-pairwise-sample-clustering.html#cb77-1" tabindex="-1"></a></span>
<span id="cb77-2"><a href="viewing-pairwise-sample-clustering.html#cb77-2" tabindex="-1"></a><span class="co">#Try doing something like this to find some significant results:</span></span>
<span id="cb77-3"><a href="viewing-pairwise-sample-clustering.html#cb77-3" tabindex="-1"></a><span class="co">#View the top 20 significantly up- or down-regulated GO terms from the Cellular Component Ontology</span></span>
<span id="cb77-4"><a href="viewing-pairwise-sample-clustering.html#cb77-4" tabindex="-1"></a><span class="fu">head</span>(fc.go.cc.p.up[<span class="fu">order</span>(fc.go.cc.p.up<span class="sc">$</span>p.val),], <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb77-5"><a href="viewing-pairwise-sample-clustering.html#cb77-5" tabindex="-1"></a><span class="fu">head</span>(fc.go.cc.p.down[<span class="fu">order</span>(fc.go.cc.p.down<span class="sc">$</span>p.val),], <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb77-6"><a href="viewing-pairwise-sample-clustering.html#cb77-6" tabindex="-1"></a></span>
<span id="cb77-7"><a href="viewing-pairwise-sample-clustering.html#cb77-7" tabindex="-1"></a><span class="co">#You can do the same thing with your results from MSigDB</span></span>
<span id="cb77-8"><a href="viewing-pairwise-sample-clustering.html#cb77-8" tabindex="-1"></a><span class="fu">head</span>(fc.c8.p.up)</span>
<span id="cb77-9"><a href="viewing-pairwise-sample-clustering.html#cb77-9" tabindex="-1"></a><span class="fu">head</span>(fc.c8.p.down)</span>
<span id="cb77-10"><a href="viewing-pairwise-sample-clustering.html#cb77-10" tabindex="-1"></a></span>
<span id="cb77-11"><a href="viewing-pairwise-sample-clustering.html#cb77-11" tabindex="-1"></a><span class="co">#What if we want to know which specific genes from our DE gene result were found in a specific significant pathway?</span></span>
<span id="cb77-12"><a href="viewing-pairwise-sample-clustering.html#cb77-12" tabindex="-1"></a><span class="co">#For example, one significant pathway from fc.go.cc.p.down was &quot;GO:0045202 synapse&quot; with set.size = 22 genes.</span></span>
<span id="cb77-13"><a href="viewing-pairwise-sample-clustering.html#cb77-13" tabindex="-1"></a><span class="co">#Let&#39;s extract the postsynapse DE gene results</span></span>
<span id="cb77-14"><a href="viewing-pairwise-sample-clustering.html#cb77-14" tabindex="-1"></a>synapse <span class="ot">=</span> DE_genes_clean[<span class="fu">which</span>(DE_genes_clean<span class="sc">$</span>entrez <span class="sc">%in%</span> go.cc.gs<span class="sc">$</span><span class="st">`</span><span class="at">GO:0045202 synapse</span><span class="st">`</span>),]</span>
<span id="cb77-15"><a href="viewing-pairwise-sample-clustering.html#cb77-15" tabindex="-1"></a></span>
<span id="cb77-16"><a href="viewing-pairwise-sample-clustering.html#cb77-16" tabindex="-1"></a><span class="co">#How many total synapse genes are there in GO? How many total DE genes? How many overlap?</span></span>
<span id="cb77-17"><a href="viewing-pairwise-sample-clustering.html#cb77-17" tabindex="-1"></a><span class="fu">length</span>(go.cc.gs<span class="sc">$</span><span class="st">`</span><span class="at">GO:0045202 synapse</span><span class="st">`</span>)</span>
<span id="cb77-18"><a href="viewing-pairwise-sample-clustering.html#cb77-18" tabindex="-1"></a><span class="fu">length</span>(DE_genes_clean<span class="sc">$</span>entrez)</span>
<span id="cb77-19"><a href="viewing-pairwise-sample-clustering.html#cb77-19" tabindex="-1"></a><span class="fu">length</span>(synapse<span class="sc">$</span>entrez)</span>
<span id="cb77-20"><a href="viewing-pairwise-sample-clustering.html#cb77-20" tabindex="-1"></a></span>
<span id="cb77-21"><a href="viewing-pairwise-sample-clustering.html#cb77-21" tabindex="-1"></a><span class="co">#Are the synapse DE genes consistently down-regulated? Let&#39;s print out a subset of columns from the DE result for synapse genes</span></span>
<span id="cb77-22"><a href="viewing-pairwise-sample-clustering.html#cb77-22" tabindex="-1"></a>synapse[,<span class="fu">c</span>(<span class="st">&quot;Symbol&quot;</span>, <span class="st">&quot;entrez&quot;</span>, <span class="st">&quot;log2FoldChange&quot;</span>, <span class="st">&quot;padj&quot;</span>, <span class="st">&quot;UHR_Rep1&quot;</span>, <span class="st">&quot;UHR_Rep2&quot;</span>, <span class="st">&quot;UHR_Rep3&quot;</span>, <span class="st">&quot;HBR_Rep1&quot;</span>, <span class="st">&quot;HBR_Rep2&quot;</span>, <span class="st">&quot;HBR_Rep3&quot;</span>)]</span></code></pre></div>
</div>
<div id="more-exploration" class="section level3 hasAnchor">
<h3>More exploration<a href="viewing-pairwise-sample-clustering.html#more-exploration" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>At this point, it will be helpful to move out of R and further explore our results locally. We will use an online tool to visualize how the GO terms we uncovered are related to each other.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="viewing-pairwise-sample-clustering.html#cb78-1" tabindex="-1"></a><span class="fu">write.table</span>(fc.go.cc.p.up, <span class="st">&quot;fc.go.cc.p.up.tsv&quot;</span>, <span class="at">quote =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb78-2"><a href="viewing-pairwise-sample-clustering.html#cb78-2" tabindex="-1"></a><span class="fu">write.table</span>(fc.go.cc.p.down, <span class="st">&quot;fc.go.cc.p.down.tsv&quot;</span>, <span class="at">quote =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="visualize" class="section level3 hasAnchor">
<h3>Visualize<a href="viewing-pairwise-sample-clustering.html#visualize" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For this next step we will do a very brief introduction to visualizing our results. We will use a tool called <a href="https://2019.webgestalt.org/2017/GOView/">GOView</a>, which is part of the <a href="http://www.webgestalt.org/">WEB-based Gene Set Ananlysis ToolKit (WebGestalt)</a> suite of tools.</p>
<p><strong>Step One</strong>
* Use a web browser to download your results</p>
<ul>
<li><p>For AWS: Navigate to the URL below replacing YOUR_IP_ADDRESS with your amazon instance IP address:
<a href="http://" class="uri">http://</a><strong>YOUR_IP_ADDRESS</strong>/rnaseq/de/deseq2</p></li>
<li><p>Download the linked files by right clicking on the two saved result files: <code>fc.go.cc.p.up.tsv</code> and <code>fc.go.cc.p.down.tsv</code>.</p></li>
<li><p>For posit Cloud: Navigate to the <code>outdir</code> folder in the ‘Files’ pane. Select <code>fc.go.cc.p.up.tsv</code> and <code>fc.go.cc.p.down.tsv</code> then ‘More’ -&gt; ‘Export…’. You may need to unzip the downloaded files.</p></li>
<li><p>Open the result file in your text editor of choice. We like <a href="https://www.barebones.com/products/textwrangler/">text wrangler</a>.
You should also be able to open the file in excel, google sheets, or another spreadsheet tool. This might help you visualize the data in rows and columns (NB: There might be a small amount of formatting necessary to get the header to line up properly).</p></li>
<li><p>You can either create an input file using <a href="http://genomedata.org/rnaseq-tutorial/fc.go.cc.p.down_web_ges.tsv">this file</a> as a guide, or you can simply use your downloaded data to cut and paste your GO terms of interest directly into GOView.</p></li>
</ul>
<p><strong>Step Two</strong></p>
<ul>
<li>Navigate to the <a href="http://www.webgestalt.org/">WEB-based Gene Set Analysis ToolKit (WebGestalt)</a></li>
</ul>
<p><strong>Step Three</strong></p>
<ul>
<li><p>Navigate to the <a href="http://www.webgestalt.org/2017/GOView/">GOView</a> tool</p></li>
<li><p>Then, input the GO terms you would like to explore into the <a href="http://www.webgestalt.org/2017/GOView/">GOView</a> interface by following the steps described in the “Beginning an analysis” section of the webpage. We will walk through a sample analysis.</p></li>
<li><p>Explore the outputs!</p></li>
</ul>
</div>
<div id="alternative-pathway-analysis-tools-and-strategies" class="section level3 hasAnchor">
<h3>Alternative Pathway analysis tools and strategies!<a href="viewing-pairwise-sample-clustering.html#alternative-pathway-analysis-tools-and-strategies" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>At this point, to generate additional visualizations and gain more insight from our enrichment analysis, we can turn to two powerful functions in the clusterProfiler package: gseGO and enrichKEGG. These tools allow us to go beyond simply identifying enriched pathways and give us the ability to visualize and explore these pathways in a much more detailed way.</p>
<p>First, to use gseGO and enrichKEGG effectively, we need a ranked list of DE genes based on their log2 fold change values. This ranked list allows us to analyze and visualize enrichment based on the degree of differential expression, rather than just a binary presence or absence in a pathway.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="viewing-pairwise-sample-clustering.html#cb79-1" tabindex="-1"></a><span class="co"># Create a named vector of log2 fold changes with Entrez IDs as names</span></span>
<span id="cb79-2"><a href="viewing-pairwise-sample-clustering.html#cb79-2" tabindex="-1"></a>ranked_genes <span class="ot">&lt;-</span> <span class="fu">setNames</span>(DE_genes_clean<span class="sc">$</span>log2FoldChange, DE_genes_clean<span class="sc">$</span>entrez)</span>
<span id="cb79-3"><a href="viewing-pairwise-sample-clustering.html#cb79-3" tabindex="-1"></a></span>
<span id="cb79-4"><a href="viewing-pairwise-sample-clustering.html#cb79-4" tabindex="-1"></a><span class="co"># Sort the genes by log2 fold change</span></span>
<span id="cb79-5"><a href="viewing-pairwise-sample-clustering.html#cb79-5" tabindex="-1"></a>ranked_genes <span class="ot">&lt;-</span> <span class="fu">sort</span>(ranked_genes, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Using gseGO, we can analyze the ranked DE genes list to create classic GSEA enrichment plots. These plots help us see how gene expression levels are distributed across the pathways that were identified as significant in our initial analysis. By examining the ranking of gene expression within these pathways, we can get a clearer picture of how specific pathways are activated or suppressed in our data set.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="viewing-pairwise-sample-clustering.html#cb80-1" tabindex="-1"></a><span class="co"># Install a package missing from the template</span></span>
<span id="cb80-2"><a href="viewing-pairwise-sample-clustering.html#cb80-2" tabindex="-1"></a><span class="co">#if (!requireNamespace(&quot;BiocManager&quot;, quietly = TRUE))</span></span>
<span id="cb80-3"><a href="viewing-pairwise-sample-clustering.html#cb80-3" tabindex="-1"></a><span class="co">#    install.packages(&quot;BiocManager&quot;, quiet = TRUE)</span></span>
<span id="cb80-4"><a href="viewing-pairwise-sample-clustering.html#cb80-4" tabindex="-1"></a><span class="co">#BiocManager::install(&quot;pathview&quot;, update = FALSE, ask = FALSE, quiet = TRUE)</span></span>
<span id="cb80-5"><a href="viewing-pairwise-sample-clustering.html#cb80-5" tabindex="-1"></a></span>
<span id="cb80-6"><a href="viewing-pairwise-sample-clustering.html#cb80-6" tabindex="-1"></a><span class="co"># Load relevant packages</span></span>
<span id="cb80-7"><a href="viewing-pairwise-sample-clustering.html#cb80-7" tabindex="-1"></a><span class="fu">library</span>(enrichplot)</span>
<span id="cb80-8"><a href="viewing-pairwise-sample-clustering.html#cb80-8" tabindex="-1"></a><span class="fu">library</span>(clusterProfiler)</span>
<span id="cb80-9"><a href="viewing-pairwise-sample-clustering.html#cb80-9" tabindex="-1"></a><span class="fu">library</span>(pathview)</span>
<span id="cb80-10"><a href="viewing-pairwise-sample-clustering.html#cb80-10" tabindex="-1"></a><span class="fu">library</span>(ggnewscale)</span>
<span id="cb80-11"><a href="viewing-pairwise-sample-clustering.html#cb80-11" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb80-12"><a href="viewing-pairwise-sample-clustering.html#cb80-12" tabindex="-1"></a></span>
<span id="cb80-13"><a href="viewing-pairwise-sample-clustering.html#cb80-13" tabindex="-1"></a>gsea_res <span class="ot">&lt;-</span> <span class="fu">gseGO</span>(</span>
<span id="cb80-14"><a href="viewing-pairwise-sample-clustering.html#cb80-14" tabindex="-1"></a>  <span class="at">geneList =</span> ranked_genes,       <span class="co"># Ranked list of genes</span></span>
<span id="cb80-15"><a href="viewing-pairwise-sample-clustering.html#cb80-15" tabindex="-1"></a>  <span class="at">OrgDb =</span> org.Hs.eg.db,          <span class="co"># Specify organism database</span></span>
<span id="cb80-16"><a href="viewing-pairwise-sample-clustering.html#cb80-16" tabindex="-1"></a>  <span class="at">ont =</span> <span class="st">&quot;CC&quot;</span>,                    <span class="co"># Use &quot;BP&quot; for Biological Process, &quot;MF&quot; for Molecular Function, &quot;CC&quot; for Cellular Component</span></span>
<span id="cb80-17"><a href="viewing-pairwise-sample-clustering.html#cb80-17" tabindex="-1"></a>  <span class="at">keyType =</span> <span class="st">&quot;ENTREZID&quot;</span>,          <span class="co"># Ensure your gene IDs match the key type in OrgDb</span></span>
<span id="cb80-18"><a href="viewing-pairwise-sample-clustering.html#cb80-18" tabindex="-1"></a>  <span class="at">pvalueCutoff =</span> <span class="fl">0.05</span>,           <span class="co"># Set a p-value cutoff for significant pathways</span></span>
<span id="cb80-19"><a href="viewing-pairwise-sample-clustering.html#cb80-19" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb80-20"><a href="viewing-pairwise-sample-clustering.html#cb80-20" tabindex="-1"></a>)</span></code></pre></div>
<p>Generate the classic GSEA enrichment plot</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="viewing-pairwise-sample-clustering.html#cb81-1" tabindex="-1"></a><span class="co"># Plot the enrichment plot for a specific GO term or pathway - Synapse</span></span>
<span id="cb81-2"><a href="viewing-pairwise-sample-clustering.html#cb81-2" tabindex="-1"></a>gsea_plot <span class="ot">&lt;-</span> <span class="fu">gseaplot2</span>(gsea_res, <span class="at">geneSetID =</span> <span class="st">&quot;GO:0045202&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Enrichment Plot for Synapse&quot;</span>)</span>
<span id="cb81-3"><a href="viewing-pairwise-sample-clustering.html#cb81-3" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;gsea_go_synapse_plot.pdf&quot;</span>, <span class="at">plot=</span>gsea_plot, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">8</span>)</span></code></pre></div>
<p>We can use additional visualizations, such as dot plots, ridge plots, and concept network plots, to gain further insights into the enriched pathways.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="viewing-pairwise-sample-clustering.html#cb82-1" tabindex="-1"></a><span class="co"># Dotplot for top GO pathways enriched with DE genes</span></span>
<span id="cb82-2"><a href="viewing-pairwise-sample-clustering.html#cb82-2" tabindex="-1"></a>gsea_dot_plot <span class="ot">&lt;-</span> <span class="fu">dotplot</span>(gsea_res, <span class="at">showCategory =</span> <span class="dv">30</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;GSEA Dotplot - Top 30 GO Categories&quot;</span>)</span>
<span id="cb82-3"><a href="viewing-pairwise-sample-clustering.html#cb82-3" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;gsea_dot_plot.pdf&quot;</span>, <span class="at">plot=</span>gsea_dot_plot, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">8</span>)</span>
<span id="cb82-4"><a href="viewing-pairwise-sample-clustering.html#cb82-4" tabindex="-1"></a></span>
<span id="cb82-5"><a href="viewing-pairwise-sample-clustering.html#cb82-5" tabindex="-1"></a><span class="co">#Ridgeplot for top GO pathways enriched with DE genes</span></span>
<span id="cb82-6"><a href="viewing-pairwise-sample-clustering.html#cb82-6" tabindex="-1"></a>gsea_ridge_plot <span class="ot">&lt;-</span><span class="fu">ridgeplot</span>(gsea_res)</span>
<span id="cb82-7"><a href="viewing-pairwise-sample-clustering.html#cb82-7" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;gsea_ridge_plot.pdf&quot;</span>, <span class="at">plot=</span>gsea_ridge_plot, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">8</span>)</span>
<span id="cb82-8"><a href="viewing-pairwise-sample-clustering.html#cb82-8" tabindex="-1"></a></span>
<span id="cb82-9"><a href="viewing-pairwise-sample-clustering.html#cb82-9" tabindex="-1"></a><span class="co"># Concept network plot to illustrate relationships between the top enriched GO terms and DE genes</span></span>
<span id="cb82-10"><a href="viewing-pairwise-sample-clustering.html#cb82-10" tabindex="-1"></a>gsea_cnetplot <span class="ot">&lt;-</span> <span class="fu">cnetplot</span>(gsea_res, <span class="at">foldChange =</span> ranked_genes, <span class="at">showCategory =</span> <span class="dv">10</span>)</span>
<span id="cb82-11"><a href="viewing-pairwise-sample-clustering.html#cb82-11" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;gsea_cnetplot.pdf&quot;</span>, <span class="at">plot=</span>gsea_cnetplot, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span></code></pre></div>
<p>The enrichKEGG function can be used to visualize KEGG pathways, showing detailed diagrams with our DE genes highlighted. This approach is especially useful for understanding the biological roles of up- and down-regulated genes within specific metabolic or signaling pathways. By using the pathview package, we can generate pathway diagrams where each DE gene is displayed in its functional context and color-coded by expression level. This makes it easy to see which parts of a pathway are impacted and highlights any potential regulatory or metabolic shifts in a clear, intuitive format. We will start by downloading and installing the KEGG database and then run the <code>enrichKEGG</code> function.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="viewing-pairwise-sample-clustering.html#cb83-1" tabindex="-1"></a><span class="co"># Download KEGG DB file and install</span></span>
<span id="cb83-2"><a href="viewing-pairwise-sample-clustering.html#cb83-2" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">&#39;https://www.bioconductor.org/packages/3.11/data/annotation/src/contrib/KEGG.db_3.2.4.tar.gz&#39;</span>, <span class="at">destfile=</span><span class="st">&#39;KEGG.db_3.2.4.tar.gz&#39;</span>)</span>
<span id="cb83-3"><a href="viewing-pairwise-sample-clustering.html#cb83-3" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;KEGG.db_3.2.4.tar.gz&quot;</span>, <span class="at">repos =</span> <span class="cn">NULL</span>, <span class="at">type =</span> <span class="st">&quot;source&quot;</span>)</span>
<span id="cb83-4"><a href="viewing-pairwise-sample-clustering.html#cb83-4" tabindex="-1"></a></span>
<span id="cb83-5"><a href="viewing-pairwise-sample-clustering.html#cb83-5" tabindex="-1"></a><span class="co"># Run enrichKEGG with local database option</span></span>
<span id="cb83-6"><a href="viewing-pairwise-sample-clustering.html#cb83-6" tabindex="-1"></a>pathways <span class="ot">&lt;-</span> <span class="fu">enrichKEGG</span>(<span class="at">gene =</span> <span class="fu">names</span>(ranked_genes), <span class="at">organism =</span> <span class="st">&quot;hsa&quot;</span>, <span class="at">keyType =</span> <span class="st">&quot;kegg&quot;</span>, <span class="at">use_internal_data=</span><span class="cn">TRUE</span>)</span>
<span id="cb83-7"><a href="viewing-pairwise-sample-clustering.html#cb83-7" tabindex="-1"></a><span class="fu">head</span>(pathways<span class="sc">@</span>result)</span></code></pre></div>
<p>Let’s choose one of the pathways above, for example <code>hsa04010 - MAPK signaling pathway</code> to visualize.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="viewing-pairwise-sample-clustering.html#cb84-1" tabindex="-1"></a><span class="co"># Define the KEGG pathway ID based on above, and run pathview (note this automatically generates and saves plots to your current directory)</span></span>
<span id="cb84-2"><a href="viewing-pairwise-sample-clustering.html#cb84-2" tabindex="-1"></a>pathway_id <span class="ot">&lt;-</span> <span class="st">&quot;hsa04010&quot;</span>  <span class="co"># Replace with the KEGG pathway ID of interest</span></span>
<span id="cb84-3"><a href="viewing-pairwise-sample-clustering.html#cb84-3" tabindex="-1"></a><span class="fu">pathview</span>(</span>
<span id="cb84-4"><a href="viewing-pairwise-sample-clustering.html#cb84-4" tabindex="-1"></a>  <span class="at">gene.data =</span> ranked_genes,    <span class="co"># DE gene data with Entrez IDs</span></span>
<span id="cb84-5"><a href="viewing-pairwise-sample-clustering.html#cb84-5" tabindex="-1"></a>  <span class="at">pathway.id =</span> pathway_id,  <span class="co"># KEGG pathway ID</span></span>
<span id="cb84-6"><a href="viewing-pairwise-sample-clustering.html#cb84-6" tabindex="-1"></a>  <span class="at">species =</span> <span class="st">&quot;hsa&quot;</span>,          <span class="co"># Species code for human</span></span>
<span id="cb84-7"><a href="viewing-pairwise-sample-clustering.html#cb84-7" tabindex="-1"></a>  <span class="at">limit =</span> <span class="fu">list</span>(<span class="at">gene =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>)),  <span class="co"># Set color scale limits for log2 fold changes</span></span>
<span id="cb84-8"><a href="viewing-pairwise-sample-clustering.html#cb84-8" tabindex="-1"></a>  <span class="at">low =</span> <span class="st">&quot;blue&quot;</span>,             <span class="co"># Color for down-regulated genes</span></span>
<span id="cb84-9"><a href="viewing-pairwise-sample-clustering.html#cb84-9" tabindex="-1"></a>  <span class="at">mid =</span> <span class="st">&quot;white&quot;</span>,            <span class="co"># Color for neutral genes</span></span>
<span id="cb84-10"><a href="viewing-pairwise-sample-clustering.html#cb84-10" tabindex="-1"></a>  <span class="at">high =</span> <span class="st">&quot;red&quot;</span>              <span class="co"># Color for up-regulated genes</span></span>
<span id="cb84-11"><a href="viewing-pairwise-sample-clustering.html#cb84-11" tabindex="-1"></a>)</span>
<span id="cb84-12"><a href="viewing-pairwise-sample-clustering.html#cb84-12" tabindex="-1"></a></span>
<span id="cb84-13"><a href="viewing-pairwise-sample-clustering.html#cb84-13" tabindex="-1"></a><span class="co">#To exit R type:</span></span>
<span id="cb84-14"><a href="viewing-pairwise-sample-clustering.html#cb84-14" tabindex="-1"></a><span class="fu">quit</span>(<span class="at">save =</span> <span class="st">&quot;no&quot;</span>)</span></code></pre></div>
<p>Leave the docker session</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb85-1"><a href="viewing-pairwise-sample-clustering.html#cb85-1" tabindex="-1"></a><span class="bu">exit</span></span></code></pre></div>
<p>In this section we will obtain a dataset to allow demonstration of batch correction using the ComBat-Seq tool in R (Bioconductor).</p>
</div>
<div id="download-and-prepare-some-test-data-where-some-batch-effects-are-expected" class="section level3 hasAnchor">
<h3>Download and prepare some test data where some batch effects are expected<a href="viewing-pairwise-sample-clustering.html#download-and-prepare-some-test-data-where-some-batch-effects-are-expected" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For this exercise we will obtain public RNA-seq data from an extensive multi-platform comparison of sequencing platforms that also examined the impact of generating data at multiple sites, using polyA vs ribo-reduction for enrichment, and the impact of RNA degradation (<a href="https://pubmed.ncbi.nlm.nih.gov/25150835/">PMID: 25150835</a>): “Multi-platform and cross-methodological reproducibility of transcriptome profiling by RNA-seq in the ABRF Next-Generation Sequencing Study”.</p>
<p>This publication used the same UHR (cancer cell lines) and HBR (brain tissue) samples we have been using throughout this course. To examine a strong batch effect, we will consider a DE analysis of UHR vs HBR where we compare Ribo-depleted (“Ribo”) and polyA-enriched (“Poly”) samples.</p>
<p>The entire RNA-seq dataset <a href="https://pubmed.ncbi.nlm.nih.gov/25150835/">PMID: 25150835</a> used for this module has been deposited in GEO. In GEO, these data are organized as a <code>superseries</code>: <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE46876">GSE46876</a> which has data for several sequencing platforms. The data from the Illumina Platform are part of this <code>subseries</code>: <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE48035">GSE48035</a>.</p>
<p>To do this analysis quickly, we will download pre-computed raw read counts for this dataset: <a href="https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE48035&amp;format=file&amp;file=GSE48035%5FILMN%2Ecounts%2Etxt%2Egz">GSE48035_ILMN.counts.txt.gz</a></p>
<p>Set up a working directory and download the RNA-seq counts file needed for the following exercise as follows:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="viewing-pairwise-sample-clustering.html#cb86-1" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$RNA_HOME</span></span>
<span id="cb86-2"><a href="viewing-pairwise-sample-clustering.html#cb86-2" tabindex="-1"></a><span class="fu">mkdir</span> batch_correction</span>
<span id="cb86-3"><a href="viewing-pairwise-sample-clustering.html#cb86-3" tabindex="-1"></a><span class="bu">cd</span> batch_correction</span>
<span id="cb86-4"><a href="viewing-pairwise-sample-clustering.html#cb86-4" tabindex="-1"></a><span class="fu">wget</span> http://genomedata.org/rnaseq-tutorial/batch_correction/GSE48035_ILMN.counts.txt.gz</span></code></pre></div>
<p>Create a simplified version of this file that has only the counts for the samples we wish to use for this analysis as follows:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="viewing-pairwise-sample-clustering.html#cb87-1" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$RNA_HOME</span>/batch_correction</span>
<span id="cb87-2"><a href="viewing-pairwise-sample-clustering.html#cb87-2" tabindex="-1"></a></span>
<span id="cb87-3"><a href="viewing-pairwise-sample-clustering.html#cb87-3" tabindex="-1"></a><span class="co">#remove all quotes from file</span></span>
<span id="cb87-4"><a href="viewing-pairwise-sample-clustering.html#cb87-4" tabindex="-1"></a><span class="fu">zcat</span> GSE48035_ILMN.counts.txt.gz <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;&quot;&#39;</span> <span class="op">&gt;</span> GSE48035_ILMN.counts.tmp.txt</span>
<span id="cb87-5"><a href="viewing-pairwise-sample-clustering.html#cb87-5" tabindex="-1"></a></span>
<span id="cb87-6"><a href="viewing-pairwise-sample-clustering.html#cb87-6" tabindex="-1"></a><span class="co">#create a fixed version of the header and store for later</span></span>
<span id="cb87-7"><a href="viewing-pairwise-sample-clustering.html#cb87-7" tabindex="-1"></a><span class="fu">head</span> <span class="at">-n</span> 1 GSE48035_ILMN.counts.tmp.txt <span class="kw">|</span> <span class="fu">perl</span> <span class="at">-ne</span> <span class="st">&#39;print &quot;Gene\tChr\t$_&quot;&#39;</span> <span class="op">&gt;</span> header.txt</span>
<span id="cb87-8"><a href="viewing-pairwise-sample-clustering.html#cb87-8" tabindex="-1"></a></span>
<span id="cb87-9"><a href="viewing-pairwise-sample-clustering.html#cb87-9" tabindex="-1"></a><span class="co">#split the chromosome and gene names on each line, sort the file by gene name</span></span>
<span id="cb87-10"><a href="viewing-pairwise-sample-clustering.html#cb87-10" tabindex="-1"></a><span class="fu">perl</span> <span class="at">-ne</span> <span class="st">&#39;chomp; if ($_ =~ /^(chr\w+)\!(\S+)(.*)/){print &quot;$2\t$1$3\n&quot;}else{print &quot;$_\n&quot;}&#39;</span> GSE48035_ILMN.counts.tmp.txt <span class="kw">|</span> <span class="fu">sort</span> <span class="op">&gt;</span> GSE48035_ILMN.counts.tmp2.txt</span>
<span id="cb87-11"><a href="viewing-pairwise-sample-clustering.html#cb87-11" tabindex="-1"></a></span>
<span id="cb87-12"><a href="viewing-pairwise-sample-clustering.html#cb87-12" tabindex="-1"></a><span class="co">#remove the old header line</span></span>
<span id="cb87-13"><a href="viewing-pairwise-sample-clustering.html#cb87-13" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-v</span> <span class="at">--color</span><span class="op">=</span>never ABRF GSE48035_ILMN.counts.tmp2.txt <span class="op">&gt;</span> GSE48035_ILMN.counts.clean.txt</span>
<span id="cb87-14"><a href="viewing-pairwise-sample-clustering.html#cb87-14" tabindex="-1"></a></span>
<span id="cb87-15"><a href="viewing-pairwise-sample-clustering.html#cb87-15" tabindex="-1"></a><span class="co">#cut out only the columns for the UHR (A) and HBR (B) samples, replicates 1-4, and PolyA vs Enrichment </span></span>
<span id="cb87-16"><a href="viewing-pairwise-sample-clustering.html#cb87-16" tabindex="-1"></a><span class="fu">cut</span> <span class="at">-f</span> 1-2,3-6,7-10,19-22,23-26 GSE48035_ILMN.counts.clean.txt <span class="op">&gt;</span> GSE48035_ILMN.Counts.SampleSubset.txt</span>
<span id="cb87-17"><a href="viewing-pairwise-sample-clustering.html#cb87-17" tabindex="-1"></a><span class="fu">cut</span> <span class="at">-f</span> 1-2,3-6,7-10,19-22,23-26 header.txt <span class="op">&gt;</span> header.SampleSubset.txt</span>
<span id="cb87-18"><a href="viewing-pairwise-sample-clustering.html#cb87-18" tabindex="-1"></a></span>
<span id="cb87-19"><a href="viewing-pairwise-sample-clustering.html#cb87-19" tabindex="-1"></a><span class="co">#how many gene lines are we starting with?</span></span>
<span id="cb87-20"><a href="viewing-pairwise-sample-clustering.html#cb87-20" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> GSE48035_ILMN.Counts.SampleSubset.txt</span>
<span id="cb87-21"><a href="viewing-pairwise-sample-clustering.html#cb87-21" tabindex="-1"></a></span>
<span id="cb87-22"><a href="viewing-pairwise-sample-clustering.html#cb87-22" tabindex="-1"></a><span class="co">#cleanup intermediate files created above</span></span>
<span id="cb87-23"><a href="viewing-pairwise-sample-clustering.html#cb87-23" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> GSE48035_ILMN.counts.txt.gz GSE48035_ILMN.counts.tmp.txt GSE48035_ILMN.counts.tmp2.txt GSE48035_ILMN.counts.clean.txt header.txt</span></code></pre></div>
<p>Further limit these counts to those that correspond to <strong>known protein coding genes</strong>:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb88-1"><a href="viewing-pairwise-sample-clustering.html#cb88-1" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$RNA_HOME</span>/batch_correction</span>
<span id="cb88-2"><a href="viewing-pairwise-sample-clustering.html#cb88-2" tabindex="-1"></a></span>
<span id="cb88-3"><a href="viewing-pairwise-sample-clustering.html#cb88-3" tabindex="-1"></a><span class="co">#download complete Ensembl GTF file</span></span>
<span id="cb88-4"><a href="viewing-pairwise-sample-clustering.html#cb88-4" tabindex="-1"></a><span class="fu">wget</span> ftp://ftp.ensembl.org/pub/release-101/gtf/homo_sapiens/Homo_sapiens.GRCh38.101.gtf.gz</span>
<span id="cb88-5"><a href="viewing-pairwise-sample-clustering.html#cb88-5" tabindex="-1"></a></span>
<span id="cb88-6"><a href="viewing-pairwise-sample-clustering.html#cb88-6" tabindex="-1"></a><span class="co">#grab all the gene records, limit to gene with &quot;protein_coding&quot; biotype, create unique gene name list</span></span>
<span id="cb88-7"><a href="viewing-pairwise-sample-clustering.html#cb88-7" tabindex="-1"></a><span class="fu">zcat</span> Homo_sapiens.GRCh38.101.gtf.gz <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-w</span> gene <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;gene_biotype </span><span class="dt">\&quot;</span><span class="st">protein_coding</span><span class="dt">\&quot;</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-f</span> 9 <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span> <span class="st">&quot;;&quot;</span> <span class="at">-f</span> 3 <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&quot; gene_name &quot;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;&quot;&#39;</span> <span class="kw">|</span> <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">uniq</span> <span class="op">&gt;</span> Ensembl101_ProteinCodingGeneNames.txt</span>
<span id="cb88-8"><a href="viewing-pairwise-sample-clustering.html#cb88-8" tabindex="-1"></a></span>
<span id="cb88-9"><a href="viewing-pairwise-sample-clustering.html#cb88-9" tabindex="-1"></a><span class="co">#how many unique protein coding genes names does Ensembl have?</span></span>
<span id="cb88-10"><a href="viewing-pairwise-sample-clustering.html#cb88-10" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> Ensembl101_ProteinCodingGeneNames.txt</span>
<span id="cb88-11"><a href="viewing-pairwise-sample-clustering.html#cb88-11" tabindex="-1"></a></span>
<span id="cb88-12"><a href="viewing-pairwise-sample-clustering.html#cb88-12" tabindex="-1"></a><span class="co">#filter our gene count matrix down to only the protein coding genes</span></span>
<span id="cb88-13"><a href="viewing-pairwise-sample-clustering.html#cb88-13" tabindex="-1"></a><span class="fu">join</span> <span class="at">-j</span> 1 <span class="at">-t</span> <span class="st">$&#39;</span><span class="dt">\t</span><span class="st">&#39;</span> Ensembl101_ProteinCodingGeneNames.txt GSE48035_ILMN.Counts.SampleSubset.txt <span class="kw">|</span> <span class="fu">cat</span> header.SampleSubset.txt <span class="at">-</span> <span class="op">&gt;</span> GSE48035_ILMN.Counts.SampleSubset.ProteinCodingGenes.tsv</span>
<span id="cb88-14"><a href="viewing-pairwise-sample-clustering.html#cb88-14" tabindex="-1"></a></span>
<span id="cb88-15"><a href="viewing-pairwise-sample-clustering.html#cb88-15" tabindex="-1"></a><span class="co">#how many lines of RNA-seq counts do we still have?</span></span>
<span id="cb88-16"><a href="viewing-pairwise-sample-clustering.html#cb88-16" tabindex="-1"></a><span class="fu">wc</span> <span class="at">-l</span> GSE48035_ILMN.Counts.SampleSubset.ProteinCodingGenes.tsv</span>
<span id="cb88-17"><a href="viewing-pairwise-sample-clustering.html#cb88-17" tabindex="-1"></a></span>
<span id="cb88-18"><a href="viewing-pairwise-sample-clustering.html#cb88-18" tabindex="-1"></a><span class="co">#clean up </span></span>
<span id="cb88-19"><a href="viewing-pairwise-sample-clustering.html#cb88-19" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> header.SampleSubset.txt GSE48035_ILMN.Counts.SampleSubset.txt</span>
<span id="cb88-20"><a href="viewing-pairwise-sample-clustering.html#cb88-20" tabindex="-1"></a></span>
<span id="cb88-21"><a href="viewing-pairwise-sample-clustering.html#cb88-21" tabindex="-1"></a><span class="co">#take a look at the final filtered read count matrix to be used for the following analysis</span></span>
<span id="cb88-22"><a href="viewing-pairwise-sample-clustering.html#cb88-22" tabindex="-1"></a><span class="ex">column</span> <span class="at">-t</span> GSE48035_ILMN.Counts.SampleSubset.ProteinCodingGenes.tsv <span class="kw">|</span> <span class="fu">less</span> <span class="at">-S</span></span></code></pre></div>
<p>Note that filtering gene lists by gene name as we have done above is generally not advised as we usually can’t guarantee that gene names from two different lists are compatible. Mapping between unique identifiers would be preferable. But for demonstrating the batch analysis below this should be fine…</p>
<p>In this section we will use the ComBat-Seq tool in R (Bioconductor) to demonstrate the principles and application of batch correction. Due to the way our test data was generated (at a single center, at one time, with consistent methodology) we do NOT expect batch effects in these data. Therefore we will use a different (but highly related) dataset to demonstrate the impact of Batch correction in this module.</p>
</div>
<div id="introduction-to-batch-correction" class="section level3 hasAnchor">
<h3>Introduction to batch correction<a href="viewing-pairwise-sample-clustering.html#introduction-to-batch-correction" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We highly recommend reading the entire <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7518324/">ComBat-Seq manuscript</a> by Yuqing Zhang, Giovanni Parmigiani, and W Evan Johnson. This manuscript does a beautiful job of briefly introducing the concept of batch correction and the differences between <code>normalization</code> and <code>batch correction</code>. If you find this exercise helpful in your research, please cite the ComBat-Seq paper (<a href="https://pubmed.ncbi.nlm.nih.gov/33015620/">PMID: 33015620</a>).</p>
<p>In particular, this excerpt covers the basics:
&gt; Genomic data are often produced in batches due to logistical or practical restrictions, but technical variation and differences across batches, often called batch effects, can cause significant heterogeneity across batches of data. Batch effects often result in discrepancies in the statistical distributions across data from different technical processing batches, and can have unfavorable impact on downstream biological analysis … Batch effects often cannot be fully addressed by normalization methods and procedures. The differences in the overall expression distribution of each sample across batch may be corrected by normalization methods, such as transforming the raw counts to (logarithms of) CPM, TPM or RPKM/FPKM, the trimmed mean of M values (TMM), or relative log expression (RLE). However, batch effects in composition, i.e. the level of expression of genes scaled by the total expression (coverage) in each sample, cannot be fully corrected with normalization. … While the overall distribution of samples may be normalized to the same level across batches, individual genes may still be affected by batch-level bias.</p>
</div>
<div id="introduction-to-this-demonstration-of-a-batch-correction-approach" class="section level3 hasAnchor">
<h3>Introduction to this demonstration of a batch correction approach<a href="viewing-pairwise-sample-clustering.html#introduction-to-this-demonstration-of-a-batch-correction-approach" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For this exercise we have obtained public RNA-seq data from an extensive multi-platform comparison of sequencing platforms that also examined the impact of: (1) generating data at multiple sites, (2) using polyA vs ribo-reduction for enrichment, and (3) different levels of RNA degradation (<a href="https://pubmed.ncbi.nlm.nih.gov/25150835/">PMID: 25150835</a>): “Multi-platform and cross-methodological reproducibility of transcriptome profiling by RNA-seq in the ABRF Next-Generation Sequencing Study”.</p>
<p>This publication used the same UHR (cancer cell lines) and HBR (brain tissue) samples we have been using throughout this course. To examine a strong batch effect, we will consider a DE analysis of UHR vs HBR where we compare Ribo-depleted (“Ribo”) and polyA-enriched (“Poly”) samples.</p>
<p><strong>Questions</strong>
If we do DE analysis of UHR vs. HBR for replicates that are consistent with respect to Ribo-depletion or PolyA-enrichment, how does the result compare to when we mix the Ribo-depleted data and PolyA-enriched data together?</p>
<p>If you do batch correction and redo these comparisons does it make the results more comparable? i.e. can we correct for the technical differences introduced by the library construction approach and see the same biological differences? Can we improve our statistical power by then benefitting from more samples?</p>
<p>This is a bit contrived because there really are true biological differences expected for polyA vs. Ribo-depleted data. To counter this, we will limit the analysis to only know protein coding genes. For those genes we expect essentially the same biological answer when comparing UHR vs HBR expression patterns.</p>
<p>This exercise is also a bit simplistic in the sense that we have perfectly balanced conditions and batches. Our conditions of interest are: HBR (brain) vs. UHR (cancer cell line) expression patterns. Our batches are the two methods of processing: Riboreduction and PolyA enrichment. And we have 4 replicates of both conditions in both batches. To perform this kind of batch correction you need at least some representation of each of your conditions of interest in each batch. So, for example, if we processed all the HBR samples with Riboreduction and all the UHR samples with PolyA enrichment, we would be unable to model the batch effect vs the condition effect.</p>
<p>There are also other experiments from this published dataset we could use instead. For example, different levels of degradation?, data generated by different labs? <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4167418/">Figure 1</a> and <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4167418/">Figure 2</a> give a nice high level summary of all the data generated. We chose the Ribo-reduction and PolyA enrichment data for this exercise because we expect this would introduce a very strong batch effect. It is also the kind of thing that one could imagine really coming up in a meta-analysis where one you are pooling data from multiple studies. For example, imagine we find three published studies from three labs that all assayed some number of normal breast tissue and breast tumor. Each used a different approach to generate their data but they all involved this same biological comparison and by combining the three datasets we hope to substantially increase our power. If we can correct for batch effects arising from the three labs, this may be successful.</p>
</div>
<div id="samples-abbreviations-used-in-the-following-analysis" class="section level3 hasAnchor">
<h3>Samples abbreviations used in the following analysis<a href="viewing-pairwise-sample-clustering.html#samples-abbreviations-used-in-the-following-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>HBR -&gt; Human Brain Reference, Biological condition (pool of adult brain tissues)</li>
<li>UHR -&gt; Universal Human Reference, Biological condition (pool of cancer cell lines)</li>
<li>Ribo -&gt; Library preparation method using ribosomal reduction, Batch group</li>
<li>Poly -&gt; Library preparation method using polyA enrichment, Batch group</li>
<li>1-4 -&gt; Replicate number: 1, 2, 3, 4.</li>
</ul>
</div>
<div id="perform-principal-component-analysis-pca-on-the-uncorrected-counts" class="section level3 hasAnchor">
<h3>Perform principal component analysis (PCA) on the uncorrected counts<a href="viewing-pairwise-sample-clustering.html#perform-principal-component-analysis-pca-on-the-uncorrected-counts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>PCA analysis can be used to identify potential batch effects in your data. The general strategy is to use PCA to identify patterns of similarity/difference in the expression signatures of your samples and to ask whether it appears to be driven by the expected biological conditions of interest. The PCA plot can be labeled with the biological conditions and also with potential sources of batch effects such as: sequencing source, date of data generation, lab technician, library construction kit batches, matrigel batches, mouse litters, software or instrumentation versions, etc.</p>
<p><a href="https://en.wikipedia.org/wiki/Principal_component_analysis">Principal component analysis</a> is a <a href="https://en.wikipedia.org/wiki/Dimensionality_reduction">dimensionality-reduction</a> method that can be applied to large datasets (e.g. thousands of gene expression values for many samples). PCA tries to represent a large set of variables as a smaller set of variables that maximally capture the information content of the larger set. PCA is a general exploratory data analysis approach with many applications and nuances, the details of which are beyond the scope of this demonstration of batch effect correction. However, in the context of this module, PCA provides a way to visualize samples as “clusters” based on their overall pattern of gene expression values. The composition and arrangement of these clusters (usually visualized in 2D or interactive 3D plots) can be helpful in interpreting high level differences between samples and testing prior expectations about the similarity between conditions, replicates, etc.</p>
<p>We will perform PCA analysis before AND after batch correction. Samples will be labelled according to biological condition (UHR vs HBR) and library preparation type (Ribo vs PolyA).</p>
<p>Does the analysis below suggest that sample grouping according to PCA is being influenced by batch?</p>
<p>Perform the following analyses in <code>R</code>:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="viewing-pairwise-sample-clustering.html#cb89-1" tabindex="-1"></a></span>
<span id="cb89-2"><a href="viewing-pairwise-sample-clustering.html#cb89-2" tabindex="-1"></a><span class="co">#Define working dir paths</span></span>
<span id="cb89-3"><a href="viewing-pairwise-sample-clustering.html#cb89-3" tabindex="-1"></a><span class="co"># datadir = &quot;/cloud/project/data/bulk_rna&quot;</span></span>
<span id="cb89-4"><a href="viewing-pairwise-sample-clustering.html#cb89-4" tabindex="-1"></a><span class="co"># outdir = &quot;/cloud/project/outdir&quot;</span></span>
<span id="cb89-5"><a href="viewing-pairwise-sample-clustering.html#cb89-5" tabindex="-1"></a></span>
<span id="cb89-6"><a href="viewing-pairwise-sample-clustering.html#cb89-6" tabindex="-1"></a>datadir <span class="ot">=</span> <span class="st">&quot;~/workspace/rnaseq/batch_correction&quot;</span></span>
<span id="cb89-7"><a href="viewing-pairwise-sample-clustering.html#cb89-7" tabindex="-1"></a>outdir <span class="ot">=</span> <span class="st">&quot;~/workspace/rnaseq/batch_correction/outputs&quot;</span></span>
<span id="cb89-8"><a href="viewing-pairwise-sample-clustering.html#cb89-8" tabindex="-1"></a></span>
<span id="cb89-9"><a href="viewing-pairwise-sample-clustering.html#cb89-9" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(outdir)) <span class="fu">dir.create</span>(outdir)</span>
<span id="cb89-10"><a href="viewing-pairwise-sample-clustering.html#cb89-10" tabindex="-1"></a></span>
<span id="cb89-11"><a href="viewing-pairwise-sample-clustering.html#cb89-11" tabindex="-1"></a></span>
<span id="cb89-12"><a href="viewing-pairwise-sample-clustering.html#cb89-12" tabindex="-1"></a></span>
<span id="cb89-13"><a href="viewing-pairwise-sample-clustering.html#cb89-13" tabindex="-1"></a><span class="co">#load neccessary libraries</span></span>
<span id="cb89-14"><a href="viewing-pairwise-sample-clustering.html#cb89-14" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;sva&quot;</span>) <span class="co">#Note this exercise requires sva (&gt;= v3.36.0) which is only available for R (&gt;= v4.x)</span></span>
<span id="cb89-15"><a href="viewing-pairwise-sample-clustering.html#cb89-15" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb89-16"><a href="viewing-pairwise-sample-clustering.html#cb89-16" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;gridExtra&quot;</span>)</span>
<span id="cb89-17"><a href="viewing-pairwise-sample-clustering.html#cb89-17" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;edgeR&quot;</span>)</span>
<span id="cb89-18"><a href="viewing-pairwise-sample-clustering.html#cb89-18" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;UpSetR&quot;</span>)</span>
<span id="cb89-19"><a href="viewing-pairwise-sample-clustering.html#cb89-19" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb89-20"><a href="viewing-pairwise-sample-clustering.html#cb89-20" tabindex="-1"></a></span>
<span id="cb89-21"><a href="viewing-pairwise-sample-clustering.html#cb89-21" tabindex="-1"></a><span class="co">#load in the uncorrected data as raw counts</span></span>
<span id="cb89-22"><a href="viewing-pairwise-sample-clustering.html#cb89-22" tabindex="-1"></a><span class="fu">setwd</span>(datadir)</span>
<span id="cb89-23"><a href="viewing-pairwise-sample-clustering.html#cb89-23" tabindex="-1"></a>uncorrected_data <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">&quot;GSE48035_ILMN.Counts.SampleSubset.ProteinCodingGenes.tsv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">as.is =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb89-24"><a href="viewing-pairwise-sample-clustering.html#cb89-24" tabindex="-1"></a><span class="fu">setwd</span>(outdir)</span>
<span id="cb89-25"><a href="viewing-pairwise-sample-clustering.html#cb89-25" tabindex="-1"></a></span>
<span id="cb89-26"><a href="viewing-pairwise-sample-clustering.html#cb89-26" tabindex="-1"></a><span class="co">#simplify the names of the data columns</span></span>
<span id="cb89-27"><a href="viewing-pairwise-sample-clustering.html#cb89-27" tabindex="-1"></a><span class="co"># (A = Universal Human Reference RNA and B = Human Brain Reference RNA)</span></span>
<span id="cb89-28"><a href="viewing-pairwise-sample-clustering.html#cb89-28" tabindex="-1"></a><span class="co"># RNA = polyA enrichment and RIBO = ribosomal RNA depletion</span></span>
<span id="cb89-29"><a href="viewing-pairwise-sample-clustering.html#cb89-29" tabindex="-1"></a><span class="co"># 1, 2, 3, 4 are replicates</span></span>
<span id="cb89-30"><a href="viewing-pairwise-sample-clustering.html#cb89-30" tabindex="-1"></a><span class="fu">names</span>(uncorrected_data) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Gene&quot;</span>, <span class="st">&quot;Chr&quot;</span>, <span class="st">&quot;UHR_Ribo_1&quot;</span>, <span class="st">&quot;UHR_Ribo_2&quot;</span>, <span class="st">&quot;UHR_Ribo_3&quot;</span>, <span class="st">&quot;UHR_Ribo_4&quot;</span>, <span class="st">&quot;HBR_Ribo_1&quot;</span>, <span class="st">&quot;HBR_Ribo_2&quot;</span>, <span class="st">&quot;HBR_Ribo_3&quot;</span>, <span class="st">&quot;HBR_Ribo_4&quot;</span>, </span>
<span id="cb89-31"><a href="viewing-pairwise-sample-clustering.html#cb89-31" tabindex="-1"></a>                            <span class="st">&quot;UHR_Poly_1&quot;</span>, <span class="st">&quot;UHR_Poly_2&quot;</span>, <span class="st">&quot;UHR_Poly_3&quot;</span>, <span class="st">&quot;UHR_Poly_4&quot;</span>, <span class="st">&quot;HBR_Poly_1&quot;</span>, <span class="st">&quot;HBR_Poly_2&quot;</span>, <span class="st">&quot;HBR_Poly_3&quot;</span>, <span class="st">&quot;HBR_Poly_4&quot;</span>)</span>
<span id="cb89-32"><a href="viewing-pairwise-sample-clustering.html#cb89-32" tabindex="-1"></a>sample_names <span class="ot">=</span> <span class="fu">names</span>(uncorrected_data)[<span class="dv">3</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">names</span>(uncorrected_data))]</span>
<span id="cb89-33"><a href="viewing-pairwise-sample-clustering.html#cb89-33" tabindex="-1"></a></span>
<span id="cb89-34"><a href="viewing-pairwise-sample-clustering.html#cb89-34" tabindex="-1"></a><span class="co">#review data structure</span></span>
<span id="cb89-35"><a href="viewing-pairwise-sample-clustering.html#cb89-35" tabindex="-1"></a><span class="fu">head</span>(uncorrected_data)</span>
<span id="cb89-36"><a href="viewing-pairwise-sample-clustering.html#cb89-36" tabindex="-1"></a><span class="fu">dim</span>(uncorrected_data)</span>
<span id="cb89-37"><a href="viewing-pairwise-sample-clustering.html#cb89-37" tabindex="-1"></a></span>
<span id="cb89-38"><a href="viewing-pairwise-sample-clustering.html#cb89-38" tabindex="-1"></a><span class="co">#define conditions, library methods, and replicates</span></span>
<span id="cb89-39"><a href="viewing-pairwise-sample-clustering.html#cb89-39" tabindex="-1"></a>conditions <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;HBR&quot;</span>, <span class="st">&quot;HBR&quot;</span>, <span class="st">&quot;HBR&quot;</span>, <span class="st">&quot;HBR&quot;</span>, <span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;UHR&quot;</span>, <span class="st">&quot;HBR&quot;</span>, <span class="st">&quot;HBR&quot;</span>, <span class="st">&quot;HBR&quot;</span>, <span class="st">&quot;HBR&quot;</span>)</span>
<span id="cb89-40"><a href="viewing-pairwise-sample-clustering.html#cb89-40" tabindex="-1"></a>library_methods <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Ribo&quot;</span>, <span class="st">&quot;Poly&quot;</span>, <span class="st">&quot;Poly&quot;</span>, <span class="st">&quot;Poly&quot;</span>, <span class="st">&quot;Poly&quot;</span>, <span class="st">&quot;Poly&quot;</span>, <span class="st">&quot;Poly&quot;</span>, <span class="st">&quot;Poly&quot;</span>, <span class="st">&quot;Poly&quot;</span>)</span>
<span id="cb89-41"><a href="viewing-pairwise-sample-clustering.html#cb89-41" tabindex="-1"></a>replicates <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb89-42"><a href="viewing-pairwise-sample-clustering.html#cb89-42" tabindex="-1"></a></span>
<span id="cb89-43"><a href="viewing-pairwise-sample-clustering.html#cb89-43" tabindex="-1"></a><span class="co">#calculate principal components for the uncorrected data</span></span>
<span id="cb89-44"><a href="viewing-pairwise-sample-clustering.html#cb89-44" tabindex="-1"></a>pca_uncorrected_obj <span class="ot">=</span> <span class="fu">prcomp</span>(uncorrected_data[,sample_names])</span>
<span id="cb89-45"><a href="viewing-pairwise-sample-clustering.html#cb89-45" tabindex="-1"></a></span>
<span id="cb89-46"><a href="viewing-pairwise-sample-clustering.html#cb89-46" tabindex="-1"></a><span class="co">#pull PCA values out of the PCA object</span></span>
<span id="cb89-47"><a href="viewing-pairwise-sample-clustering.html#cb89-47" tabindex="-1"></a>pca_uncorrected <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca_uncorrected_obj[<span class="dv">2</span>]<span class="sc">$</span>rotation)</span>
<span id="cb89-48"><a href="viewing-pairwise-sample-clustering.html#cb89-48" tabindex="-1"></a></span>
<span id="cb89-49"><a href="viewing-pairwise-sample-clustering.html#cb89-49" tabindex="-1"></a><span class="co">#assign labels to the data frame</span></span>
<span id="cb89-50"><a href="viewing-pairwise-sample-clustering.html#cb89-50" tabindex="-1"></a>pca_uncorrected[,<span class="st">&quot;condition&quot;</span>] <span class="ot">=</span> conditions</span>
<span id="cb89-51"><a href="viewing-pairwise-sample-clustering.html#cb89-51" tabindex="-1"></a>pca_uncorrected[,<span class="st">&quot;library_method&quot;</span>] <span class="ot">=</span> library_methods</span>
<span id="cb89-52"><a href="viewing-pairwise-sample-clustering.html#cb89-52" tabindex="-1"></a>pca_uncorrected[,<span class="st">&quot;replicate&quot;</span>] <span class="ot">=</span> replicates</span>
<span id="cb89-53"><a href="viewing-pairwise-sample-clustering.html#cb89-53" tabindex="-1"></a></span>
<span id="cb89-54"><a href="viewing-pairwise-sample-clustering.html#cb89-54" tabindex="-1"></a><span class="co">#plot the PCA</span></span>
<span id="cb89-55"><a href="viewing-pairwise-sample-clustering.html#cb89-55" tabindex="-1"></a><span class="co">#create a classic 2-dimension PCA plot (first two principal components) with conditions and library methods indicated</span></span>
<span id="cb89-56"><a href="viewing-pairwise-sample-clustering.html#cb89-56" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;UHR&quot;</span> <span class="ot">=</span> <span class="st">&quot;#481567FF&quot;</span>, <span class="st">&quot;HBR&quot;</span> <span class="ot">=</span> <span class="st">&quot;#1F968BFF&quot;</span>)</span>
<span id="cb89-57"><a href="viewing-pairwise-sample-clustering.html#cb89-57" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> pca_uncorrected, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> condition, <span class="at">shape =</span> library_method))</span>
<span id="cb89-58"><a href="viewing-pairwise-sample-clustering.html#cb89-58" tabindex="-1"></a>p1 <span class="ot">=</span> p1 <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>)</span>
<span id="cb89-59"><a href="viewing-pairwise-sample-clustering.html#cb89-59" tabindex="-1"></a>p1 <span class="ot">=</span> p1 <span class="sc">+</span> <span class="fu">stat_ellipse</span>(<span class="at">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="at">linetype =</span> <span class="dv">2</span>)</span>
<span id="cb89-60"><a href="viewing-pairwise-sample-clustering.html#cb89-60" tabindex="-1"></a>p1 <span class="ot">=</span> p1 <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;PCA, RNA-seq counts for 16 HBR/UHR and Ribo/PolyA samples (uncorrected data)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Condition&quot;</span>, <span class="at">shape=</span><span class="st">&quot;Library Method&quot;</span>)</span>
<span id="cb89-61"><a href="viewing-pairwise-sample-clustering.html#cb89-61" tabindex="-1"></a>p1 <span class="ot">=</span> p1 <span class="sc">+</span> <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cols)</span></code></pre></div>
</div>
<div id="introduction-to-bioconductor-sva-and-combat-seq-in-r" class="section level3 hasAnchor">
<h3>Introduction to Bioconductor SVA and ComBat-Seq in R<a href="viewing-pairwise-sample-clustering.html#introduction-to-bioconductor-sva-and-combat-seq-in-r" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The ComBat-Seq package is made available as part of the <a href="https://www.bioconductor.org/packages/release/bioc/html/sva.html">SVA package</a> for Surrogate Variable Analysis. This package is a collection of methods for removing batch effects and other unwanted variation in large datasets. It includes the ComBat method that has been widely used for batch correction of gene expression datasets, especially those generated on microarray platforms. ComBat-Seq is a modification of the ComBat approach. ComBat-Seq has been tailored to the count based data of bulk RNA-seq datasets. Particular advantages of the ComBat-Seq approach are that it: (1) uses a negative binomial regression model (the negative binomial distribution is thought to model the characteristics of bulk RNA-seq count data), and (2) allows the output of corrected data that retain the count nature of the data and can be safely fed into many existing methods for DE analysis (such as EdgeR and DESeq2).</p>
<p>ComBat-Seq has a relatively short list of arguments, and for several of these we will use the default setting. Very basic documentation of these arguments can be found <a href="https://rdrr.io/bioc/sva/man/ComBat_seq.html">here</a> and <a href="https://github.com/zhangyuqing/ComBat-seq">here</a>.</p>
<p>Our attempt to explain each of the ComBat-Seq arguments (for optional arguments, default is shown):</p>
<ul>
<li><code>counts</code>. This is your matrix of gene expression read counts (raw counts). Each row is a gene, each column is a sample, and each cell has an integer count for the number of RNA-seq counts observed for that gene/sample combination. In R we want this data to be passed into ComBat-Seq in matrix format (use <code>as.matrix()</code> if neccessary).</li>
<li><code>batch</code>. This is a vector describing the batches you are concerned about. For example, if you have eight samples that you created RNA-seq data for, but for the first four you used library kit (A) and for the last four samples you used library kit (B). In this situation you would define your <code>batch</code> vector as: <code>c(1,1,1,1,2,2,2,2)</code>.</li>
<li><code>group = NULL</code>. This is a vector describing your biological condition of interest. For example, if your experiment involved <em>pairs</em> of drug treated and untreated cells, and you did 4 biological replicates. You would define your <code>group</code> vector as: c(1,2,1,2,1,2,1,2).</li>
<li><code>covar_mod = NULL</code>. If you have multiple biological conditions of interest, you can define these with <code>covar_mod</code> (covariates) instead of <code>group</code>. For example, lets assume we have the same experiment as described above, except that we did four replicates (treated vs untreated pairs), but we alternated use of male and female cells for each of the replicates. You then would define a covariate matrix to supply to <code>covar_mod</code> as follows:</li>
</ul>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="viewing-pairwise-sample-clustering.html#cb90-1" tabindex="-1"></a>  <span class="co">#treatment_group = c(1,2,1,2,1,2,1,2)</span></span>
<span id="cb90-2"><a href="viewing-pairwise-sample-clustering.html#cb90-2" tabindex="-1"></a>  <span class="co">#sex_group = c(1,1,2,2,1,1,2,2)</span></span>
<span id="cb90-3"><a href="viewing-pairwise-sample-clustering.html#cb90-3" tabindex="-1"></a>  <span class="co">#covariate_matrix = cbind(treatment_group, sex_group)</span></span></code></pre></div>
<ul>
<li><code>full_mod = TRUE</code>. If TRUE include the condition of interest in model. Generally we believe this should be set to the default TRUE. We have yet to find a cohesive explanation for a situation where one would want this to be FALSE.</li>
<li><code>shrink = FALSE</code>. Whether to apply shrinkage on parameter estimation.<br />
</li>
<li><code>shrink.disp = FALSE</code>. Whether to apply shrinkage on dispersion.<br />
</li>
<li><code>gene.subset.n = NULL</code>. Number of genes to use in empirical Bayes estimation, only useful when shrink = TRUE.</li>
</ul>
<p>A detailed discussion of <em>shrinkage</em> (related to the <code>shrink</code>, <code>shrink.disp</code>, and <code>gene_subset.n</code> arguments is beyond the scope of this tutorial. Briefly, shrinkage refers to a set of methods that attempt to correct for gene-specific variability in the counts observed in RNA-seq datasets. More specifically, it relates to the <em>dispersion parameter</em> of the <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">negative binomial distribution</a> used to model RNA-seq count data that can suffer from <a href="https://en.wikipedia.org/wiki/Overdispersion">overdispersion</a>. The dispersion parameter describes how much variance deviates from the mean. In simple terms, shrinkage methods are an attempt to correct for problematic dispersion. A more detailed discussion of these statistical concepts can be found in the <a href="https://pubmed.ncbi.nlm.nih.gov/25516281/">DESeq2 paper</a>. However, for our purposes here, the bottom line is that the ComBat-Seq authors state that “We have shown that applying empirical Bayes shrinkage is not necessary for ComBat-seq because the approach is already sufficiently robust due to the distributional assumption.” So we will leave these arguments at their default <code>FALSE</code> settings.</p>
</div>
<div id="demonstration-of-combat-seq-on-the-uhrhbr-data-with-two-library-types-ribopoly" class="section level3 hasAnchor">
<h3>Demonstration of ComBat-Seq on the UHR/HBR data with two library types (Ribo/Poly)<a href="viewing-pairwise-sample-clustering.html#demonstration-of-combat-seq-on-the-uhrhbr-data-with-two-library-types-ribopoly" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Continuing the R session started above, use ComBat-Seq to perform batch correction as follows:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="viewing-pairwise-sample-clustering.html#cb91-1" tabindex="-1"></a></span>
<span id="cb91-2"><a href="viewing-pairwise-sample-clustering.html#cb91-2" tabindex="-1"></a><span class="co">#perform the batch correction</span></span>
<span id="cb91-3"><a href="viewing-pairwise-sample-clustering.html#cb91-3" tabindex="-1"></a></span>
<span id="cb91-4"><a href="viewing-pairwise-sample-clustering.html#cb91-4" tabindex="-1"></a><span class="co">#first we need to transform the format of our groups and batches from names (e.g. &quot;UHR&quot;, &quot;HBR&quot;, etc.) to numbers (e.g. 1, 2, etc.)</span></span>
<span id="cb91-5"><a href="viewing-pairwise-sample-clustering.html#cb91-5" tabindex="-1"></a><span class="co">#in the command below &quot;sapply&quot; is used to apply the &quot;switch&quot; command to each element and convert names to numbers as we define</span></span>
<span id="cb91-6"><a href="viewing-pairwise-sample-clustering.html#cb91-6" tabindex="-1"></a>groups <span class="ot">=</span> <span class="fu">sapply</span>(<span class="fu">as.character</span>(conditions), <span class="cf">switch</span>, <span class="st">&quot;UHR&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">&quot;HBR&quot;</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>)</span>
<span id="cb91-7"><a href="viewing-pairwise-sample-clustering.html#cb91-7" tabindex="-1"></a>batches <span class="ot">=</span> <span class="fu">sapply</span>(<span class="fu">as.character</span>(library_methods), <span class="cf">switch</span>, <span class="st">&quot;Ribo&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">&quot;Poly&quot;</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>)</span>
<span id="cb91-8"><a href="viewing-pairwise-sample-clustering.html#cb91-8" tabindex="-1"></a></span>
<span id="cb91-9"><a href="viewing-pairwise-sample-clustering.html#cb91-9" tabindex="-1"></a><span class="co">#now run ComBat_seq</span></span>
<span id="cb91-10"><a href="viewing-pairwise-sample-clustering.html#cb91-10" tabindex="-1"></a>corrected_data <span class="ot">=</span> <span class="fu">ComBat_seq</span>(<span class="at">counts =</span> <span class="fu">as.matrix</span>(uncorrected_data[,sample_names]), <span class="at">batch =</span> batches, <span class="at">group =</span> groups)</span>
<span id="cb91-11"><a href="viewing-pairwise-sample-clustering.html#cb91-11" tabindex="-1"></a></span>
<span id="cb91-12"><a href="viewing-pairwise-sample-clustering.html#cb91-12" tabindex="-1"></a><span class="co">#join the gene and chromosome names onto the now corrected counts from ComBat_seq</span></span>
<span id="cb91-13"><a href="viewing-pairwise-sample-clustering.html#cb91-13" tabindex="-1"></a>corrected_data <span class="ot">=</span> <span class="fu">cbind</span>(uncorrected_data[, <span class="fu">c</span>(<span class="st">&quot;Gene&quot;</span>, <span class="st">&quot;Chr&quot;</span>)], corrected_data)</span>
<span id="cb91-14"><a href="viewing-pairwise-sample-clustering.html#cb91-14" tabindex="-1"></a></span>
<span id="cb91-15"><a href="viewing-pairwise-sample-clustering.html#cb91-15" tabindex="-1"></a><span class="co">#compare dimensions of corrected and uncorrected data sets</span></span>
<span id="cb91-16"><a href="viewing-pairwise-sample-clustering.html#cb91-16" tabindex="-1"></a><span class="fu">dim</span>(uncorrected_data)</span>
<span id="cb91-17"><a href="viewing-pairwise-sample-clustering.html#cb91-17" tabindex="-1"></a><span class="fu">dim</span>(corrected_data)</span>
<span id="cb91-18"><a href="viewing-pairwise-sample-clustering.html#cb91-18" tabindex="-1"></a></span>
<span id="cb91-19"><a href="viewing-pairwise-sample-clustering.html#cb91-19" tabindex="-1"></a><span class="co">#visually compare values of corrected and uncorrected data sets</span></span>
<span id="cb91-20"><a href="viewing-pairwise-sample-clustering.html#cb91-20" tabindex="-1"></a><span class="fu">head</span>(uncorrected_data)</span>
<span id="cb91-21"><a href="viewing-pairwise-sample-clustering.html#cb91-21" tabindex="-1"></a><span class="fu">head</span>(corrected_data)</span></code></pre></div>
</div>
<div id="perform-pca-analysis-on-the-batch-corrected-data-and-contrast-with-the-uncorrected-data" class="section level3 hasAnchor">
<h3>Perform PCA analysis on the batch corrected data and contrast with the uncorrected data<a href="viewing-pairwise-sample-clustering.html#perform-pca-analysis-on-the-batch-corrected-data-and-contrast-with-the-uncorrected-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As performed above, use PCA to examine whether batch correction changes the grouping of samples by the expression patterns. Does the corrected data cluster according to biological condition (UHR vs HBR) better now regardless of library preparation type (Ribo vs PolyA)?</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="viewing-pairwise-sample-clustering.html#cb92-1" tabindex="-1"></a></span>
<span id="cb92-2"><a href="viewing-pairwise-sample-clustering.html#cb92-2" tabindex="-1"></a><span class="co">#calculate principal components for the uncorrected data</span></span>
<span id="cb92-3"><a href="viewing-pairwise-sample-clustering.html#cb92-3" tabindex="-1"></a>pca_corrected_obj <span class="ot">=</span> <span class="fu">prcomp</span>(corrected_data[, sample_names])</span>
<span id="cb92-4"><a href="viewing-pairwise-sample-clustering.html#cb92-4" tabindex="-1"></a></span>
<span id="cb92-5"><a href="viewing-pairwise-sample-clustering.html#cb92-5" tabindex="-1"></a><span class="co">#pull PCA values out of the PCA object</span></span>
<span id="cb92-6"><a href="viewing-pairwise-sample-clustering.html#cb92-6" tabindex="-1"></a>pca_corrected <span class="ot">=</span> <span class="fu">as.data.frame</span>(pca_corrected_obj[<span class="dv">2</span>]<span class="sc">$</span>rotation)</span>
<span id="cb92-7"><a href="viewing-pairwise-sample-clustering.html#cb92-7" tabindex="-1"></a></span>
<span id="cb92-8"><a href="viewing-pairwise-sample-clustering.html#cb92-8" tabindex="-1"></a><span class="co">#assign labels to the data frame</span></span>
<span id="cb92-9"><a href="viewing-pairwise-sample-clustering.html#cb92-9" tabindex="-1"></a>pca_corrected[,<span class="st">&quot;condition&quot;</span>] <span class="ot">=</span> conditions</span>
<span id="cb92-10"><a href="viewing-pairwise-sample-clustering.html#cb92-10" tabindex="-1"></a>pca_corrected[,<span class="st">&quot;library_method&quot;</span>] <span class="ot">=</span> library_methods</span>
<span id="cb92-11"><a href="viewing-pairwise-sample-clustering.html#cb92-11" tabindex="-1"></a>pca_corrected[,<span class="st">&quot;replicate&quot;</span>] <span class="ot">=</span> replicates</span>
<span id="cb92-12"><a href="viewing-pairwise-sample-clustering.html#cb92-12" tabindex="-1"></a></span>
<span id="cb92-13"><a href="viewing-pairwise-sample-clustering.html#cb92-13" tabindex="-1"></a><span class="co">#as above, create a PCA plot for comparison to the uncorrected data</span></span>
<span id="cb92-14"><a href="viewing-pairwise-sample-clustering.html#cb92-14" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;UHR&quot;</span> <span class="ot">=</span> <span class="st">&quot;#481567FF&quot;</span>, <span class="st">&quot;HBR&quot;</span> <span class="ot">=</span> <span class="st">&quot;#1F968BFF&quot;</span>)</span>
<span id="cb92-15"><a href="viewing-pairwise-sample-clustering.html#cb92-15" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> pca_corrected, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> condition, <span class="at">shape =</span> library_method))</span>
<span id="cb92-16"><a href="viewing-pairwise-sample-clustering.html#cb92-16" tabindex="-1"></a>p2 <span class="ot">=</span> p2 <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>)</span>
<span id="cb92-17"><a href="viewing-pairwise-sample-clustering.html#cb92-17" tabindex="-1"></a>p2 <span class="ot">=</span> p2 <span class="sc">+</span> <span class="fu">stat_ellipse</span>(<span class="at">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="at">linetype =</span> <span class="dv">2</span>)</span>
<span id="cb92-18"><a href="viewing-pairwise-sample-clustering.html#cb92-18" tabindex="-1"></a>p2 <span class="ot">=</span> p2 <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;PCA, RNA-seq counts for 16 HBR/UHR and Ribo/PolyA samples (batch corrected data)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Condition&quot;</span>, <span class="at">shape =</span> <span class="st">&quot;Library Method&quot;</span>)</span>
<span id="cb92-19"><a href="viewing-pairwise-sample-clustering.html#cb92-19" tabindex="-1"></a>p2 <span class="ot">=</span> p2 <span class="sc">+</span> <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cols)</span>
<span id="cb92-20"><a href="viewing-pairwise-sample-clustering.html#cb92-20" tabindex="-1"></a></span>
<span id="cb92-21"><a href="viewing-pairwise-sample-clustering.html#cb92-21" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;Uncorrected-vs-BatchCorrected-PCA.pdf&quot;</span>)</span>
<span id="cb92-22"><a href="viewing-pairwise-sample-clustering.html#cb92-22" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb92-23"><a href="viewing-pairwise-sample-clustering.html#cb92-23" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
<p>If the above analysis worked you should have an image that looks like this:
<img src="assets/module_3/Uncorrected-vs-BatchCorrected-PCA.png" alt="PCA-Plot" /></p>
<p>Note that prior to correction the UHR samples are separate from the HBR samples. Note that the PolyA and Ribo-reduction samples are also separated. The 16 samples group into 4 fairly distinct clusters. In other words, the overall expression signatures of these samples seem to reflect both the biological condition (UHR vs HBR) and library construction approach (Ribo vs PolyA).</p>
<p>However, after correcting for the batch effect of library construction approach, we see a marked improvement. The library construction approach still seems to be noticeable, but the 16 samples now essentially group into two distinct clusters: HBR and UHR.</p>
</div>
<div id="perform-differential-expression-analysis-of-the-corrected-and-uncorrected-data" class="section level3 hasAnchor">
<h3>Perform differential expression analysis of the corrected and uncorrected data<a href="viewing-pairwise-sample-clustering.html#perform-differential-expression-analysis-of-the-corrected-and-uncorrected-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>How does batch correction influence differential gene expression results? Use UpSet plots to examine the overlap of significant DE genes found for the following comparisons:</p>
<ul>
<li>UHR-Ribo vs HBR-Ribo (same library type, 4 vs 4 replicates)</li>
<li>UHR-Poly vs HBR-Poly (same library type, 4 vs 4 replicates)</li>
<li>UHR-Ribo vs HBR-Poly (different library types, 4 vs 4 replicates)</li>
<li>UHR-Poly vs HBR-Ribo (different library types, 4 vs 4 replicates)</li>
<li>UHR-Comb vs HBR-Comb (combined library types, 8 vs 8 replicates)</li>
</ul>
<p>These five differential expression analysis comparisons will be performed with both the uncorrected and corrected data.</p>
<ul>
<li>Does correction increase agreement between the five comparisons?</li>
<li>Does it appear to increase statistical power when combining all 8 replicates of UHR and HBR?</li>
<li>What do we expect to see for comparisons like UHR-Ribo vs HBR-Poly before and after batch correction? Do we expect correction to increase or decrease the number of significant results?</li>
</ul>
<p>Explore these questions by continuing on with the R session started above and doing the following:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="viewing-pairwise-sample-clustering.html#cb93-1" tabindex="-1"></a><span class="co">#perform differential expression analysis on the uncorrected data and batch corrected data sets</span></span>
<span id="cb93-2"><a href="viewing-pairwise-sample-clustering.html#cb93-2" tabindex="-1"></a></span>
<span id="cb93-3"><a href="viewing-pairwise-sample-clustering.html#cb93-3" tabindex="-1"></a><span class="co">#first define the sets of samples to be compared to each other</span></span>
<span id="cb93-4"><a href="viewing-pairwise-sample-clustering.html#cb93-4" tabindex="-1"></a>uhr_ribo_samples <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;UHR_Ribo_1&quot;</span>, <span class="st">&quot;UHR_Ribo_2&quot;</span>, <span class="st">&quot;UHR_Ribo_3&quot;</span>, <span class="st">&quot;UHR_Ribo_4&quot;</span>)</span>
<span id="cb93-5"><a href="viewing-pairwise-sample-clustering.html#cb93-5" tabindex="-1"></a>uhr_poly_samples <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;UHR_Poly_1&quot;</span>, <span class="st">&quot;UHR_Poly_2&quot;</span>, <span class="st">&quot;UHR_Poly_3&quot;</span>, <span class="st">&quot;UHR_Poly_4&quot;</span>)</span>
<span id="cb93-6"><a href="viewing-pairwise-sample-clustering.html#cb93-6" tabindex="-1"></a>hbr_ribo_samples <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;HBR_Ribo_1&quot;</span>, <span class="st">&quot;HBR_Ribo_2&quot;</span>, <span class="st">&quot;HBR_Ribo_3&quot;</span>, <span class="st">&quot;HBR_Ribo_4&quot;</span>)</span>
<span id="cb93-7"><a href="viewing-pairwise-sample-clustering.html#cb93-7" tabindex="-1"></a>hbr_poly_samples <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;HBR_Poly_1&quot;</span>, <span class="st">&quot;HBR_Poly_2&quot;</span>, <span class="st">&quot;HBR_Poly_3&quot;</span>, <span class="st">&quot;HBR_Poly_4&quot;</span>)</span>
<span id="cb93-8"><a href="viewing-pairwise-sample-clustering.html#cb93-8" tabindex="-1"></a>uhr_samples <span class="ot">=</span> <span class="fu">c</span>(uhr_ribo_samples, uhr_poly_samples)</span>
<span id="cb93-9"><a href="viewing-pairwise-sample-clustering.html#cb93-9" tabindex="-1"></a>hbr_samples <span class="ot">=</span> <span class="fu">c</span>(hbr_ribo_samples, hbr_poly_samples)</span>
<span id="cb93-10"><a href="viewing-pairwise-sample-clustering.html#cb93-10" tabindex="-1"></a></span>
<span id="cb93-11"><a href="viewing-pairwise-sample-clustering.html#cb93-11" tabindex="-1"></a><span class="co">#create a function that will run edgeR (DE analysis) for a particular pair of sample sets</span></span>
<span id="cb93-12"><a href="viewing-pairwise-sample-clustering.html#cb93-12" tabindex="-1"></a>run_edgeR <span class="ot">=</span> <span class="cf">function</span>(data, group_a_name, group_a_samples, group_b_samples, group_b_name){</span>
<span id="cb93-13"><a href="viewing-pairwise-sample-clustering.html#cb93-13" tabindex="-1"></a>  <span class="co">#create a list of all samples for this current comparison</span></span>
<span id="cb93-14"><a href="viewing-pairwise-sample-clustering.html#cb93-14" tabindex="-1"></a>  samples_for_comparison <span class="ot">=</span> <span class="fu">c</span>(group_a_samples, group_b_samples)</span>
<span id="cb93-15"><a href="viewing-pairwise-sample-clustering.html#cb93-15" tabindex="-1"></a>  </span>
<span id="cb93-16"><a href="viewing-pairwise-sample-clustering.html#cb93-16" tabindex="-1"></a>  <span class="co">#define the class factor for this pair of sample sets</span></span>
<span id="cb93-17"><a href="viewing-pairwise-sample-clustering.html#cb93-17" tabindex="-1"></a>  class <span class="ot">=</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="fu">rep</span>(group_a_name, <span class="fu">length</span>(group_a_samples)), <span class="fu">rep</span>(group_b_name, <span class="fu">length</span>(group_b_samples))))</span>
<span id="cb93-18"><a href="viewing-pairwise-sample-clustering.html#cb93-18" tabindex="-1"></a>  </span>
<span id="cb93-19"><a href="viewing-pairwise-sample-clustering.html#cb93-19" tabindex="-1"></a>  <span class="co">#create a simplified data matrix for only these samples</span></span>
<span id="cb93-20"><a href="viewing-pairwise-sample-clustering.html#cb93-20" tabindex="-1"></a>  rawdata <span class="ot">=</span> data[, samples_for_comparison]</span>
<span id="cb93-21"><a href="viewing-pairwise-sample-clustering.html#cb93-21" tabindex="-1"></a>  </span>
<span id="cb93-22"><a href="viewing-pairwise-sample-clustering.html#cb93-22" tabindex="-1"></a>  <span class="co">#store gene names for later</span></span>
<span id="cb93-23"><a href="viewing-pairwise-sample-clustering.html#cb93-23" tabindex="-1"></a>  genes <span class="ot">=</span> <span class="fu">rownames</span>(data)</span>
<span id="cb93-24"><a href="viewing-pairwise-sample-clustering.html#cb93-24" tabindex="-1"></a>  gene_names <span class="ot">=</span> data[,<span class="st">&quot;Gene&quot;</span>]</span>
<span id="cb93-25"><a href="viewing-pairwise-sample-clustering.html#cb93-25" tabindex="-1"></a>  </span>
<span id="cb93-26"><a href="viewing-pairwise-sample-clustering.html#cb93-26" tabindex="-1"></a>  <span class="co">#make DGElist object</span></span>
<span id="cb93-27"><a href="viewing-pairwise-sample-clustering.html#cb93-27" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">DGEList</span>(<span class="at">counts =</span> rawdata, <span class="at">genes =</span> genes, <span class="at">group =</span> class)</span>
<span id="cb93-28"><a href="viewing-pairwise-sample-clustering.html#cb93-28" tabindex="-1"></a>  </span>
<span id="cb93-29"><a href="viewing-pairwise-sample-clustering.html#cb93-29" tabindex="-1"></a>  <span class="co">#perform TMM normalization</span></span>
<span id="cb93-30"><a href="viewing-pairwise-sample-clustering.html#cb93-30" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">calcNormFactors</span>(y)</span>
<span id="cb93-31"><a href="viewing-pairwise-sample-clustering.html#cb93-31" tabindex="-1"></a>  </span>
<span id="cb93-32"><a href="viewing-pairwise-sample-clustering.html#cb93-32" tabindex="-1"></a>  <span class="co">#estimate dispersion</span></span>
<span id="cb93-33"><a href="viewing-pairwise-sample-clustering.html#cb93-33" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">estimateCommonDisp</span>(y, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb93-34"><a href="viewing-pairwise-sample-clustering.html#cb93-34" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">estimateTagwiseDisp</span>(y)</span>
<span id="cb93-35"><a href="viewing-pairwise-sample-clustering.html#cb93-35" tabindex="-1"></a>  </span>
<span id="cb93-36"><a href="viewing-pairwise-sample-clustering.html#cb93-36" tabindex="-1"></a>  <span class="co">#perform the differential expression test</span></span>
<span id="cb93-37"><a href="viewing-pairwise-sample-clustering.html#cb93-37" tabindex="-1"></a>  et <span class="ot">=</span> <span class="fu">exactTest</span>(y)</span>
<span id="cb93-38"><a href="viewing-pairwise-sample-clustering.html#cb93-38" tabindex="-1"></a>  </span>
<span id="cb93-39"><a href="viewing-pairwise-sample-clustering.html#cb93-39" tabindex="-1"></a>  <span class="co">#print number of up/down significant genes at FDR = 0.05 significance level and store the DE status in a new variable (de)</span></span>
<span id="cb93-40"><a href="viewing-pairwise-sample-clustering.html#cb93-40" tabindex="-1"></a>  de <span class="ot">=</span> <span class="fu">decideTests</span>(et, <span class="at">adjust.method =</span> <span class="st">&quot;fdr&quot;</span>, <span class="at">p =</span> <span class="fl">0.05</span>)</span>
<span id="cb93-41"><a href="viewing-pairwise-sample-clustering.html#cb93-41" tabindex="-1"></a>  <span class="fu">summary</span>(de)</span>
<span id="cb93-42"><a href="viewing-pairwise-sample-clustering.html#cb93-42" tabindex="-1"></a>  </span>
<span id="cb93-43"><a href="viewing-pairwise-sample-clustering.html#cb93-43" tabindex="-1"></a>  <span class="co">#create a matrix of the DE results</span></span>
<span id="cb93-44"><a href="viewing-pairwise-sample-clustering.html#cb93-44" tabindex="-1"></a>  mat <span class="ot">=</span> <span class="fu">cbind</span>(</span>
<span id="cb93-45"><a href="viewing-pairwise-sample-clustering.html#cb93-45" tabindex="-1"></a>    genes, </span>
<span id="cb93-46"><a href="viewing-pairwise-sample-clustering.html#cb93-46" tabindex="-1"></a>    gene_names,</span>
<span id="cb93-47"><a href="viewing-pairwise-sample-clustering.html#cb93-47" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">&quot;%0.3f&quot;</span>, <span class="fu">log10</span>(et<span class="sc">$</span>table<span class="sc">$</span>PValue)),</span>
<span id="cb93-48"><a href="viewing-pairwise-sample-clustering.html#cb93-48" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">&quot;%0.3f&quot;</span>, et<span class="sc">$</span>table<span class="sc">$</span>logFC)</span>
<span id="cb93-49"><a href="viewing-pairwise-sample-clustering.html#cb93-49" tabindex="-1"></a>  )</span>
<span id="cb93-50"><a href="viewing-pairwise-sample-clustering.html#cb93-50" tabindex="-1"></a></span>
<span id="cb93-51"><a href="viewing-pairwise-sample-clustering.html#cb93-51" tabindex="-1"></a>  <span class="co">#create a version of this matrix that is limited to only the *significant* results</span></span>
<span id="cb93-52"><a href="viewing-pairwise-sample-clustering.html#cb93-52" tabindex="-1"></a>  mat <span class="ot">=</span> mat[<span class="fu">as.logical</span>(de),]</span>
<span id="cb93-53"><a href="viewing-pairwise-sample-clustering.html#cb93-53" tabindex="-1"></a>  </span>
<span id="cb93-54"><a href="viewing-pairwise-sample-clustering.html#cb93-54" tabindex="-1"></a>  <span class="co">#add name to the columns of the final matrix</span></span>
<span id="cb93-55"><a href="viewing-pairwise-sample-clustering.html#cb93-55" tabindex="-1"></a>  <span class="fu">colnames</span>(mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Gene&quot;</span>, <span class="st">&quot;Gene_Name&quot;</span>, <span class="st">&quot;Log10_Pvalue&quot;</span>, <span class="st">&quot;Log_fold_change&quot;</span>)</span>
<span id="cb93-56"><a href="viewing-pairwise-sample-clustering.html#cb93-56" tabindex="-1"></a>  </span>
<span id="cb93-57"><a href="viewing-pairwise-sample-clustering.html#cb93-57" tabindex="-1"></a>  <span class="fu">return</span>(mat)</span>
<span id="cb93-58"><a href="viewing-pairwise-sample-clustering.html#cb93-58" tabindex="-1"></a>}</span>
<span id="cb93-59"><a href="viewing-pairwise-sample-clustering.html#cb93-59" tabindex="-1"></a></span>
<span id="cb93-60"><a href="viewing-pairwise-sample-clustering.html#cb93-60" tabindex="-1"></a><span class="co">#run the five comparisons through edgeR using the *uncorrected data*</span></span>
<span id="cb93-61"><a href="viewing-pairwise-sample-clustering.html#cb93-61" tabindex="-1"></a>uhr_ribo_vs_hbr_ribo_uncorrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> uncorrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_ribo_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_ribo_samples)</span>
<span id="cb93-62"><a href="viewing-pairwise-sample-clustering.html#cb93-62" tabindex="-1"></a>uhr_poly_vs_hbr_poly_uncorrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> uncorrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_poly_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_poly_samples)</span>
<span id="cb93-63"><a href="viewing-pairwise-sample-clustering.html#cb93-63" tabindex="-1"></a>uhr_ribo_vs_hbr_poly_uncorrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> uncorrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_ribo_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_poly_samples)</span>
<span id="cb93-64"><a href="viewing-pairwise-sample-clustering.html#cb93-64" tabindex="-1"></a>uhr_poly_vs_hbr_ribo_uncorrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> uncorrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_poly_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_ribo_samples)</span>
<span id="cb93-65"><a href="viewing-pairwise-sample-clustering.html#cb93-65" tabindex="-1"></a>uhr_vs_hbr_uncorrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> uncorrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_samples)</span>
<span id="cb93-66"><a href="viewing-pairwise-sample-clustering.html#cb93-66" tabindex="-1"></a></span>
<span id="cb93-67"><a href="viewing-pairwise-sample-clustering.html#cb93-67" tabindex="-1"></a><span class="co">#run the same five comparisons through edgeR using the *batch corrected data*</span></span>
<span id="cb93-68"><a href="viewing-pairwise-sample-clustering.html#cb93-68" tabindex="-1"></a>uhr_ribo_vs_hbr_ribo_corrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> corrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_ribo_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_ribo_samples)</span>
<span id="cb93-69"><a href="viewing-pairwise-sample-clustering.html#cb93-69" tabindex="-1"></a>uhr_poly_vs_hbr_poly_corrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> corrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_poly_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_poly_samples)</span>
<span id="cb93-70"><a href="viewing-pairwise-sample-clustering.html#cb93-70" tabindex="-1"></a>uhr_ribo_vs_hbr_poly_corrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> corrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_ribo_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_poly_samples)</span>
<span id="cb93-71"><a href="viewing-pairwise-sample-clustering.html#cb93-71" tabindex="-1"></a>uhr_poly_vs_hbr_ribo_corrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> corrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_poly_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_ribo_samples)</span>
<span id="cb93-72"><a href="viewing-pairwise-sample-clustering.html#cb93-72" tabindex="-1"></a>uhr_vs_hbr_corrected <span class="ot">=</span> <span class="fu">run_edgeR</span>(<span class="at">data =</span> corrected_data, <span class="at">group_a_name =</span> <span class="st">&quot;UHR&quot;</span>, <span class="at">group_a_samples =</span> uhr_samples, <span class="at">group_b_name =</span> <span class="st">&quot;HBR&quot;</span>, <span class="at">group_b_samples =</span> hbr_samples)</span>
<span id="cb93-73"><a href="viewing-pairwise-sample-clustering.html#cb93-73" tabindex="-1"></a></span>
<span id="cb93-74"><a href="viewing-pairwise-sample-clustering.html#cb93-74" tabindex="-1"></a><span class="co">#how much of a difference does batch correction make when doing the comparison of all UHR vs all HBR samples?</span></span>
<span id="cb93-75"><a href="viewing-pairwise-sample-clustering.html#cb93-75" tabindex="-1"></a><span class="fu">dim</span>(uhr_vs_hbr_uncorrected)</span>
<span id="cb93-76"><a href="viewing-pairwise-sample-clustering.html#cb93-76" tabindex="-1"></a><span class="fu">dim</span>(uhr_vs_hbr_corrected)</span>
<span id="cb93-77"><a href="viewing-pairwise-sample-clustering.html#cb93-77" tabindex="-1"></a></span>
<span id="cb93-78"><a href="viewing-pairwise-sample-clustering.html#cb93-78" tabindex="-1"></a><span class="co">#create upset plots to summarize the overlap between the comparisons performed above</span></span>
<span id="cb93-79"><a href="viewing-pairwise-sample-clustering.html#cb93-79" tabindex="-1"></a></span>
<span id="cb93-80"><a href="viewing-pairwise-sample-clustering.html#cb93-80" tabindex="-1"></a><span class="co">#first create upset plot from the *uncorrected* data</span></span>
<span id="cb93-81"><a href="viewing-pairwise-sample-clustering.html#cb93-81" tabindex="-1"></a>listInput1 <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&quot;4 UHR Ribo vs 4 HBR Ribo&quot;</span> <span class="ot">=</span> uhr_ribo_vs_hbr_ribo_uncorrected[, <span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-82"><a href="viewing-pairwise-sample-clustering.html#cb93-82" tabindex="-1"></a>                  <span class="st">&quot;4 UHR Poly vs 4HBR Poly&quot;</span> <span class="ot">=</span> uhr_poly_vs_hbr_poly_uncorrected[, <span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-83"><a href="viewing-pairwise-sample-clustering.html#cb93-83" tabindex="-1"></a>                  <span class="st">&quot;4 UHR Ribo vs 4 HBR Poly&quot;</span> <span class="ot">=</span> uhr_ribo_vs_hbr_poly_uncorrected[, <span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-84"><a href="viewing-pairwise-sample-clustering.html#cb93-84" tabindex="-1"></a>                  <span class="st">&quot;4 UHR Poly vs 4 HBR Ribo&quot;</span> <span class="ot">=</span> uhr_poly_vs_hbr_ribo_uncorrected[, <span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-85"><a href="viewing-pairwise-sample-clustering.html#cb93-85" tabindex="-1"></a>                  <span class="st">&quot;8 UHR vs 8 HBR&quot;</span> <span class="ot">=</span> uhr_vs_hbr_uncorrected[, <span class="st">&quot;Gene&quot;</span>])</span>
<span id="cb93-86"><a href="viewing-pairwise-sample-clustering.html#cb93-86" tabindex="-1"></a></span>
<span id="cb93-87"><a href="viewing-pairwise-sample-clustering.html#cb93-87" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;Uncorrected-UpSet.pdf&quot;</span>, <span class="at">onefile =</span> <span class="cn">FALSE</span>)</span>
<span id="cb93-88"><a href="viewing-pairwise-sample-clustering.html#cb93-88" tabindex="-1"></a><span class="fu">upset</span>(<span class="fu">fromList</span>(listInput1), <span class="at">order.by =</span> <span class="st">&quot;freq&quot;</span>, <span class="at">number.angles =</span> <span class="dv">45</span>, <span class="at">point.size =</span> <span class="dv">3</span>)</span>
<span id="cb93-89"><a href="viewing-pairwise-sample-clustering.html#cb93-89" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb93-90"><a href="viewing-pairwise-sample-clustering.html#cb93-90" tabindex="-1"></a></span>
<span id="cb93-91"><a href="viewing-pairwise-sample-clustering.html#cb93-91" tabindex="-1"></a><span class="co">#now create an upset plot from the *batch corrected* data</span></span>
<span id="cb93-92"><a href="viewing-pairwise-sample-clustering.html#cb93-92" tabindex="-1"></a>listInput2 <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&quot;4 UHR Ribo vs 4 HBR Ribo&quot;</span> <span class="ot">=</span> uhr_ribo_vs_hbr_ribo_corrected[,<span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-93"><a href="viewing-pairwise-sample-clustering.html#cb93-93" tabindex="-1"></a>                  <span class="st">&quot;4 UHR Poly vs 4 HBR Poly&quot;</span> <span class="ot">=</span> uhr_poly_vs_hbr_poly_corrected[,<span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-94"><a href="viewing-pairwise-sample-clustering.html#cb93-94" tabindex="-1"></a>                  <span class="st">&quot;4 UHR Ribo vs 4 HBR Poly&quot;</span> <span class="ot">=</span> uhr_ribo_vs_hbr_poly_corrected[,<span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-95"><a href="viewing-pairwise-sample-clustering.html#cb93-95" tabindex="-1"></a>                  <span class="st">&quot;4 UHR Poly vs 4 HBR Ribo&quot;</span> <span class="ot">=</span> uhr_poly_vs_hbr_ribo_corrected[,<span class="st">&quot;Gene&quot;</span>],</span>
<span id="cb93-96"><a href="viewing-pairwise-sample-clustering.html#cb93-96" tabindex="-1"></a>                  <span class="st">&quot;8 UHR vs 8 HBR&quot;</span> <span class="ot">=</span> uhr_vs_hbr_corrected[,<span class="st">&quot;Gene&quot;</span>])</span>
<span id="cb93-97"><a href="viewing-pairwise-sample-clustering.html#cb93-97" tabindex="-1"></a></span>
<span id="cb93-98"><a href="viewing-pairwise-sample-clustering.html#cb93-98" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;BatchCorrected-UpSet.pdf&quot;</span>, <span class="at">onefile =</span> <span class="cn">FALSE</span>)</span>
<span id="cb93-99"><a href="viewing-pairwise-sample-clustering.html#cb93-99" tabindex="-1"></a><span class="fu">upset</span>(<span class="fu">fromList</span>(listInput2), <span class="at">order.by =</span> <span class="st">&quot;freq&quot;</span>, <span class="at">number.angles=</span><span class="dv">45</span>, <span class="at">point.size=</span><span class="dv">3</span>)</span>
<span id="cb93-100"><a href="viewing-pairwise-sample-clustering.html#cb93-100" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb93-101"><a href="viewing-pairwise-sample-clustering.html#cb93-101" tabindex="-1"></a></span>
<span id="cb93-102"><a href="viewing-pairwise-sample-clustering.html#cb93-102" tabindex="-1"></a><span class="co">#write out the final set of DE genes where all UHR and HBR samples were compared using the corrected data</span></span>
<span id="cb93-103"><a href="viewing-pairwise-sample-clustering.html#cb93-103" tabindex="-1"></a><span class="fu">write.table</span>(uhr_vs_hbr_corrected, <span class="at">file =</span> <span class="st">&quot;DE_genes_uhr_vs_hbr_corrected.tsv&quot;</span>, <span class="at">quote =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb93-104"><a href="viewing-pairwise-sample-clustering.html#cb93-104" tabindex="-1"></a></span>
<span id="cb93-105"><a href="viewing-pairwise-sample-clustering.html#cb93-105" tabindex="-1"></a><span class="co">#To exit R type the following</span></span>
<span id="cb93-106"><a href="viewing-pairwise-sample-clustering.html#cb93-106" tabindex="-1"></a><span class="co">#quit(save = &quot;no&quot;)</span></span></code></pre></div>
<p>Note that an UpSet plot is an alternative to a Venn Diagram. It shows the overlap (intersection) between an arbitrary number of sets of values. In this case we are comparing the list of genes identified as significantly DE by five different comparisons. The black circles connected by a line indicate each combination of sets being considered. The bar graph above each column shows how many genes are shared across those sets. For example, the first column has all five black circles. The bar above that column indicates how many genes were found in all five DE comparisons performed.</p>
<p>What differs in each comparison is:</p>
<ul>
<li>whether we are comparing replicates prepared with the same library construction approach (Ribo reduction or PolyA) or whether we are comparing data prepared with different approaches</li>
<li>whether we are comparing 4 UHR vs 4 HBR replicates according to these library construction approaches, or pooling all 8 UHR and all 8 HBR samples (ignoring their different library types)</li>
<li>whether we are doing these comparisons before or after batch correction</li>
</ul>
<div id="before-batch-correction" class="section level4 hasAnchor">
<h4>Before batch correction<a href="viewing-pairwise-sample-clustering.html#before-batch-correction" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="float">
<img src="assets/module_3/Uncorrected-UpSet.png" alt="Uncorrected-UpSet" />
<div class="figcaption">Uncorrected-UpSet</div>
</div>
</div>
<div id="after-batch-correction" class="section level4 hasAnchor">
<h4>After batch correction<a href="viewing-pairwise-sample-clustering.html#after-batch-correction" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="float">
<img src="assets/module_3/BatchCorrected-UpSet.png" alt="BatchCorrected-UpSet" />
<div class="figcaption">BatchCorrected-UpSet</div>
</div>
<p>There are several notable observations from the analysis above and the two UpSet plots.</p>
<ul>
<li>In the uncorrected data, we actually see more DE genes when comparing a mix of library contruction approaches (e.g. UHR-Ribo vs UHR-Poly). There are likely false positives in these results. i.e. Genes that appear to be different between UHR and HBR, but where the difference is actually caused by differences in the library preparation not the biology.</li>
<li>If we combine all 8 samples together for each biological condition we can see that we actually get considerably <em>fewer</em> significant genes with the uncorrected data. Presumably this is because we are now introducing noise caused by a mix of different library construction approaches and this impacts the statistical analysis (more variability).</li>
<li>When we apply batch correction, we see that now all five comparisons tend to agree with each other for the most part on what genes are differentially expressed. Overall agreement across comparisons is improved.</li>
<li>With the batch corrected data we now see that combining all 8 samples actually improves statistical power and results in a <em>larger</em> number of significant DE genes relative to the 4 vs 4 comparisons. This is presumably the most accurate result of all the comparisons we did.</li>
</ul>
<p>In the <a href="/module-02-alignment/0002/07/01/Team_Assignment_Alignment/">previous Team Assignment</a>, teams have trimmed, aligned, visualized and performed QC evaluations of their RNAseq data. Using this aligned data, students will now apply the concepts they have learned regarding expression estimation and differential expression analysis. To complete this assignment, students will need to review commands we performed in earlier sections.</p>
<p>Before starting this team exercise, first find the folder containing your <strong>6</strong> aligned bam files (along with the index files). Note: In the previous exercise, you merged bams files for easy visualization in IGV, we will not be using that for expression and de analysis.</p>
</div>
</div>
<div id="part-i---expression-estimation" class="section level2 hasAnchor">
<h2>Part I - Expression Estimation<a href="viewing-pairwise-sample-clustering.html#part-i---expression-estimation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Goals:</strong></p>
<ul>
<li>Familiarize yourself with Stringtie options</li>
<li>Run Stringtie to obtain expression values</li>
<li>Optionally, run htseq-count to obtain raw count values</li>
</ul>
<div id="remember-to-do-this-in-a-new-directory-under-team_exercises" class="section level3 hasAnchor">
<h3>Remember to do this in a new directory under team_exercises<a href="viewing-pairwise-sample-clustering.html#remember-to-do-this-in-a-new-directory-under-team_exercises" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb94"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb94-1"><a href="viewing-pairwise-sample-clustering.html#cb94-1" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$RNA_HOME</span>/team_exercise/expression/</span>
<span id="cb94-2"><a href="viewing-pairwise-sample-clustering.html#cb94-2" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$RNA_HOME</span>/team_exercise/expression/</span></code></pre></div>
<p>Teams can now use <code>Stringtie</code> to estimate the gene expression levels in their sample and answer the following questions:</p>
<p><strong>Q1.</strong> Based on your stringtie results, what are the top 5 genes with highest average expression levels across all knockout samples? What about in your rescue samples? (Hint: You can use R, command-line tools, or download files to your desktop for this analysis)</p>
</div>
</div>
<div id="part-ii---differential-expression" class="section level2 hasAnchor">
<h2>Part II - Differential Expression<a href="viewing-pairwise-sample-clustering.html#part-ii---differential-expression" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Goals:</strong></p>
<ul>
<li>Perform differential analysis between the knockout and rescued samples</li>
<li>Check which genes are differentially expressed with statistical significance</li>
<li>Visualize DE results. For example you could create an MDS plot, x-y scatter plot of mean KO vs Rescue FPKM values, or a volcano plot.</li>
</ul>
<p>Teams will now use ballgown to perform differential expression analysis followed by visualization of their results. Alternatively, if raw counts were generated teams can use edgeR or DESeq2 for differential expression analysis.</p>
<p>Hint: You will should create a separate directory under your team_exercises folder for your ballgown (or edgeR or DESeq2) outputs.</p>
<p><strong>Q2.</strong> How many significant differentially expressed genes do you observe?</p>
<p><strong>Q3.</strong> By referring back to the supplementary tutorial in the DE Visualization Module, can you construct a volcano plot showcasing the significantly de genes?</p>
<p>Additionally, students should feel free to explore other visualization methods, including those they may have used in past research experiences and share with the class.</p>
</div>
<div id="presenting-your-results-1" class="section level2 hasAnchor">
<h2>Presenting Your Results<a href="viewing-pairwise-sample-clustering.html#presenting-your-results-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>At the end of this team exercise, students will show how they visualized their differential expression results to the class.</p>
<p><strong>Preamble:</strong> Note that the following integrated assignment asks you to work on new RNA-seq data and apply the concepts you have learned up to this point. To complete this assignment you will need to review commands we performed in many of the earlier sections. Try to construct these commands on your own and get all the way to the end of the assignment. If you get very stuck or would like to compare your solutions to those suggested by the instructors, refer to the answers page. The integrated assignment answers page is an expanded version of this page with all of the questions plus detailed code solutions to all problems. Avoid the temptation to look at it without trying on your own.</p>
<p><strong>Background:</strong> Cell lines are often used to study different experimental conditions and to study the function of specific genes by various perturbation approaches. One such type of study involves knocking down expression of a target of interest by shRNA and then using RNA-seq to measure the impact on gene expression. These eperiments often include use of a control shRNA to account for any expression changes that may occur from just the introduction of these molecules. Differential expression is performed by comparing biological replicates of shRNA knockdown vs shRNA control.</p>
<p><strong>Objectives:</strong> In this assignment, we will be using a subset of the <a href="https://www.ncbi.nlm.nih.gov/bioproject/PRJNA471072">GSE114360 dataset</a>, which consists of 6 RNA-seq datasets generated from a cell line (3 transfected with shRNA, and 3 controls). Our goal will be to determine differentially expressed genes.</p>
<p>Experimental information and other things to keep in mind:</p>
<ul>
<li>The libraries are prepared as paired end.</li>
<li>The samples are sequenced on an Illumina 4000.</li>
<li>Each read is 150 bp long</li>
<li>The dataset is located here: <a href="https://www.ncbi.nlm.nih.gov/bioproject/PRJNA471072">GSE114360</a></li>
<li>3 samples transfected with target shRNA and 3 samples with control shRNA</li>
<li>Libraries were prepared using standard Illumina protocols</li>
<li>For this exercise we will be using a subset of the reads (first 1,000,000 reads from each pair).</li>
<li>The files are named based on their SRR id’s, and obey the following key:
<ul>
<li>SRR7155055 = CBSLR knockdown sample 1 (T1 - aka transfected 1)</li>
<li>SRR7155056 = CBSLR knockdown sample 2 (T2 - aka transfected 2)</li>
<li>SRR7155057 = CBSLR knockdown sample 3 (T3 - aka transfected 3)</li>
<li>SRR7155058 = control sample 1 (C1 - aka control 1)</li>
<li>SRR7155059 = control sample 2 (C2 - aka control 2)</li>
<li>SRR7155060 = control sample 3 (C3 - aka control 3)</li>
</ul></li>
</ul>
<p>Experimental descriptions from the study authors:</p>
<p>Experimental details from the <a href="https://pubmed.ncbi.nlm.nih.gov/35499052/">paper</a>:
“An RNA transcriptome-sequencing analysis was performed in shRNA-NC or shRNA-CBSLR-1 MKN45 cells cultured under hypoxic conditions for 24 h (Fig. 2A).”</p>
<p>Experimental details from the GEO submission:
“An RNA transcriptome sequencing analysis was performed in MKN45 cells that were transfected with tcons_00001221 shRNA or control shRNA.”</p>
<p>Note that according to <a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene=CBSLR">GeneCards</a> and <a href="https://www.genenames.org/data/gene-symbol-report/#!/hgnc_id/55459">HGNC</a>, <em>CBSLR</em> and <em>tcons_00001221</em> refer to the same gene.</p>
</div>
<div id="part-0-obtaining-data-and-references" class="section level2 hasAnchor">
<h2>PART 0 : Obtaining Data and References<a href="viewing-pairwise-sample-clustering.html#part-0-obtaining-data-and-references" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Goals:</strong></p>
<ul>
<li>Obtain the files necessary for data processing</li>
<li>Familiarize yourself with reference and annotation file format</li>
<li>Familiarize yourself with sequence FASTQ format</li>
</ul>
<p>Create a working directory ~/workspace/rnaseq/integrated_assignment/ to store this exercise. Then create a unix environment variable named <code>RNA_INT_ASSIGNMENT</code> that stores this path for convenience in later commands.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb95-1"><a href="viewing-pairwise-sample-clustering.html#cb95-1" tabindex="-1"></a><span class="bu">export</span> <span class="va">RNA_HOME</span><span class="op">=</span>~/workspace/rnaseq</span>
<span id="cb95-2"><a href="viewing-pairwise-sample-clustering.html#cb95-2" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$RNA_HOME</span></span>
<span id="cb95-3"><a href="viewing-pairwise-sample-clustering.html#cb95-3" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/workspace/rnaseq/integrated_assignment/</span>
<span id="cb95-4"><a href="viewing-pairwise-sample-clustering.html#cb95-4" tabindex="-1"></a><span class="bu">export</span> <span class="va">RNA_INT_DIR</span><span class="op">=</span>~/workspace/rnaseq/integrated_assignment</span></code></pre></div>
<p>Obtain reference, annotation, adapter and data files and place them in the integrated assignment directory</p>
<p>Remember: when initiating an environment variable, we do NOT need the $; however, everytime we call the variable, it needs to be preceeded by a $.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb96-1"><a href="viewing-pairwise-sample-clustering.html#cb96-1" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$RNA_INT_DIR</span></span>
<span id="cb96-2"><a href="viewing-pairwise-sample-clustering.html#cb96-2" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$RNA_INT_DIR</span></span>
<span id="cb96-3"><a href="viewing-pairwise-sample-clustering.html#cb96-3" tabindex="-1"></a></span>
<span id="cb96-4"><a href="viewing-pairwise-sample-clustering.html#cb96-4" tabindex="-1"></a><span class="fu">wget</span> http://genomedata.org/rnaseq-tutorial/Integrated_Assignment_RNA_Data.tar.gz</span></code></pre></div>
<p><strong>Q1.)</strong> How many items are there under the “reference” directory (counting all files in all sub-directories)? What if this reference file was not provided for you - how would you obtain/create a reference genome fasta file. How about the GTF transcripts file from Ensembl?</p>
<p><strong>Q2.)</strong> How many exons does the gene SOX4 have? How about the longest isoform of PCA3?</p>
<p><strong>Q3.)</strong> How many samples do you see under the data directory?</p>
<p>NOTE: The fastq files you have copied above contain only the first 1,000,000 reads. Keep this in mind when you are combing through the results of the differential expression analysis.</p>
</div>
<div id="part-1-data-preprocessing" class="section level2 hasAnchor">
<h2>Part 1 : Data preprocessing<a href="viewing-pairwise-sample-clustering.html#part-1-data-preprocessing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Goals:</strong></p>
<ul>
<li>Run a quality check with <code>fastqc</code> before and after trimming</li>
<li>Familiarize yourself with the options for <code>fastqc</code> to be able to redirect your output</li>
<li>Perform adapter trimming and data cleanup on your data using <code>fastp</code></li>
<li>Familiarize yourself with the output metrics from adapter trimming</li>
<li>Examine <code>fastqc</code> and/or <code>multiqc</code> reports for the pre- and post-trimmed data</li>
</ul>
<p><strong>Q4.)</strong> What metrics, if any, have the samples failed? Are the errors related?</p>
<p><strong>Q5.)</strong> What average percentage of reads remain after adapter trimming? Why do reads get tossed out?</p>
<p><strong>Q6.)</strong> What sample has the largest number of reads after trimming/cleanup?</p>
</div>
<div id="part-2-data-alignment" class="section level2 hasAnchor">
<h2>Part 2: Data alignment<a href="viewing-pairwise-sample-clustering.html#part-2-data-alignment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Goals:</strong>
- Familiarize yourself with HISAT2 alignment options
- Perform alignments
- Obtain alignment summary
- Convert your alignment into compressed bam format</p>
<p><strong>Q7.)</strong> How would you obtain summary statistics for each aligned file?</p>
<p><strong>Q8.)</strong> Approximately how much space is saved by converting the sam to a bam format?</p>
<p>In order to make visualization easier, you should now merge each of your replicate sample bams into one combined BAM for each condition. Make sure to index these bams afterwards to be able to view them on IGV.</p>
<p>Try viewing genes such as TP53 to get a sense of how the data is aligned. To do this:
- Load up IGV
- Change the reference genome to “Human hg38” in the top-left category
- Click on File &gt; Load from URL, and in the File URL enter: “<a href="http://" class="uri">http://</a><your IP>/rnaseq/integrated_assignment/alignments/transfected.bam”. Repeat this step and enter “<a href="http://" class="uri">http://</a><your IP>/rnaseq/integrated_assignment/alignments/control.bam” to load the other bam.
- Right-click on the alignments track in the middle, and Group alignments by “Library”
- Jump to TP53 by typing it into the search bar above</p>
<p><strong>Q9.)</strong> What portion of the gene do the reads seem to be piling up on? What would be different if we were viewing whole-genome sequencing data?</p>
<p><strong>Q10.)</strong> What are the lines connecting the reads trying to convey?</p>
</div>
<div id="part-3-expression-estimation" class="section level2 hasAnchor">
<h2>Part 3: Expression Estimation<a href="viewing-pairwise-sample-clustering.html#part-3-expression-estimation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Goals:</strong></p>
<ul>
<li>Familiarize yourself with Stringtie options</li>
<li>Run Stringtie to obtain expression values</li>
<li>Obtain expression values for the gene SOX4</li>
<li>Create an expression results directory, run Stringtie on all samples, and store the results in appropriately named subdirectories in this results dir</li>
</ul>
<p><strong>Q11.)</strong> How can you obtain the expression of the gene SOX4 across the transfected and control samples?</p>
</div>
<div id="part-4-differential-expression-analysis" class="section level2 hasAnchor">
<h2>Part 4: Differential Expression Analysis<a href="viewing-pairwise-sample-clustering.html#part-4-differential-expression-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Goals:</strong></p>
<ul>
<li>Perform differential analysis between the transfected and control samples</li>
</ul>
<p>Adapt the R tutorial code that was used in <a href="https://rnabio.org/module-03-expression/0003/03/01/Differential_Expression/">Differential Expression</a> section. Modify it to work on these data (which are also a 3x3 replicate comparison of two conditions).</p>
<p><strong>Q12.)</strong> Are there any significant differentially expressed genes? How many in total do you see? If we expected SOX4 to be differentially expressed, why don’t we see it in this case?</p>
</div>
<div id="part-5-differential-expression-analysis-visualization" class="section level2 hasAnchor">
<h2>Part 5: Differential Expression Analysis Visualization<a href="viewing-pairwise-sample-clustering.html#part-5-differential-expression-analysis-visualization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Q13.)</strong> What plots can you generate to help you visualize this gene expression profile?</p>
<p>Hint, a volcano plot is popular approach to provide a high level summary of a differential expression analysis. Refer to the <a href="https://rnabio.org/module-03-expression/0003/04/01/DE_Visualization/">DE Visualization</a> section for example R code.</p>


</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="module-3.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/bioinformaticsdotca/RNA_2025/blob/main/030-module-3.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["_main.pdf", "_main.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
